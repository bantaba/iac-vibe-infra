{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "7060391349690658453"
    }
  },
  "definitions": {
    "_1.SubnetConfiguration": {
      "type": "object",
      "properties": {
        "applicationGateway": {
          "type": "string",
          "metadata": {
            "description": "Application Gateway subnet address prefix"
          }
        },
        "management": {
          "type": "string",
          "metadata": {
            "description": "Management subnet address prefix"
          }
        },
        "webTier": {
          "type": "string",
          "metadata": {
            "description": "Web tier subnet address prefix"
          }
        },
        "businessTier": {
          "type": "string",
          "metadata": {
            "description": "Business tier subnet address prefix"
          }
        },
        "dataTier": {
          "type": "string",
          "metadata": {
            "description": "Data tier subnet address prefix"
          }
        },
        "activeDirectory": {
          "type": "string",
          "metadata": {
            "description": "Active Directory subnet address prefix"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "modules/shared/parameter-schemas.bicep"
        }
      }
    },
    "EnvironmentConfig": {
      "type": "object",
      "properties": {
        "skuTier": {
          "type": "string",
          "allowedValues": [
            "Basic",
            "Premium",
            "Standard"
          ],
          "metadata": {
            "description": "Service tier for the environment (Basic, Standard, Premium)"
          }
        },
        "instanceCount": {
          "type": "int",
          "metadata": {
            "description": "Default instance count for scalable resources"
          }
        },
        "enableHighAvailability": {
          "type": "bool",
          "metadata": {
            "description": "Enable high availability features"
          }
        },
        "enableDdosProtection": {
          "type": "bool",
          "metadata": {
            "description": "Enable DDoS protection"
          }
        },
        "sqlDatabaseSku": {
          "type": "string",
          "allowedValues": [
            "BC_Gen5_2",
            "BC_Gen5_4",
            "Basic",
            "GP_Gen5_2",
            "GP_Gen5_4",
            "P1",
            "P2",
            "P4",
            "P6",
            "S0",
            "S1",
            "S2",
            "S3"
          ],
          "metadata": {
            "description": "SQL Database SKU"
          }
        },
        "storageAccountSku": {
          "type": "string",
          "allowedValues": [
            "Premium_LRS",
            "Premium_ZRS",
            "Standard_GRS",
            "Standard_LRS",
            "Standard_ZRS"
          ],
          "metadata": {
            "description": "Storage Account SKU"
          }
        },
        "applicationGatewaySku": {
          "type": "string",
          "allowedValues": [
            "Standard_v2",
            "WAF_v2"
          ],
          "metadata": {
            "description": "Application Gateway SKU"
          }
        },
        "applicationGatewayCapacity": {
          "type": "int",
          "minValue": 1,
          "maxValue": 125,
          "metadata": {
            "description": "Application Gateway capacity"
          }
        },
        "virtualMachineSize": {
          "type": "string",
          "metadata": {
            "description": "Virtual Machine size"
          }
        },
        "enableBackup": {
          "type": "bool",
          "metadata": {
            "description": "Enable backup for resources"
          }
        },
        "logRetentionDays": {
          "type": "int",
          "minValue": 30,
          "maxValue": 730,
          "metadata": {
            "description": "Log retention period in days"
          }
        },
        "enablePrivateEndpoints": {
          "type": "bool",
          "metadata": {
            "description": "Enable private endpoints for data services"
          }
        },
        "networkAddressSpace": {
          "type": "string",
          "metadata": {
            "description": "Network address space for the virtual network"
          }
        },
        "subnets": {
          "$ref": "#/definitions/_1.SubnetConfiguration",
          "metadata": {
            "description": "Subnet configuration"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "modules/shared/parameter-schemas.bicep"
        }
      }
    },
    "TagConfiguration": {
      "type": "object",
      "properties": {
        "Environment": {
          "type": "string",
          "metadata": {
            "description": "Environment tag"
          }
        },
        "Workload": {
          "type": "string",
          "metadata": {
            "description": "Workload tag"
          }
        },
        "ManagedBy": {
          "type": "string",
          "metadata": {
            "description": "Managed by tag"
          }
        },
        "CostCenter": {
          "type": "string",
          "metadata": {
            "description": "Cost center tag"
          }
        },
        "Owner": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Owner tag"
          }
        },
        "Project": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Project tag"
          }
        },
        "DeploymentDate": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Deployment date tag"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "modules/shared/parameter-schemas.bicep"
        }
      }
    }
  },
  "parameters": {
    "resourcePrefix": {
      "type": "string",
      "metadata": {
        "description": "The prefix for all resource names"
      }
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "The environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The Azure region for deployment"
      }
    },
    "workloadName": {
      "type": "string",
      "metadata": {
        "description": "The workload or application name"
      }
    },
    "tags": {
      "$ref": "#/definitions/TagConfiguration",
      "defaultValue": {
        "Environment": "[parameters('environment')]",
        "Workload": "[parameters('workloadName')]",
        "ManagedBy": "Bicep",
        "CostCenter": "IT",
        "Owner": "DevOps-Team",
        "Project": "Azure-Bicep-Infrastructure",
        "DeploymentDate": "[utcNow('yyyy-MM-dd')]"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "environmentConfig": {
      "$ref": "#/definitions/EnvironmentConfig",
      "metadata": {
        "description": "Environment-specific configuration settings"
      }
    }
  },
  "resources": {
    "namingConventions": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "naming-conventions",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[parameters('resourcePrefix')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "workloadName": {
            "value": "[parameters('workloadName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17916838294149264941"
            }
          },
          "functions": [
            {
              "namespace": "__bicep",
              "members": {
                "validateNameLength": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "name"
                    },
                    {
                      "type": "string",
                      "name": "resourceType"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[if(lessOrEquals(length(parameters('name')), variables('namingLimits')[parameters('resourceType')]), parameters('name'), take(parameters('name'), variables('namingLimits')[parameters('resourceType')]))]"
                  }
                },
                "getSubnetName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "subnetType"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').subnet, '{subnetType}', parameters('subnetType')), 'subnet')]"
                  }
                },
                "getNsgName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "subnetType"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').networkSecurityGroup, '{subnetType}', parameters('subnetType')), 'networkSecurityGroup')]"
                  }
                },
                "getLoadBalancerName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "tier"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').loadBalancer, '{tier}', parameters('tier')), 'loadBalancer')]"
                  }
                },
                "getVmName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "tier"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').virtualMachine, '{tier}', parameters('tier')), 'virtualMachine')]"
                  }
                },
                "getVmssName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "tier"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').virtualMachineScaleSet, '{tier}', parameters('tier')), 'virtualMachine')]"
                  }
                },
                "getManagedIdentityName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "purpose"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').managedIdentity, '{purpose}', parameters('purpose')), 'virtualNetwork')]"
                  }
                },
                "getPrivateEndpointName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "serviceName"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').privateEndpoint, '{serviceName}', parameters('serviceName')), 'virtualNetwork')]"
                  }
                },
                "getNetworkGroupName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "groupType"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').networkGroup, '{groupType}', parameters('groupType')), 'virtualNetwork')]"
                  }
                },
                "getKeyVaultName": {
                  "parameters": [],
                  "output": {
                    "type": "string",
                    "value": "[variables('namingConvention').keyVault]"
                  }
                },
                "getStorageAccountName": {
                  "parameters": [],
                  "output": {
                    "type": "string",
                    "value": "[variables('namingConvention').storageAccount]"
                  }
                },
                "getSqlDatabaseName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "dbName"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').sqlDatabase, '{dbName}', parameters('dbName')), 'sqlServer')]"
                  }
                },
                "getActionGroupName": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "alertType"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[__bicep.validateNameLength(replace(variables('namingConvention').actionGroup, '{alertType}', parameters('alertType')), 'virtualNetwork')]"
                  }
                }
              }
            }
          ],
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "minLength": 2,
              "maxLength": 10,
              "metadata": {
                "description": "The prefix for all resource names"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod"
              ],
              "metadata": {
                "description": "The environment name (dev, staging, prod)"
              }
            },
            "workloadName": {
              "type": "string",
              "minLength": 2,
              "maxLength": 15,
              "metadata": {
                "description": "The workload or application name"
              }
            },
            "suffix": {
              "type": "string",
              "defaultValue": "",
              "maxLength": 5,
              "metadata": {
                "description": "Optional suffix for resource differentiation"
              }
            }
          },
          "variables": {
            "namingLimits": {
              "resourceGroup": 90,
              "virtualNetwork": 64,
              "subnet": 80,
              "networkSecurityGroup": 80,
              "applicationGateway": 80,
              "loadBalancer": 80,
              "keyVault": 24,
              "storageAccount": 24,
              "sqlServer": 63,
              "virtualMachine": 64,
              "logAnalyticsWorkspace": 63
            },
            "namingConvention": {
              "resourceGroup": "[format('{0}-{1}-{2}-rg{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "virtualNetwork": "[format('{0}-{1}-{2}-vnet{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "subnet": "[format('{0}-{1}-{2}-{{subnetType}}-snet{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "networkSecurityGroup": "[format('{0}-{1}-{2}-{{subnetType}}-nsg{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "routeTable": "[format('{0}-{1}-{2}-{{subnetType}}-rt{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "publicIp": "[format('{0}-{1}-{2}-{{purpose}}-pip{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "networkInterface": "[format('{0}-{1}-{2}-{{vmName}}-nic{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "virtualNetworkGateway": "[format('{0}-{1}-{2}-vgw{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "localNetworkGateway": "[format('{0}-{1}-{2}-lgw{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "virtualNetworkManager": "[format('{0}-{1}-{2}-vnm{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "networkGroup": "[format('{0}-{1}-{2}-{{groupType}}-ng{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "ddosProtectionPlan": "[format('{0}-{1}-{2}-ddos{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "applicationGateway": "[format('{0}-{1}-{2}-agw{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "loadBalancer": "[format('{0}-{1}-{2}-{{tier}}-lb{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "keyVault": "[take(format('{0}{1}{2}kv{3}', toLower(parameters('resourcePrefix')), toLower(parameters('workloadName')), toLower(parameters('environment')), toLower(parameters('suffix'))), 24)]",
              "managedIdentity": "[format('{0}-{1}-{2}-{{purpose}}-mi{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "virtualMachine": "[format('{0}-{1}-{2}-{{tier}}-vm{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "virtualMachineScaleSet": "[format('{0}-{1}-{2}-{{tier}}-vmss{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "availabilitySet": "[format('{0}-{1}-{2}-{{tier}}-as{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "storageAccount": "[take(format('{0}{1}{2}sa{3}', toLower(parameters('resourcePrefix')), toLower(parameters('workloadName')), toLower(parameters('environment')), toLower(parameters('suffix'))), 24)]",
              "sqlServer": "[format('{0}-{1}-{2}-sql{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "sqlDatabase": "[format('{0}-{1}-{2}-{{dbName}}-sqldb{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "logAnalyticsWorkspace": "[format('{0}-{1}-{2}-law{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "applicationInsights": "[format('{0}-{1}-{2}-ai{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "actionGroup": "[format('{0}-{1}-{2}-{{alertType}}-ag{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "privateEndpoint": "[format('{0}-{1}-{2}-{{serviceName}}-pe{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]",
              "privateDnsZone": "[format('{0}-{1}-{2}-{{serviceName}}-pdz{3}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'), parameters('suffix'))]"
            }
          },
          "resources": {},
          "outputs": {
            "namingConvention": {
              "type": "object",
              "value": "[variables('namingConvention')]"
            },
            "subnetNames": {
              "type": "object",
              "value": {
                "applicationGateway": "[__bicep.getSubnetName('agw')]",
                "management": "[__bicep.getSubnetName('mgmt')]",
                "webTier": "[__bicep.getSubnetName('web')]",
                "businessTier": "[__bicep.getSubnetName('biz')]",
                "dataTier": "[__bicep.getSubnetName('data')]",
                "activeDirectory": "[__bicep.getSubnetName('ad')]"
              }
            },
            "nsgNames": {
              "type": "object",
              "value": {
                "applicationGateway": "[__bicep.getNsgName('agw')]",
                "management": "[__bicep.getNsgName('mgmt')]",
                "webTier": "[__bicep.getNsgName('web')]",
                "businessTier": "[__bicep.getNsgName('biz')]",
                "dataTier": "[__bicep.getNsgName('data')]",
                "activeDirectory": "[__bicep.getNsgName('ad')]"
              }
            },
            "loadBalancerNames": {
              "type": "object",
              "value": {
                "web": "[__bicep.getLoadBalancerName('web')]",
                "business": "[__bicep.getLoadBalancerName('biz')]",
                "data": "[__bicep.getLoadBalancerName('data')]"
              }
            },
            "specializedNames": {
              "type": "object",
              "value": {
                "keyVault": "[__bicep.getKeyVaultName()]",
                "storageAccount": "[__bicep.getStorageAccountName()]"
              }
            }
          }
        }
      }
    },
    "commonVariables": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "common-variables",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17792367466298546205"
            }
          },
          "variables": {
            "regionMappings": {
              "East US": "eastus",
              "East US 2": "eastus2",
              "West US": "westus",
              "West US 2": "westus2",
              "West US 3": "westus3",
              "Central US": "centralus",
              "North Central US": "northcentralus",
              "South Central US": "southcentralus",
              "West Central US": "westcentralus",
              "Canada Central": "canadacentral",
              "Canada East": "canadaeast",
              "Brazil South": "brazilsouth",
              "North Europe": "northeurope",
              "West Europe": "westeurope",
              "UK South": "uksouth",
              "UK West": "ukwest",
              "France Central": "francecentral",
              "Germany West Central": "germanywestcentral",
              "Switzerland North": "switzerlandnorth",
              "Norway East": "norwayeast",
              "Southeast Asia": "southeastasia",
              "East Asia": "eastasia",
              "Australia East": "australiaeast",
              "Australia Southeast": "australiasoutheast",
              "Japan East": "japaneast",
              "Japan West": "japanwest",
              "Korea Central": "koreacentral",
              "India Central": "centralindia",
              "India South": "southindia",
              "UAE North": "uaenorth",
              "South Africa North": "southafricanorth"
            },
            "commonPorts": {
              "http": 80,
              "https": 443,
              "ssh": 22,
              "rdp": 3389,
              "sql": 1433,
              "mysql": 3306,
              "postgresql": 5432,
              "redis": 6379,
              "mongodb": 27017,
              "smtp": 25,
              "smtps": 465,
              "pop3": 110,
              "pop3s": 995,
              "imap": 143,
              "imaps": 993,
              "ftp": 21,
              "ftps": 990,
              "sftp": 22,
              "dns": 53,
              "dhcp": 67,
              "ntp": 123,
              "snmp": 161,
              "ldap": 389,
              "ldaps": 636,
              "kerberos": 88,
              "winrm": 5985,
              "winrms": 5986
            },
            "nsgRulePriorities": {
              "allowApplicationGateway": 100,
              "allowLoadBalancer": 110,
              "allowVnetTraffic": 120,
              "allowManagementAccess": 130,
              "allowMonitoring": 140,
              "denyAllInbound": 4000,
              "allowInternetAccess": 1000,
              "allowVnetOutbound": 1010,
              "allowStorageAccess": 1020,
              "allowKeyVaultAccess": 1030,
              "allowSqlAccess": 1040,
              "denyAllOutbound": 4000
            },
            "applicationGatewayDefaults": {
              "requestTimeout": 20,
              "cookieBasedAffinity": "Disabled",
              "protocol": "Https",
              "port": 443,
              "healthProbe": {
                "interval": 30,
                "timeout": 30,
                "unhealthyThreshold": 3,
                "path": "/health",
                "statusCodes": [
                  "200-399"
                ]
              },
              "wafMode": "Prevention",
              "wafRuleSetType": "OWASP",
              "wafRuleSetVersion": "3.2"
            },
            "loadBalancerDefaults": {
              "idleTimeoutInMinutes": 4,
              "enableFloatingIp": false,
              "loadDistribution": "Default",
              "healthProbe": {
                "intervalInSeconds": 15,
                "numberOfProbes": 2,
                "port": 80,
                "protocol": "Http",
                "requestPath": "/health"
              }
            },
            "keyVaultDefaults": {
              "sku": "standard",
              "enableSoftDelete": true,
              "softDeleteRetentionInDays": 90,
              "enablePurgeProtection": true,
              "enableRbacAuthorization": true,
              "networkAcls": {
                "bypass": "AzureServices",
                "defaultAction": "Deny"
              }
            },
            "storageAccountDefaults": {
              "kind": "StorageV2",
              "accessTier": "Hot",
              "supportsHttpsTrafficOnly": true,
              "minimumTlsVersion": "TLS1_2",
              "allowBlobPublicAccess": false,
              "allowSharedKeyAccess": false,
              "networkAcls": {
                "bypass": "AzureServices",
                "defaultAction": "Deny"
              }
            },
            "sqlDatabaseDefaults": {
              "collation": "SQL_Latin1_General_CP1_CI_AS",
              "maxSizeBytes": 268435456000,
              "zoneRedundant": false,
              "readScale": "Disabled",
              "minCapacity": 1,
              "autoPauseDelay": 60,
              "enableAdvancedDataSecurity": true,
              "enableVulnerabilityAssessment": true,
              "enableAuditing": true
            },
            "virtualMachineDefaults": {
              "osDisk": {
                "storageAccountType": "Premium_LRS",
                "diskSizeGB": 128,
                "caching": "ReadWrite"
              },
              "networkInterface": {
                "enableAcceleratedNetworking": true,
                "enableIpForwarding": false
              },
              "bootDiagnostics": {
                "enabled": true
              }
            },
            "logAnalyticsDefaults": {
              "sku": "PerGB2018",
              "retentionInDays": 30,
              "dailyQuotaGb": 1,
              "enableLogAccessUsingOnlyResourcePermissions": true
            },
            "monitoringDefaults": {
              "metricAlerts": {
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "severity": 2,
                "autoMitigate": true
              },
              "actionGroups": {
                "emailReceiver": {
                  "useCommonAlertSchema": true
                },
                "smsReceiver": {
                  "countryCode": "1"
                }
              }
            },
            "privateEndpointDefaults": {
              "privateDnsZoneGroups": {
                "sql": "privatelink.database.windows.net",
                "storage": "privatelink.blob.core.windows.net",
                "keyVault": "privatelink.vaultcore.azure.net",
                "monitor": "privatelink.monitor.azure.com",
                "oms": "privatelink.oms.opinsights.azure.com",
                "ods": "privatelink.ods.opinsights.azure.com",
                "agentsvc": "privatelink.agentsvc.azure-automation.net"
              }
            }
          },
          "resources": [],
          "outputs": {
            "regionMappings": {
              "type": "object",
              "value": "[variables('regionMappings')]"
            },
            "commonPorts": {
              "type": "object",
              "value": "[variables('commonPorts')]"
            },
            "nsgRulePriorities": {
              "type": "object",
              "value": "[variables('nsgRulePriorities')]"
            },
            "applicationGatewayDefaults": {
              "type": "object",
              "value": "[variables('applicationGatewayDefaults')]"
            },
            "loadBalancerDefaults": {
              "type": "object",
              "value": "[variables('loadBalancerDefaults')]"
            },
            "keyVaultDefaults": {
              "type": "object",
              "value": "[variables('keyVaultDefaults')]"
            },
            "storageAccountDefaults": {
              "type": "object",
              "value": "[variables('storageAccountDefaults')]"
            },
            "sqlDatabaseDefaults": {
              "type": "object",
              "value": "[variables('sqlDatabaseDefaults')]"
            },
            "virtualMachineDefaults": {
              "type": "object",
              "value": "[variables('virtualMachineDefaults')]"
            },
            "logAnalyticsDefaults": {
              "type": "object",
              "value": "[variables('logAnalyticsDefaults')]"
            },
            "monitoringDefaults": {
              "type": "object",
              "value": "[variables('monitoringDefaults')]"
            },
            "privateEndpointDefaults": {
              "type": "object",
              "value": "[variables('privateEndpointDefaults')]"
            }
          }
        }
      }
    },
    "ddosProtection": {
      "condition": "[parameters('environmentConfig').enableDdosProtection]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ddos-protection-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "ddosProtectionPlanName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.ddosProtectionPlan]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "enableDdosProtection": {
            "value": "[parameters('environmentConfig').enableDdosProtection]"
          },
          "enableTelemetry": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17180414613575447812"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "ddosProtectionPlanName": {
              "type": "string",
              "metadata": {
                "description": "The name of the DDoS protection plan"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the DDoS protection plan"
              }
            },
            "enableDdosProtection": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable DDoS protection plan"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for DDoS monitoring"
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable DDoS protection telemetry"
              }
            }
          },
          "resources": {
            "ddosProtectionPlan": {
              "condition": "[parameters('enableDdosProtection')]",
              "type": "Microsoft.Network/ddosProtectionPlans",
              "apiVersion": "2023-09-01",
              "name": "[parameters('ddosProtectionPlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {}
            },
            "ddosProtectionPlanDiagnostics": {
              "condition": "[and(parameters('enableDdosProtection'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Network/ddosProtectionPlans/{0}', parameters('ddosProtectionPlanName'))]",
              "name": "[format('{0}-diagnostics', parameters('ddosProtectionPlanName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": true,
                      "days": 30
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": true,
                      "days": 30
                    }
                  }
                ]
              },
              "dependsOn": [
                "ddosProtectionPlan"
              ]
            }
          },
          "outputs": {
            "ddosProtectionPlanId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the DDoS protection plan"
              },
              "value": "[if(parameters('enableDdosProtection'), resourceId('Microsoft.Network/ddosProtectionPlans', parameters('ddosProtectionPlanName')), '')]"
            },
            "ddosProtectionPlanName": {
              "type": "string",
              "metadata": {
                "description": "The name of the DDoS protection plan"
              },
              "value": "[if(parameters('enableDdosProtection'), parameters('ddosProtectionPlanName'), '')]"
            },
            "ddosProtectionPolicyId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the DDoS protection policy"
              },
              "value": ""
            },
            "ddosProtectionConfig": {
              "type": "object",
              "metadata": {
                "description": "DDoS protection configuration for virtual networks"
              },
              "value": "[if(parameters('enableDdosProtection'), createObject('id', resourceId('Microsoft.Network/ddosProtectionPlans', parameters('ddosProtectionPlanName')), 'enabled', true()), createObject('id', '', 'enabled', false()))]"
            },
            "monitoringConfig": {
              "type": "object",
              "metadata": {
                "description": "DDoS protection monitoring configuration"
              },
              "value": {
                "ddosProtectionPlanId": "[if(parameters('enableDdosProtection'), resourceId('Microsoft.Network/ddosProtectionPlans', parameters('ddosProtectionPlanName')), '')]",
                "logAnalyticsWorkspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "telemetryEnabled": "[parameters('enableTelemetry')]",
                "diagnosticsEnabled": "[not(empty(parameters('logAnalyticsWorkspaceId')))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions"
      ]
    },
    "networkSecurityGroups": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network-security-groups-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsgNamePrefix": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.networkSecurityGroup]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetAddressSpace": {
            "value": "[parameters('environmentConfig').networkAddressSpace]"
          },
          "applicationGatewaySubnet": {
            "value": "[parameters('environmentConfig').subnets.applicationGateway]"
          },
          "managementSubnet": {
            "value": "[parameters('environmentConfig').subnets.management]"
          },
          "webTierSubnet": {
            "value": "[parameters('environmentConfig').subnets.webTier]"
          },
          "businessTierSubnet": {
            "value": "[parameters('environmentConfig').subnets.businessTier]"
          },
          "dataTierSubnet": {
            "value": "[parameters('environmentConfig').subnets.dataTier]"
          },
          "activeDirectorySubnet": {
            "value": "[parameters('environmentConfig').subnets.activeDirectory]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "4419443780421057610"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "nsgNamePrefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for NSG names"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the NSGs"
              }
            },
            "vnetAddressSpace": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "Virtual network address space for internal traffic rules"
              }
            },
            "applicationGatewaySubnet": {
              "type": "string",
              "defaultValue": "10.0.1.0/24",
              "metadata": {
                "description": "Application Gateway subnet address prefix"
              }
            },
            "managementSubnet": {
              "type": "string",
              "defaultValue": "10.0.2.0/24",
              "metadata": {
                "description": "Management subnet address prefix"
              }
            },
            "webTierSubnet": {
              "type": "string",
              "defaultValue": "10.0.3.0/24",
              "metadata": {
                "description": "Web tier subnet address prefix"
              }
            },
            "businessTierSubnet": {
              "type": "string",
              "defaultValue": "10.0.4.0/24",
              "metadata": {
                "description": "Business tier subnet address prefix"
              }
            },
            "dataTierSubnet": {
              "type": "string",
              "defaultValue": "10.0.5.0/24",
              "metadata": {
                "description": "Data tier subnet address prefix"
              }
            },
            "activeDirectorySubnet": {
              "type": "string",
              "defaultValue": "10.0.6.0/24",
              "metadata": {
                "description": "Active Directory subnet address prefix"
              }
            }
          },
          "resources": {
            "applicationGatewayNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-agw-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-Internet-HTTP-HTTPS",
                    "properties": {
                      "description": "Allow HTTP and HTTPS traffic from internet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "[parameters('applicationGatewaySubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-GatewayManager",
                    "properties": {
                      "description": "Allow Azure Gateway Manager",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "65200-65535",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-AzureLoadBalancer",
                    "properties": {
                      "description": "Allow Azure Load Balancer",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-WebTier-Outbound",
                    "properties": {
                      "description": "Allow traffic to web tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "sourceAddressPrefix": "[parameters('applicationGatewaySubnet')]",
                      "destinationAddressPrefix": "[parameters('webTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            "managementNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-mgmt-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-RDP-From-Management",
                    "properties": {
                      "description": "Allow RDP from management subnet only",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('managementSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-SSH-From-Management",
                    "properties": {
                      "description": "Allow SSH from management subnet only",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('managementSubnet')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-HTTPS-To-All-Tiers",
                    "properties": {
                      "description": "Allow HTTPS management traffic to all tiers",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('vnetAddressSpace')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            "webTierNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-web-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-ApplicationGateway",
                    "properties": {
                      "description": "Allow traffic from Application Gateway",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "sourceAddressPrefix": "[parameters('applicationGatewaySubnet')]",
                      "destinationAddressPrefix": "[parameters('webTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-RDP",
                    "properties": {
                      "description": "Allow RDP from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('webTierSubnet')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-SSH",
                    "properties": {
                      "description": "Allow SSH from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('webTierSubnet')]",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-BusinessTier-Outbound",
                    "properties": {
                      "description": "Allow traffic to business tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443",
                        "8080",
                        "8443"
                      ],
                      "sourceAddressPrefix": "[parameters('webTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('businessTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            "businessTierNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-biz-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-WebTier",
                    "properties": {
                      "description": "Allow traffic from web tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "80",
                        "443",
                        "8080",
                        "8443"
                      ],
                      "sourceAddressPrefix": "[parameters('webTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('businessTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-RDP",
                    "properties": {
                      "description": "Allow RDP from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('businessTierSubnet')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-SSH",
                    "properties": {
                      "description": "Allow SSH from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('businessTierSubnet')]",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-DataTier-Outbound",
                    "properties": {
                      "description": "Allow traffic to data tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRanges": [
                        "1433",
                        "3306",
                        "5432"
                      ],
                      "sourceAddressPrefix": "[parameters('businessTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            },
            "dataTierNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-data-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-BusinessTier-SQL",
                    "properties": {
                      "description": "Allow SQL traffic from business tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "1433",
                      "sourceAddressPrefix": "[parameters('businessTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-BusinessTier-MySQL",
                    "properties": {
                      "description": "Allow MySQL traffic from business tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3306",
                      "sourceAddressPrefix": "[parameters('businessTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-BusinessTier-PostgreSQL",
                    "properties": {
                      "description": "Allow PostgreSQL traffic from business tier",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "5432",
                      "sourceAddressPrefix": "[parameters('businessTierSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-RDP",
                    "properties": {
                      "description": "Allow RDP from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-SSH",
                    "properties": {
                      "description": "Allow SSH from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('dataTierSubnet')]",
                      "access": "Allow",
                      "priority": 140,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Deny-Internet-Outbound",
                    "properties": {
                      "description": "Deny internet access from data tier",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "[parameters('dataTierSubnet')]",
                      "destinationAddressPrefix": "Internet",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            },
            "activeDirectoryNsg": {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-ad-nsg', parameters('nsgNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-LDAP",
                    "properties": {
                      "description": "Allow LDAP traffic from VNet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "389",
                      "sourceAddressPrefix": "[parameters('vnetAddressSpace')]",
                      "destinationAddressPrefix": "[parameters('activeDirectorySubnet')]",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-LDAPS",
                    "properties": {
                      "description": "Allow LDAPS traffic from VNet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "636",
                      "sourceAddressPrefix": "[parameters('vnetAddressSpace')]",
                      "destinationAddressPrefix": "[parameters('activeDirectorySubnet')]",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Kerberos",
                    "properties": {
                      "description": "Allow Kerberos traffic from VNet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "88",
                      "sourceAddressPrefix": "[parameters('vnetAddressSpace')]",
                      "destinationAddressPrefix": "[parameters('activeDirectorySubnet')]",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-DNS",
                    "properties": {
                      "description": "Allow DNS traffic from VNet",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "53",
                      "sourceAddressPrefix": "[parameters('vnetAddressSpace')]",
                      "destinationAddressPrefix": "[parameters('activeDirectorySubnet')]",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Allow-Management-RDP",
                    "properties": {
                      "description": "Allow RDP from management subnet",
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "[parameters('managementSubnet')]",
                      "destinationAddressPrefix": "[parameters('activeDirectorySubnet')]",
                      "access": "Allow",
                      "priority": 140,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "description": "Deny all other inbound traffic",
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 4000,
                      "direction": "Inbound"
                    }
                  }
                ]
              }
            }
          },
          "outputs": {
            "nsgIds": {
              "type": "object",
              "metadata": {
                "description": "The resource IDs of all NSGs"
              },
              "value": {
                "applicationGateway": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-agw-nsg', parameters('nsgNamePrefix')))]",
                "management": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-mgmt-nsg', parameters('nsgNamePrefix')))]",
                "webTier": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-web-nsg', parameters('nsgNamePrefix')))]",
                "businessTier": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-biz-nsg', parameters('nsgNamePrefix')))]",
                "dataTier": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-data-nsg', parameters('nsgNamePrefix')))]",
                "activeDirectory": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-ad-nsg', parameters('nsgNamePrefix')))]"
              }
            },
            "nsgNames": {
              "type": "object",
              "metadata": {
                "description": "The names of all NSGs"
              },
              "value": {
                "applicationGateway": "[format('{0}-agw-nsg', parameters('nsgNamePrefix'))]",
                "management": "[format('{0}-mgmt-nsg', parameters('nsgNamePrefix'))]",
                "webTier": "[format('{0}-web-nsg', parameters('nsgNamePrefix'))]",
                "businessTier": "[format('{0}-biz-nsg', parameters('nsgNamePrefix'))]",
                "dataTier": "[format('{0}-data-nsg', parameters('nsgNamePrefix'))]",
                "activeDirectory": "[format('{0}-ad-nsg', parameters('nsgNamePrefix'))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions"
      ]
    },
    "virtualNetwork": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "virtual-network-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetworkName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.virtualNetwork]"
          },
          "addressSpace": {
            "value": [
              "[parameters('environmentConfig').networkAddressSpace]"
            ]
          },
          "subnets": {
            "value": "[parameters('environmentConfig').subnets]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "enableDdosProtection": {
            "value": "[parameters('environmentConfig').enableDdosProtection]"
          },
          "ddosProtectionPlanId": "[if(parameters('environmentConfig').enableDdosProtection, createObject('value', reference('ddosProtection').outputs.ddosProtectionPlanId.value), createObject('value', null()))]",
          "networkSecurityGroups": {
            "value": "[reference('networkSecurityGroups').outputs.nsgIds.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1998328201500427293"
            }
          },
          "definitions": {
            "SubnetConfiguration": {
              "type": "object",
              "properties": {
                "applicationGateway": {
                  "type": "string",
                  "metadata": {
                    "description": "Application Gateway subnet address prefix"
                  }
                },
                "management": {
                  "type": "string",
                  "metadata": {
                    "description": "Management subnet address prefix"
                  }
                },
                "webTier": {
                  "type": "string",
                  "metadata": {
                    "description": "Web tier subnet address prefix"
                  }
                },
                "businessTier": {
                  "type": "string",
                  "metadata": {
                    "description": "Business tier subnet address prefix"
                  }
                },
                "dataTier": {
                  "type": "string",
                  "metadata": {
                    "description": "Data tier subnet address prefix"
                  }
                },
                "activeDirectory": {
                  "type": "string",
                  "metadata": {
                    "description": "Active Directory subnet address prefix"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              }
            },
            "addressSpace": {
              "type": "array",
              "defaultValue": [
                "10.0.0.0/16"
              ],
              "metadata": {
                "description": "The address space for the virtual network"
              }
            },
            "subnets": {
              "$ref": "#/definitions/SubnetConfiguration",
              "metadata": {
                "description": "The subnet configuration for the virtual network"
              }
            },
            "dnsServers": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "DNS servers for the virtual network (optional)"
              }
            },
            "enableDdosProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable DDoS protection for the virtual network"
              }
            },
            "ddosProtectionPlanId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "DDoS protection plan resource ID (required if enableDdosProtection is true)"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the virtual network"
              }
            },
            "enableVmProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable VM protection for the virtual network"
              }
            },
            "networkSecurityGroups": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Network Security Group resource IDs for subnets"
              }
            },
            "routeTables": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Route table resource IDs for subnets"
              }
            }
          },
          "variables": {
            "subnetConfigurations": [
              {
                "name": "ApplicationGatewaySubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').applicationGateway]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'applicationGateway'), createObject('id', parameters('networkSecurityGroups').applicationGateway), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'applicationGateway'), createObject('id', parameters('routeTables').applicationGateway), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              },
              {
                "name": "ManagementSubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').management]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'management'), createObject('id', parameters('networkSecurityGroups').management), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'management'), createObject('id', parameters('routeTables').management), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Sql",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              },
              {
                "name": "WebTierSubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').webTier]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'webTier'), createObject('id', parameters('networkSecurityGroups').webTier), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'webTier'), createObject('id', parameters('routeTables').webTier), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Sql",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              },
              {
                "name": "BusinessTierSubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').businessTier]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'businessTier'), createObject('id', parameters('networkSecurityGroups').businessTier), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'businessTier'), createObject('id', parameters('routeTables').businessTier), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Sql",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              },
              {
                "name": "DataTierSubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').dataTier]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'dataTier'), createObject('id', parameters('networkSecurityGroups').dataTier), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'dataTier'), createObject('id', parameters('routeTables').dataTier), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Sql",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              },
              {
                "name": "ActiveDirectorySubnet",
                "properties": {
                  "addressPrefix": "[parameters('subnets').activeDirectory]",
                  "networkSecurityGroup": "[if(contains(parameters('networkSecurityGroups'), 'activeDirectory'), createObject('id', parameters('networkSecurityGroups').activeDirectory), null())]",
                  "routeTable": "[if(contains(parameters('routeTables'), 'activeDirectory'), createObject('id', parameters('routeTables').activeDirectory), null())]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.KeyVault",
                      "locations": [
                        "*"
                      ]
                    },
                    {
                      "service": "Microsoft.Storage",
                      "locations": [
                        "*"
                      ]
                    }
                  ],
                  "delegations": [
                    {
                      "name": "Microsoft.AAD/DomainServices",
                      "properties": {
                        "serviceName": "Microsoft.AAD/DomainServices"
                      }
                    }
                  ],
                  "privateEndpointNetworkPolicies": "Disabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              }
            ]
          },
          "resources": {
            "virtualNetwork": {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-09-01",
              "name": "[parameters('virtualNetworkName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": "[parameters('addressSpace')]"
                },
                "dhcpOptions": "[if(empty(parameters('dnsServers')), null(), createObject('dnsServers', parameters('dnsServers')))]",
                "subnets": "[variables('subnetConfigurations')]",
                "enableDdosProtection": "[parameters('enableDdosProtection')]",
                "ddosProtectionPlan": "[if(and(and(parameters('enableDdosProtection'), not(equals(parameters('ddosProtectionPlanId'), null()))), not(equals(parameters('ddosProtectionPlanId'), ''))), createObject('id', parameters('ddosProtectionPlanId')), null())]",
                "enableVmProtection": "[parameters('enableVmProtection')]"
              }
            }
          },
          "outputs": {
            "virtualNetworkId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the virtual network"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
            },
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              },
              "value": "[parameters('virtualNetworkName')]"
            },
            "addressSpace": {
              "type": "array",
              "metadata": {
                "description": "The address space of the virtual network"
              },
              "value": "[reference('virtualNetwork').addressSpace.addressPrefixes]"
            },
            "subnetIds": {
              "type": "object",
              "metadata": {
                "description": "The subnet resource IDs"
              },
              "value": {
                "applicationGateway": "[reference('virtualNetwork').subnets[0].id]",
                "management": "[reference('virtualNetwork').subnets[1].id]",
                "webTier": "[reference('virtualNetwork').subnets[2].id]",
                "businessTier": "[reference('virtualNetwork').subnets[3].id]",
                "dataTier": "[reference('virtualNetwork').subnets[4].id]",
                "activeDirectory": "[reference('virtualNetwork').subnets[5].id]"
              }
            },
            "subnetNames": {
              "type": "object",
              "metadata": {
                "description": "The subnet names"
              },
              "value": {
                "applicationGateway": "[reference('virtualNetwork').subnets[0].name]",
                "management": "[reference('virtualNetwork').subnets[1].name]",
                "webTier": "[reference('virtualNetwork').subnets[2].name]",
                "businessTier": "[reference('virtualNetwork').subnets[3].name]",
                "dataTier": "[reference('virtualNetwork').subnets[4].name]",
                "activeDirectory": "[reference('virtualNetwork').subnets[5].name]"
              }
            },
            "subnetAddressPrefixes": {
              "type": "object",
              "metadata": {
                "description": "The subnet address prefixes"
              },
              "value": {
                "applicationGateway": "[reference('virtualNetwork').subnets[0].properties.addressPrefix]",
                "management": "[reference('virtualNetwork').subnets[1].properties.addressPrefix]",
                "webTier": "[reference('virtualNetwork').subnets[2].properties.addressPrefix]",
                "businessTier": "[reference('virtualNetwork').subnets[3].properties.addressPrefix]",
                "dataTier": "[reference('virtualNetwork').subnets[4].properties.addressPrefix]",
                "activeDirectory": "[reference('virtualNetwork').subnets[5].properties.addressPrefix]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "ddosProtection",
        "namingConventions",
        "networkSecurityGroups"
      ]
    },
    "virtualNetworkManager": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "virtual-network-manager-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetworkManagerName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.virtualNetworkManager]"
          },
          "vnmDescription": {
            "value": "[format('Virtual Network Manager for {0} {1} environment', parameters('workloadName'), parameters('environment'))]"
          },
          "scopeType": {
            "value": "Subscription"
          },
          "scopeAccesses": {
            "value": [
              "SecurityAdmin",
              "Connectivity"
            ]
          },
          "scopeId": {
            "value": "[subscription().subscriptionId]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "networkGroups": {
            "value": [
              {
                "name": "[format('{0}-web-tier', parameters('environment'))]",
                "description": "[format('{0} web tier virtual networks', parameters('environment'))]",
                "memberType": "VirtualNetwork"
              },
              {
                "name": "[format('{0}-business-tier', parameters('environment'))]",
                "description": "[format('{0} business tier virtual networks', parameters('environment'))]",
                "memberType": "VirtualNetwork"
              },
              {
                "name": "[format('{0}-data-tier', parameters('environment'))]",
                "description": "[format('{0} data tier virtual networks', parameters('environment'))]",
                "memberType": "VirtualNetwork"
              }
            ]
          },
          "connectivityConfigurations": {
            "value": [
              {
                "name": "[format('{0}-hub-spoke-connectivity', parameters('environment'))]",
                "description": "[format('Hub and spoke connectivity for {0} environment', parameters('environment'))]",
                "connectivityTopology": "HubAndSpoke",
                "isGlobal": false,
                "deleteExistingPeering": false,
                "hubs": [],
                "appliesToGroups": []
              }
            ]
          },
          "securityAdminConfigurations": {
            "value": [
              {
                "name": "[format('{0}-security-rules', parameters('environment'))]",
                "description": "[format('Security admin rules for {0} environment', parameters('environment'))]",
                "applyOnNetworkIntentPolicyBasedServices": [
                  "None"
                ],
                "ruleCollections": [
                  {
                    "name": "deny-high-risk-ports",
                    "description": "Deny access to high-risk ports from internet",
                    "appliesToGroups": [],
                    "rules": [
                      {
                        "name": "deny-rdp-from-internet",
                        "description": "Deny RDP access from internet",
                        "access": "Deny",
                        "direction": "Inbound",
                        "priority": 100,
                        "protocol": "Tcp",
                        "sources": [
                          {
                            "addressPrefixType": "IPPrefix",
                            "addressPrefix": "Internet"
                          }
                        ],
                        "destinations": [
                          {
                            "addressPrefixType": "IPPrefix",
                            "addressPrefix": "*"
                          }
                        ],
                        "sourcePortRanges": [
                          "*"
                        ],
                        "destinationPortRanges": [
                          "3389"
                        ]
                      },
                      {
                        "name": "deny-ssh-from-internet",
                        "description": "Deny SSH access from internet",
                        "access": "Deny",
                        "direction": "Inbound",
                        "priority": 110,
                        "protocol": "Tcp",
                        "sources": [
                          {
                            "addressPrefixType": "IPPrefix",
                            "addressPrefix": "Internet"
                          }
                        ],
                        "destinations": [
                          {
                            "addressPrefixType": "IPPrefix",
                            "addressPrefix": "*"
                          }
                        ],
                        "sourcePortRanges": [
                          "*"
                        ],
                        "destinationPortRanges": [
                          "22"
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "13501635128287716398"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "virtualNetworkManagerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Virtual Network Manager"
              }
            },
            "vnmDescription": {
              "type": "string",
              "defaultValue": "Virtual Network Manager for centralized network governance",
              "metadata": {
                "description": "The description of the Virtual Network Manager"
              }
            },
            "scopeType": {
              "type": "string",
              "defaultValue": "Subscription",
              "allowedValues": [
                "Subscription",
                "ManagementGroup"
              ],
              "metadata": {
                "description": "The scope of the Virtual Network Manager"
              }
            },
            "scopeAccesses": {
              "type": "array",
              "defaultValue": [
                "SecurityAdmin",
                "Connectivity"
              ],
              "allowedValues": [
                "SecurityAdmin",
                "Connectivity"
              ],
              "metadata": {
                "description": "The scope access type for the Virtual Network Manager"
              }
            },
            "scopeId": {
              "type": "string",
              "metadata": {
                "description": "The subscription ID or management group ID for the scope"
              }
            },
            "networkGroups": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "production-web-tier",
                  "description": "Production web tier virtual networks",
                  "memberType": "VirtualNetwork"
                },
                {
                  "name": "production-business-tier",
                  "description": "Production business tier virtual networks",
                  "memberType": "VirtualNetwork"
                },
                {
                  "name": "production-data-tier",
                  "description": "Production data tier virtual networks",
                  "memberType": "VirtualNetwork"
                },
                {
                  "name": "staging-environment",
                  "description": "Staging environment virtual networks",
                  "memberType": "VirtualNetwork"
                },
                {
                  "name": "development-environment",
                  "description": "Development environment virtual networks",
                  "memberType": "VirtualNetwork"
                }
              ],
              "metadata": {
                "description": "Network groups configuration"
              }
            },
            "connectivityConfigurations": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "hub-spoke-connectivity",
                  "description": "Hub and spoke connectivity configuration",
                  "connectivityTopology": "HubAndSpoke",
                  "isGlobal": false,
                  "deleteExistingPeering": false,
                  "hubs": [],
                  "appliesToGroups": []
                }
              ],
              "metadata": {
                "description": "Connectivity configurations for network topology"
              }
            },
            "securityAdminConfigurations": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "default-security-rules",
                  "description": "Default security admin rules for all network groups",
                  "applyOnNetworkIntentPolicyBasedServices": [
                    "None"
                  ],
                  "ruleCollections": [
                    {
                      "name": "deny-high-risk-ports",
                      "description": "Deny access to high-risk ports",
                      "appliesToGroups": [],
                      "rules": [
                        {
                          "name": "deny-rdp-from-internet",
                          "description": "Deny RDP access from internet",
                          "access": "Deny",
                          "direction": "Inbound",
                          "priority": 100,
                          "protocol": "Tcp",
                          "sources": [
                            {
                              "addressPrefixType": "IPPrefix",
                              "addressPrefix": "Internet"
                            }
                          ],
                          "destinations": [
                            {
                              "addressPrefixType": "IPPrefix",
                              "addressPrefix": "*"
                            }
                          ],
                          "sourcePortRanges": [
                            "*"
                          ],
                          "destinationPortRanges": [
                            "3389"
                          ]
                        },
                        {
                          "name": "deny-ssh-from-internet",
                          "description": "Deny SSH access from internet",
                          "access": "Deny",
                          "direction": "Inbound",
                          "priority": 110,
                          "protocol": "Tcp",
                          "sources": [
                            {
                              "addressPrefixType": "IPPrefix",
                              "addressPrefix": "Internet"
                            }
                          ],
                          "destinations": [
                            {
                              "addressPrefixType": "IPPrefix",
                              "addressPrefix": "*"
                            }
                          ],
                          "sourcePortRanges": [
                            "*"
                          ],
                          "destinationPortRanges": [
                            "22"
                          ]
                        }
                      ]
                    }
                  ]
                }
              ],
              "metadata": {
                "description": "Security admin configurations"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the Virtual Network Manager"
              }
            }
          },
          "resources": {
            "virtualNetworkManager": {
              "type": "Microsoft.Network/networkManagers",
              "apiVersion": "2023-09-01",
              "name": "[parameters('virtualNetworkManagerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "[parameters('vnmDescription')]",
                "networkManagerScopes": {
                  "subscriptions": "[if(equals(parameters('scopeType'), 'Subscription'), createArray(parameters('scopeId')), createArray())]",
                  "managementGroups": "[if(equals(parameters('scopeType'), 'ManagementGroup'), createArray(parameters('scopeId')), createArray())]"
                },
                "networkManagerScopeAccesses": "[parameters('scopeAccesses')]"
              }
            },
            "networkGroupResources": {
              "copy": {
                "name": "networkGroupResources",
                "count": "[length(parameters('networkGroups'))]"
              },
              "type": "Microsoft.Network/networkManagers/networkGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkManagerName'), parameters('networkGroups')[copyIndex()].name)]",
              "properties": {
                "description": "[parameters('networkGroups')[copyIndex()].description]"
              },
              "dependsOn": [
                "virtualNetworkManager"
              ]
            },
            "connectivityConfigurationResources": {
              "copy": {
                "name": "connectivityConfigurationResources",
                "count": "[length(parameters('connectivityConfigurations'))]"
              },
              "type": "Microsoft.Network/networkManagers/connectivityConfigurations",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkManagerName'), parameters('connectivityConfigurations')[copyIndex()].name)]",
              "properties": {
                "description": "[parameters('connectivityConfigurations')[copyIndex()].description]",
                "connectivityTopology": "[parameters('connectivityConfigurations')[copyIndex()].connectivityTopology]",
                "isGlobal": "[parameters('connectivityConfigurations')[copyIndex()].isGlobal]",
                "deleteExistingPeering": "[parameters('connectivityConfigurations')[copyIndex()].deleteExistingPeering]",
                "hubs": "[parameters('connectivityConfigurations')[copyIndex()].hubs]",
                "appliesToGroups": "[parameters('connectivityConfigurations')[copyIndex()].appliesToGroups]"
              },
              "dependsOn": [
                "networkGroupResources",
                "virtualNetworkManager"
              ]
            },
            "securityAdminConfigurationResources": {
              "copy": {
                "name": "securityAdminConfigurationResources",
                "count": "[length(parameters('securityAdminConfigurations'))]"
              },
              "type": "Microsoft.Network/networkManagers/securityAdminConfigurations",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkManagerName'), parameters('securityAdminConfigurations')[copyIndex()].name)]",
              "properties": {
                "description": "[parameters('securityAdminConfigurations')[copyIndex()].description]",
                "applyOnNetworkIntentPolicyBasedServices": "[parameters('securityAdminConfigurations')[copyIndex()].applyOnNetworkIntentPolicyBasedServices]"
              },
              "dependsOn": [
                "networkGroupResources",
                "virtualNetworkManager"
              ]
            },
            "securityAdminRuleCollections": {
              "copy": {
                "name": "securityAdminRuleCollections",
                "count": "[length(parameters('securityAdminConfigurations'))]"
              },
              "type": "Microsoft.Network/networkManagers/securityAdminConfigurations/ruleCollections",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('virtualNetworkManagerName'), parameters('securityAdminConfigurations')[copyIndex()].name, parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].name)]",
              "properties": {
                "description": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].description]",
                "appliesToGroups": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].appliesToGroups]"
              },
              "dependsOn": [
                "[format('securityAdminConfigurationResources[{0}]', copyIndex())]"
              ]
            },
            "securityAdminRulesRDP": {
              "copy": {
                "name": "securityAdminRulesRDP",
                "count": "[length(parameters('securityAdminConfigurations'))]"
              },
              "type": "Microsoft.Network/networkManagers/securityAdminConfigurations/ruleCollections/rules",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('virtualNetworkManagerName'), parameters('securityAdminConfigurations')[copyIndex()].name, parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].name, parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].name)]",
              "kind": "Custom",
              "properties": {
                "description": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].description]",
                "access": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].access]",
                "direction": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].direction]",
                "priority": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].priority]",
                "protocol": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].protocol]",
                "sources": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].sources]",
                "destinations": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].destinations]",
                "sourcePortRanges": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].sourcePortRanges]",
                "destinationPortRanges": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[0].destinationPortRanges]"
              },
              "dependsOn": [
                "[format('securityAdminRuleCollections[{0}]', copyIndex())]"
              ]
            },
            "securityAdminRulesSSH": {
              "copy": {
                "name": "securityAdminRulesSSH",
                "count": "[length(parameters('securityAdminConfigurations'))]"
              },
              "type": "Microsoft.Network/networkManagers/securityAdminConfigurations/ruleCollections/rules",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('virtualNetworkManagerName'), parameters('securityAdminConfigurations')[copyIndex()].name, parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].name, parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].name)]",
              "kind": "Custom",
              "properties": {
                "description": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].description]",
                "access": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].access]",
                "direction": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].direction]",
                "priority": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].priority]",
                "protocol": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].protocol]",
                "sources": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].sources]",
                "destinations": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].destinations]",
                "sourcePortRanges": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].sourcePortRanges]",
                "destinationPortRanges": "[parameters('securityAdminConfigurations')[copyIndex()].ruleCollections[0].rules[1].destinationPortRanges]"
              },
              "dependsOn": [
                "[format('securityAdminRuleCollections[{0}]', copyIndex())]"
              ]
            }
          },
          "outputs": {
            "virtualNetworkManagerId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Virtual Network Manager"
              },
              "value": "[resourceId('Microsoft.Network/networkManagers', parameters('virtualNetworkManagerName'))]"
            },
            "virtualNetworkManagerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Virtual Network Manager"
              },
              "value": "[parameters('virtualNetworkManagerName')]"
            },
            "networkGroupIds": {
              "type": "array",
              "metadata": {
                "description": "The resource IDs of the network groups"
              },
              "copy": {
                "count": "[length(parameters('networkGroups'))]",
                "input": "[resourceId('Microsoft.Network/networkManagers/networkGroups', parameters('virtualNetworkManagerName'), parameters('networkGroups')[copyIndex()].name)]"
              }
            },
            "networkGroupNames": {
              "type": "array",
              "metadata": {
                "description": "The names of the network groups"
              },
              "copy": {
                "count": "[length(parameters('networkGroups'))]",
                "input": "[parameters('networkGroups')[copyIndex()].name]"
              }
            },
            "connectivityConfigurationIds": {
              "type": "array",
              "metadata": {
                "description": "The resource IDs of the connectivity configurations"
              },
              "copy": {
                "count": "[length(parameters('connectivityConfigurations'))]",
                "input": "[resourceId('Microsoft.Network/networkManagers/connectivityConfigurations', parameters('virtualNetworkManagerName'), parameters('connectivityConfigurations')[copyIndex()].name)]"
              }
            },
            "securityAdminConfigurationIds": {
              "type": "array",
              "metadata": {
                "description": "The resource IDs of the security admin configurations"
              },
              "copy": {
                "count": "[length(parameters('securityAdminConfigurations'))]",
                "input": "[resourceId('Microsoft.Network/networkManagers/securityAdminConfigurations', parameters('virtualNetworkManagerName'), parameters('securityAdminConfigurations')[copyIndex()].name)]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "managedIdentities": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "managed-identities-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityBaseName": {
            "value": "[format('{0}-{1}-{2}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'))]"
          },
          "userAssignedIdentities": {
            "value": [
              {
                "name": "application-services",
                "description": "Managed identity for application services",
                "roleAssignments": []
              },
              {
                "name": "key-vault-access",
                "description": "Managed identity for Key Vault access",
                "roleAssignments": []
              },
              {
                "name": "storage-access",
                "description": "Managed identity for storage account access",
                "roleAssignments": []
              },
              {
                "name": "sql-access",
                "description": "Managed identity for SQL database access",
                "roleAssignments": []
              },
              {
                "name": "application-gateway",
                "description": "Managed identity for Application Gateway Key Vault access",
                "roleAssignments": []
              }
            ]
          },
          "enableDiagnostics": {
            "value": true
          },
          "logAnalyticsWorkspaceId": {
            "value": ""
          },
          "enableTelemetry": {
            "value": true
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6924630922910097285"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "managedIdentityBaseName": {
              "type": "string",
              "metadata": {
                "description": "The base name for managed identities"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "userAssignedIdentities": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "application-services",
                  "description": "Managed identity for application services",
                  "roleAssignments": []
                },
                {
                  "name": "key-vault-access",
                  "description": "Managed identity for Key Vault access",
                  "roleAssignments": []
                },
                {
                  "name": "storage-access",
                  "description": "Managed identity for storage account access",
                  "roleAssignments": []
                },
                {
                  "name": "sql-access",
                  "description": "Managed identity for SQL database access",
                  "roleAssignments": []
                }
              ],
              "metadata": {
                "description": "List of user-assigned managed identities to create"
              }
            },
            "enableDiagnostics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings for managed identities"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for diagnostic settings"
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable telemetry for the module"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "identityNames",
                "count": "[length(parameters('userAssignedIdentities'))]",
                "input": "[format('{0}-{1}-mi', parameters('managedIdentityBaseName'), parameters('userAssignedIdentities')[copyIndex('identityNames')].name)]"
              }
            ],
            "commonRoleDefinitions": {
              "storageBlobDataContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "storageBlobDataReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
              "storageAccountContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
              "keyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
              "keyVaultCertificateUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
              "keyVaultCryptoUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
              "sqlDbContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9b7fa17d-e63e-47b0-bb0a-15c516ac86ec')]",
              "monitoringContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '749f88d5-cbae-40b8-bcfc-e573ddc772fa')]",
              "monitoringReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
              "contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
            }
          },
          "resources": {
            "userAssignedManagedIdentities": {
              "copy": {
                "name": "userAssignedManagedIdentities",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('identityNames')[copyIndex()]]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Purpose', parameters('userAssignedIdentities')[copyIndex()].description, 'IdentityType', 'UserAssigned'))]"
            },
            "managedIdentityRoleAssignments": {
              "copy": {
                "name": "managedIdentityRoleAssignments",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "condition": "[not(empty(parameters('userAssignedIdentities')[copyIndex()].roleAssignments))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()]), parameters('userAssignedIdentities')[copyIndex()].name, 'role-assignment')]",
              "properties": {
                "roleDefinitionId": "[variables('commonRoleDefinitions')[parameters('userAssignedIdentities')[copyIndex()].roleAssignments[0].role]]",
                "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]",
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
              ]
            },
            "managedIdentityDiagnostics": {
              "copy": {
                "name": "managedIdentityDiagnostics",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "condition": "[and(parameters('enableDiagnostics'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ManagedIdentity/userAssignedIdentities/{0}', variables('identityNames')[copyIndex()])]",
              "name": "[format('{0}-diagnostics', variables('identityNames')[copyIndex()])]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
              ]
            },
            "telemetryDeployment": {
              "condition": "[parameters('enableTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            }
          },
          "outputs": {
            "managedIdentityIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity resource IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]])]"
              }
            },
            "managedIdentityNames": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity names"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]]]"
              }
            },
            "managedIdentityPrincipalIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity principal IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).principalId]"
              }
            },
            "managedIdentityClientIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity client IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).clientId]"
              }
            },
            "managedIdentityConfigs": {
              "type": "array",
              "metadata": {
                "description": "Managed identity configuration details"
              },
              "copy": {
                "count": "[length(parameters('userAssignedIdentities'))]",
                "input": {
                  "name": "[variables('identityNames')[copyIndex()]]",
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).clientId]",
                  "purpose": "[parameters('userAssignedIdentities')[copyIndex()].description]",
                  "type": "UserAssigned"
                }
              }
            },
            "managedIdentityLookup": {
              "type": "object",
              "metadata": {
                "description": "Managed identity lookup object for easy reference"
              },
              "value": {
                "applicationServices": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[0])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).clientId]"
                },
                "keyVaultAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[1])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).clientId]"
                },
                "storageAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[2])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).clientId]"
                },
                "sqlAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[3])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).clientId]"
                }
              }
            },
            "roleDefinitions": {
              "type": "object",
              "metadata": {
                "description": "Common role definitions for reference"
              },
              "value": "[variables('commonRoleDefinitions')]"
            }
          }
        }
      }
    },
    "keyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.keyVault]"
          },
          "keyVaultConfig": {
            "value": {
              "sku": "[if(equals(parameters('environmentConfig').skuTier, 'Premium'), 'premium', 'standard')]",
              "enableSoftDelete": true,
              "softDeleteRetentionInDays": "[if(equals(parameters('environment'), 'prod'), 90, 30)]",
              "enablePurgeProtection": "[equals(parameters('environment'), 'prod')]",
              "enableRbacAuthorization": true,
              "networkAcls": {
                "bypass": "AzureServices",
                "defaultAction": "[if(parameters('environmentConfig').enablePrivateEndpoints, 'Deny', 'Allow')]",
                "ipRules": [],
                "virtualNetworkRules": "[if(parameters('environmentConfig').enablePrivateEndpoints, createArray(reference('virtualNetwork').outputs.subnetIds.value.management, reference('virtualNetwork').outputs.subnetIds.value.webTier, reference('virtualNetwork').outputs.subnetIds.value.businessTier), createArray())]"
              }
            }
          },
          "keyVaultAdministrators": {
            "value": []
          },
          "keyVaultSecretsUsers": {
            "value": [
              "[reference('managedIdentities').outputs.managedIdentityLookup.value.keyVaultAccess.principalId]",
              "[reference('managedIdentities').outputs.managedIdentityLookup.value.applicationGateway.principalId]"
            ]
          },
          "keyVaultCertificateUsers": {
            "value": [
              "[reference('managedIdentities').outputs.managedIdentityLookup.value.applicationGateway.principalId]"
            ]
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "5748297240115920289"
            }
          },
          "definitions": {
            "KeyVaultConfig": {
              "type": "object",
              "properties": {
                "sku": {
                  "type": "string",
                  "allowedValues": [
                    "premium",
                    "standard"
                  ],
                  "metadata": {
                    "description": "Key Vault SKU"
                  }
                },
                "enableSoftDelete": {
                  "type": "bool",
                  "metadata": {
                    "description": "Enable soft delete"
                  }
                },
                "softDeleteRetentionInDays": {
                  "type": "int",
                  "minValue": 7,
                  "maxValue": 90,
                  "metadata": {
                    "description": "Soft delete retention days"
                  }
                },
                "enablePurgeProtection": {
                  "type": "bool",
                  "metadata": {
                    "description": "Enable purge protection"
                  }
                },
                "enableRbacAuthorization": {
                  "type": "bool",
                  "metadata": {
                    "description": "Enable RBAC authorization"
                  }
                },
                "networkAcls": {
                  "type": "object",
                  "properties": {
                    "bypass": {
                      "type": "string",
                      "allowedValues": [
                        "AzureServices",
                        "None"
                      ]
                    },
                    "defaultAction": {
                      "type": "string",
                      "allowedValues": [
                        "Allow",
                        "Deny"
                      ]
                    },
                    "ipRules": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "nullable": true
                    },
                    "virtualNetworkRules": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "Network access control"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "keyVaultConfig": {
              "$ref": "#/definitions/KeyVaultConfig",
              "defaultValue": {
                "sku": "standard",
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "enableRbacAuthorization": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny",
                  "ipRules": [],
                  "virtualNetworkRules": []
                }
              },
              "metadata": {
                "description": "Key Vault configuration settings"
              }
            },
            "allowedSubnetIds": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Subnet IDs that should have access to Key Vault"
              }
            },
            "allowedIpAddresses": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [],
              "metadata": {
                "description": "IP addresses that should have access to Key Vault"
              }
            },
            "keyVaultAdministrators": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Object IDs of users/groups/service principals that should have Key Vault Administrator access"
              }
            },
            "keyVaultSecretsUsers": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Object IDs of users/groups/service principals that should have Key Vault Secrets User access"
              }
            },
            "keyVaultCertificateUsers": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "defaultValue": [],
              "metadata": {
                "description": "Object IDs of users/groups/service principals that should have Key Vault Certificate User access"
              }
            },
            "enableDiagnostics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings for Key Vault"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for diagnostic settings"
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable telemetry for the module"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "ipRules",
                "count": "[length(parameters('allowedIpAddresses'))]",
                "input": {
                  "value": "[parameters('allowedIpAddresses')[copyIndex('ipRules')]]"
                }
              },
              {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnetIds'))]",
                "input": {
                  "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]",
                  "ignoreMissingVnetServiceEndpoint": false
                }
              }
            ],
            "networkRules": {
              "bypass": "[parameters('keyVaultConfig').networkAcls.bypass]",
              "defaultAction": "[parameters('keyVaultConfig').networkAcls.defaultAction]",
              "ipRules": "[variables('ipRules')]",
              "virtualNetworkRules": "[variables('virtualNetworkRules')]"
            },
            "roleDefinitions": {
              "keyVaultAdministrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
              "keyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
              "keyVaultCertificateUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
              "keyVaultCryptoUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]"
            }
          },
          "resources": {
            "keyVault": {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "[parameters('keyVaultConfig').sku]"
                },
                "tenantId": "[tenant().tenantId]",
                "enableSoftDelete": "[parameters('keyVaultConfig').enableSoftDelete]",
                "softDeleteRetentionInDays": "[parameters('keyVaultConfig').softDeleteRetentionInDays]",
                "enablePurgeProtection": "[if(parameters('keyVaultConfig').enablePurgeProtection, true(), null())]",
                "enableRbacAuthorization": "[parameters('keyVaultConfig').enableRbacAuthorization]",
                "enabledForDeployment": false,
                "enabledForDiskEncryption": true,
                "enabledForTemplateDeployment": true,
                "networkAcls": "[variables('networkRules')]",
                "publicNetworkAccess": "[if(equals(parameters('keyVaultConfig').networkAcls.defaultAction, 'Allow'), 'Enabled', 'Disabled')]"
              }
            },
            "keyVaultAdminRoleAssignments": {
              "copy": {
                "name": "keyVaultAdminRoleAssignments",
                "count": "[length(parameters('keyVaultAdministrators'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultAdministrators')[copyIndex()], variables('roleDefinitions').keyVaultAdministrator)]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitions').keyVaultAdministrator]",
                "principalId": "[parameters('keyVaultAdministrators')[copyIndex()]]",
                "principalType": "User"
              },
              "dependsOn": [
                "keyVault"
              ]
            },
            "keyVaultSecretsUserRoleAssignments": {
              "copy": {
                "name": "keyVaultSecretsUserRoleAssignments",
                "count": "[length(parameters('keyVaultSecretsUsers'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultSecretsUsers')[copyIndex()], variables('roleDefinitions').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitions').keyVaultSecretsUser]",
                "principalId": "[parameters('keyVaultSecretsUsers')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "keyVault"
              ]
            },
            "keyVaultCertificateUserRoleAssignments": {
              "copy": {
                "name": "keyVaultCertificateUserRoleAssignments",
                "count": "[length(parameters('keyVaultCertificateUsers'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultCertificateUsers')[copyIndex()], variables('roleDefinitions').keyVaultCertificateUser)]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitions').keyVaultCertificateUser]",
                "principalId": "[parameters('keyVaultCertificateUsers')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "keyVault"
              ]
            },
            "keyVaultDiagnostics": {
              "condition": "[and(parameters('enableDiagnostics'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[format('{0}-diagnostics', parameters('keyVaultName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "keyVault"
              ]
            },
            "telemetryDeployment": {
              "condition": "[parameters('enableTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            }
          },
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Key Vault"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              },
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault"
              },
              "value": "[reference('keyVault').vaultUri]"
            },
            "keyVaultConfig": {
              "type": "object",
              "metadata": {
                "description": "The Key Vault configuration"
              },
              "value": {
                "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "name": "[parameters('keyVaultName')]",
                "uri": "[reference('keyVault').vaultUri]",
                "sku": "[reference('keyVault').sku.name]",
                "enableSoftDelete": "[reference('keyVault').enableSoftDelete]",
                "softDeleteRetentionInDays": "[reference('keyVault').softDeleteRetentionInDays]",
                "enablePurgeProtection": "[reference('keyVault').enablePurgeProtection]",
                "enableRbacAuthorization": "[reference('keyVault').enableRbacAuthorization]",
                "networkAcls": "[reference('keyVault').networkAcls]",
                "publicNetworkAccess": "[reference('keyVault').publicNetworkAccess]"
              }
            },
            "roleAssignments": {
              "type": "object",
              "metadata": {
                "description": "Role assignment information"
              },
              "value": {
                "administratorsCount": "[length(parameters('keyVaultAdministrators'))]",
                "secretsUsersCount": "[length(parameters('keyVaultSecretsUsers'))]",
                "certificateUsersCount": "[length(parameters('keyVaultCertificateUsers'))]",
                "roleDefinitions": "[variables('roleDefinitions')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "managedIdentities",
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "securityCenter": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "security-center-deployment",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "subscriptionId": {
            "value": "[subscription().subscriptionId]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "enableDefenderPlans": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "defenderPlans": {
            "value": [
              {
                "name": "VirtualMachines",
                "tier": "Standard",
                "subPlan": "P2"
              },
              {
                "name": "AppServices",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "SqlServers",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "SqlServerVirtualMachines",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "StorageAccounts",
                "tier": "Standard",
                "subPlan": "DefenderForStorageV2"
              },
              {
                "name": "KeyVaults",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "Arm",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "OpenSourceRelationalDatabases",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "Containers",
                "tier": "Standard",
                "subPlan": null
              },
              {
                "name": "CloudPosture",
                "tier": "Standard",
                "subPlan": null
              }
            ]
          },
          "securityContacts": {
            "value": [
              {
                "email": "security@contoso.com",
                "phone": "+1-555-0123",
                "alertNotifications": "On",
                "notificationsByRole": "On"
              }
            ]
          },
          "autoProvisioningSettings": {
            "value": {
              "logAnalytics": "On",
              "microsoftDefenderForEndpoint": "On",
              "vulnerabilityAssessment": "On",
              "guestConfiguration": "On"
            }
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "enableTelemetry": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11699967902010610887"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "subscriptionId": {
              "type": "string",
              "defaultValue": "[subscription().subscriptionId]",
              "metadata": {
                "description": "The subscription ID for Security Center configuration"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "enableDefenderPlans": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Microsoft Defender for Cloud plans"
              }
            },
            "defenderPlans": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "VirtualMachines",
                  "tier": "Standard",
                  "subPlan": "P2"
                },
                {
                  "name": "AppServices",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "SqlServers",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "SqlServerVirtualMachines",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "StorageAccounts",
                  "tier": "Standard",
                  "subPlan": "DefenderForStorageV2"
                },
                {
                  "name": "KeyVaults",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "Arm",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "OpenSourceRelationalDatabases",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "Containers",
                  "tier": "Standard",
                  "subPlan": null
                },
                {
                  "name": "CloudPosture",
                  "tier": "Standard",
                  "subPlan": null
                }
              ],
              "metadata": {
                "description": "Microsoft Defender for Cloud plans to enable"
              }
            },
            "securityContacts": {
              "type": "array",
              "defaultValue": [
                {
                  "email": "security@contoso.com",
                  "phone": "+1-555-0123",
                  "alertNotifications": "On",
                  "notificationsByRole": "On"
                }
              ],
              "metadata": {
                "description": "Security contacts configuration"
              }
            },
            "autoProvisioningSettings": {
              "type": "object",
              "defaultValue": {
                "logAnalytics": "On",
                "microsoftDefenderForEndpoint": "On",
                "vulnerabilityAssessment": "On",
                "guestConfiguration": "On"
              },
              "metadata": {
                "description": "Auto provisioning settings"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for Security Center integration"
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable telemetry for the module"
              }
            }
          },
          "variables": {
            "workspaceSettings": "[if(not(empty(parameters('logAnalyticsWorkspaceId'))), createObject('workspaceId', parameters('logAnalyticsWorkspaceId'), 'scope', parameters('subscriptionId')), null())]"
          },
          "resources": {
            "defenderForCloudPlans": {
              "copy": {
                "name": "defenderForCloudPlans",
                "count": "[length(parameters('defenderPlans'))]"
              },
              "condition": "[parameters('enableDefenderPlans')]",
              "type": "Microsoft.Security/pricings",
              "apiVersion": "2024-01-01",
              "name": "[parameters('defenderPlans')[copyIndex()].name]",
              "properties": {
                "pricingTier": "[parameters('defenderPlans')[copyIndex()].tier]",
                "subPlan": "[parameters('defenderPlans')[copyIndex()].subPlan]"
              }
            },
            "securityContactsConfig": {
              "copy": {
                "name": "securityContactsConfig",
                "count": "[length(parameters('securityContacts'))]"
              },
              "type": "Microsoft.Security/securityContacts",
              "apiVersion": "2020-01-01-preview",
              "name": "[format('default{0}', add(copyIndex(), 1))]",
              "properties": {
                "emails": "[parameters('securityContacts')[copyIndex()].email]",
                "phone": "[parameters('securityContacts')[copyIndex()].phone]",
                "alertNotifications": {
                  "state": "[parameters('securityContacts')[copyIndex()].alertNotifications]",
                  "minimalSeverity": "Medium"
                },
                "notificationsByRole": {
                  "state": "[parameters('securityContacts')[copyIndex()].notificationsByRole]",
                  "roles": [
                    "Owner",
                    "Contributor"
                  ]
                }
              }
            },
            "autoProvisioningLogAnalytics": {
              "condition": "[equals(parameters('autoProvisioningSettings').logAnalytics, 'On')]",
              "type": "Microsoft.Security/autoProvisioningSettings",
              "apiVersion": "2017-08-01-preview",
              "name": "default",
              "properties": {
                "autoProvision": "[parameters('autoProvisioningSettings').logAnalytics]"
              }
            },
            "workspaceSettingsConfig": {
              "condition": "[not(equals(variables('workspaceSettings'), null()))]",
              "type": "Microsoft.Security/workspaceSettings",
              "apiVersion": "2017-08-01-preview",
              "name": "default",
              "properties": {
                "workspaceId": "[variables('workspaceSettings').workspaceId]",
                "scope": "[variables('workspaceSettings').scope]"
              }
            },
            "securityPolicyAssignment": {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2022-06-01",
              "name": "[format('ASC-Default-{0}', uniqueString(parameters('subscriptionId')))]",
              "properties": {
                "displayName": "Azure Security Benchmark",
                "description": "Azure Security Benchmark initiative for Microsoft Defender for Cloud",
                "policyDefinitionId": "/providers/Microsoft.Authorization/policySetDefinitions/1f3afdf9-d0c9-4c3d-847f-89da613e70a8",
                "parameters": {},
                "metadata": {
                  "assignedBy": "Bicep Template",
                  "category": "Security Center"
                }
              }
            },
            "customSecurityAssessments": {
              "type": "Microsoft.Security/assessmentMetadata",
              "apiVersion": "2021-06-01",
              "name": "[format('custom-security-assessment-{0}', uniqueString(parameters('subscriptionId')))]",
              "properties": {
                "displayName": "[format('Custom Security Assessment for {0}', parameters('tags').Workload)]",
                "description": "Custom security assessment for workload-specific security requirements",
                "severity": "Medium",
                "assessmentType": "CustomerManaged",
                "categories": [
                  "Compute",
                  "Data",
                  "Networking"
                ],
                "userImpact": "Moderate",
                "implementationEffort": "Moderate"
              }
            },
            "telemetryDeployment": {
              "condition": "[parameters('enableTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            }
          },
          "outputs": {
            "defenderPlansConfig": {
              "type": "array",
              "metadata": {
                "description": "Microsoft Defender for Cloud plan configurations"
              },
              "copy": {
                "count": "[length(parameters('defenderPlans'))]",
                "input": {
                  "name": "[parameters('defenderPlans')[copyIndex()].name]",
                  "tier": "[if(parameters('enableDefenderPlans'), reference(format('defenderForCloudPlans[{0}]', copyIndex())).pricingTier, '')]",
                  "subPlan": "[if(parameters('enableDefenderPlans'), reference(format('defenderForCloudPlans[{0}]', copyIndex())).subPlan, '')]",
                  "resourceId": "[if(parameters('enableDefenderPlans'), subscriptionResourceId('Microsoft.Security/pricings', parameters('defenderPlans')[copyIndex()].name), '')]"
                }
              }
            },
            "securityContactsConfig": {
              "type": "array",
              "metadata": {
                "description": "Security contacts configuration"
              },
              "copy": {
                "count": "[length(parameters('securityContacts'))]",
                "input": {
                  "name": "[format('default{0}', add(copyIndex(), 1))]",
                  "email": "[parameters('securityContacts')[copyIndex()].email]",
                  "phone": "[parameters('securityContacts')[copyIndex()].phone]",
                  "resourceId": "[subscriptionResourceId('Microsoft.Security/securityContacts', format('default{0}', add(copyIndex(), 1)))]"
                }
              }
            },
            "autoProvisioningConfig": {
              "type": "object",
              "metadata": {
                "description": "Auto provisioning settings"
              },
              "value": {
                "logAnalytics": "[parameters('autoProvisioningSettings').logAnalytics]",
                "resourceId": "[subscriptionResourceId('Microsoft.Security/autoProvisioningSettings', 'default')]"
              }
            },
            "workspaceSettingsConfig": {
              "type": "object",
              "metadata": {
                "description": "Workspace settings configuration"
              },
              "value": "[if(not(equals(variables('workspaceSettings'), null())), createObject('workspaceId', variables('workspaceSettings').workspaceId, 'scope', variables('workspaceSettings').scope, 'resourceId', subscriptionResourceId('Microsoft.Security/workspaceSettings', 'default')), createObject('workspaceId', '', 'scope', '', 'resourceId', ''))]"
            },
            "securityPolicyAssignment": {
              "type": "object",
              "metadata": {
                "description": "Security policy assignment information"
              },
              "value": {
                "name": "[format('ASC-Default-{0}', uniqueString(parameters('subscriptionId')))]",
                "displayName": "[reference('securityPolicyAssignment').displayName]",
                "policyDefinitionId": "[reference('securityPolicyAssignment').policyDefinitionId]",
                "resourceId": "[subscriptionResourceId('Microsoft.Authorization/policyAssignments', format('ASC-Default-{0}', uniqueString(parameters('subscriptionId'))))]"
              }
            },
            "customSecurityAssessment": {
              "type": "object",
              "metadata": {
                "description": "Custom security assessment information"
              },
              "value": {
                "name": "[format('custom-security-assessment-{0}', uniqueString(parameters('subscriptionId')))]",
                "displayName": "[reference('customSecurityAssessments').displayName]",
                "severity": "[reference('customSecurityAssessments').severity]",
                "resourceId": "[subscriptionResourceId('Microsoft.Security/assessmentMetadata', format('custom-security-assessment-{0}', uniqueString(parameters('subscriptionId'))))]"
              }
            },
            "securityCenterConfig": {
              "type": "object",
              "metadata": {
                "description": "Security Center configuration summary"
              },
              "value": {
                "subscriptionId": "[parameters('subscriptionId')]",
                "defenderPlansEnabled": "[parameters('enableDefenderPlans')]",
                "defenderPlansCount": "[length(parameters('defenderPlans'))]",
                "securityContactsCount": "[length(parameters('securityContacts'))]",
                "logAnalyticsIntegration": "[not(equals(variables('workspaceSettings'), null()))]",
                "autoProvisioningEnabled": "[equals(parameters('autoProvisioningSettings').logAnalytics, 'On')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "logAnalyticsWorkspace"
      ]
    },
    "applicationGatewayPublicIp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "application-gateway-public-ip-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "publicIpName": {
            "value": "[replace(reference('namingConventions').outputs.namingConvention.value.publicIp, '{purpose}', 'agw')]"
          },
          "sku": {
            "value": "Standard"
          },
          "allocationMethod": {
            "value": "Static"
          },
          "domainNameLabel": {
            "value": "[format('{0}-{1}-{2}-agw', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'))]"
          },
          "zones": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', createArray('1', '2', '3')), createObject('value', createArray('1')))]",
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11804307479146407211"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "publicIpName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public IP address"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "The SKU of the public IP address"
              }
            },
            "allocationMethod": {
              "type": "string",
              "defaultValue": "Static",
              "allowedValues": [
                "Static",
                "Dynamic"
              ],
              "metadata": {
                "description": "The allocation method for the public IP address"
              }
            },
            "ipVersion": {
              "type": "string",
              "defaultValue": "IPv4",
              "allowedValues": [
                "IPv4",
                "IPv6"
              ],
              "metadata": {
                "description": "The IP version for the public IP address"
              }
            },
            "idleTimeoutInMinutes": {
              "type": "int",
              "defaultValue": 4,
              "minValue": 4,
              "maxValue": 30,
              "metadata": {
                "description": "The idle timeout in minutes"
              }
            },
            "domainNameLabel": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The domain name label for the public IP address"
              }
            },
            "zones": {
              "type": "array",
              "defaultValue": [
                "1",
                "2",
                "3"
              ],
              "metadata": {
                "description": "Availability zones for the public IP address (Standard SKU only)"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to the public IP address"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the public IP address"
              }
            }
          },
          "resources": {
            "publicIpAddress": {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-09-01",
              "name": "[parameters('publicIpName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "Regional"
              },
              "zones": "[if(equals(parameters('sku'), 'Standard'), parameters('zones'), null())]",
              "properties": {
                "publicIPAllocationMethod": "[parameters('allocationMethod')]",
                "publicIPAddressVersion": "[parameters('ipVersion')]",
                "idleTimeoutInMinutes": "[parameters('idleTimeoutInMinutes')]",
                "dnsSettings": "[if(not(equals(parameters('domainNameLabel'), null())), createObject('domainNameLabel', parameters('domainNameLabel')), null())]"
              }
            }
          },
          "outputs": {
            "publicIpAddressId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the public IP address"
              },
              "value": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName'))]"
            },
            "publicIpAddressName": {
              "type": "string",
              "metadata": {
                "description": "The name of the public IP address"
              },
              "value": "[parameters('publicIpName')]"
            },
            "ipAddress": {
              "type": "string",
              "metadata": {
                "description": "The IP address value"
              },
              "value": "[reference('publicIpAddress').ipAddress]"
            },
            "fqdn": {
              "type": "string",
              "metadata": {
                "description": "The FQDN of the public IP address"
              },
              "value": "[if(not(equals(parameters('domainNameLabel'), null())), reference('publicIpAddress').dnsSettings.fqdn, '')]"
            },
            "publicIpConfig": {
              "type": "object",
              "metadata": {
                "description": "The public IP address configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIpName'))]",
                "name": "[parameters('publicIpName')]",
                "ipAddress": "[reference('publicIpAddress').ipAddress]",
                "allocationMethod": "[parameters('allocationMethod')]",
                "sku": "[parameters('sku')]",
                "zones": "[if(equals(parameters('sku'), 'Standard'), parameters('zones'), createArray())]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions"
      ]
    },
    "webTierAvailabilitySet": {
      "condition": "[not(parameters('environmentConfig').enableHighAvailability)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "web-tier-availability-set-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "availabilitySetName": {
            "value": "[format('{0}-web', reference('namingConventions').outputs.namingConvention.value.availabilitySet)]"
          },
          "tier": {
            "value": "web"
          },
          "faultDomainCount": {
            "value": 2
          },
          "updateDomainCount": {
            "value": 5
          },
          "useManagedDisks": {
            "value": true
          },
          "createProximityPlacementGroup": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1046012305258000164"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "availabilitySetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "web",
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this availability set (web, business, or data)"
              }
            },
            "faultDomainCount": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 3,
              "metadata": {
                "description": "Number of fault domains"
              }
            },
            "updateDomainCount": {
              "type": "int",
              "defaultValue": 5,
              "minValue": 1,
              "maxValue": 20,
              "metadata": {
                "description": "Number of update domains"
              }
            },
            "useManagedDisks": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Use managed disks (recommended)"
              }
            },
            "createProximityPlacementGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Create proximity placement group for low latency"
              }
            },
            "proximityPlacementGroupType": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Standard",
                "Ultra"
              ],
              "metadata": {
                "description": "Proximity placement group type"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the availability set"
              }
            }
          },
          "resources": {
            "proximityPlacementGroup": {
              "condition": "[parameters('createProximityPlacementGroup')]",
              "type": "Microsoft.Compute/proximityPlacementGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-ppg', parameters('availabilitySetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "proximityPlacementGroupType": "[parameters('proximityPlacementGroupType')]"
              }
            },
            "availabilitySet": {
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2023-09-01",
              "name": "[parameters('availabilitySetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[if(parameters('useManagedDisks'), 'Aligned', 'Classic')]"
              },
              "properties": {
                "platformFaultDomainCount": "[parameters('faultDomainCount')]",
                "platformUpdateDomainCount": "[parameters('updateDomainCount')]",
                "proximityPlacementGroup": "[if(parameters('createProximityPlacementGroup'), createObject('id', resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName')))), null())]"
              },
              "dependsOn": [
                "proximityPlacementGroup"
              ]
            }
          },
          "outputs": {
            "availabilitySetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the availability set"
              },
              "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]"
            },
            "availabilitySetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set"
              },
              "value": "[parameters('availabilitySetName')]"
            },
            "proximityPlacementGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the proximity placement group (if created)"
              },
              "value": "[if(parameters('createProximityPlacementGroup'), resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName'))), '')]"
            },
            "availabilitySetConfig": {
              "type": "object",
              "metadata": {
                "description": "The availability set configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]",
                "name": "[parameters('availabilitySetName')]",
                "tier": "[parameters('tier')]",
                "faultDomainCount": "[parameters('faultDomainCount')]",
                "updateDomainCount": "[parameters('updateDomainCount')]",
                "useManagedDisks": "[parameters('useManagedDisks')]",
                "proximityPlacementGroupEnabled": "[parameters('createProximityPlacementGroup')]",
                "proximityPlacementGroupId": "[if(parameters('createProximityPlacementGroup'), resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName'))), '')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions"
      ]
    },
    "businessTierAvailabilitySet": {
      "condition": "[not(parameters('environmentConfig').enableHighAvailability)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "business-tier-availability-set-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "availabilitySetName": {
            "value": "[format('{0}-business', reference('namingConventions').outputs.namingConvention.value.availabilitySet)]"
          },
          "tier": {
            "value": "business"
          },
          "faultDomainCount": {
            "value": 2
          },
          "updateDomainCount": {
            "value": 5
          },
          "useManagedDisks": {
            "value": true
          },
          "createProximityPlacementGroup": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "1046012305258000164"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "availabilitySetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "web",
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this availability set (web, business, or data)"
              }
            },
            "faultDomainCount": {
              "type": "int",
              "defaultValue": 3,
              "minValue": 1,
              "maxValue": 3,
              "metadata": {
                "description": "Number of fault domains"
              }
            },
            "updateDomainCount": {
              "type": "int",
              "defaultValue": 5,
              "minValue": 1,
              "maxValue": 20,
              "metadata": {
                "description": "Number of update domains"
              }
            },
            "useManagedDisks": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Use managed disks (recommended)"
              }
            },
            "createProximityPlacementGroup": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Create proximity placement group for low latency"
              }
            },
            "proximityPlacementGroupType": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Standard",
                "Ultra"
              ],
              "metadata": {
                "description": "Proximity placement group type"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the availability set"
              }
            }
          },
          "resources": {
            "proximityPlacementGroup": {
              "condition": "[parameters('createProximityPlacementGroup')]",
              "type": "Microsoft.Compute/proximityPlacementGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-ppg', parameters('availabilitySetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "proximityPlacementGroupType": "[parameters('proximityPlacementGroupType')]"
              }
            },
            "availabilitySet": {
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2023-09-01",
              "name": "[parameters('availabilitySetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[if(parameters('useManagedDisks'), 'Aligned', 'Classic')]"
              },
              "properties": {
                "platformFaultDomainCount": "[parameters('faultDomainCount')]",
                "platformUpdateDomainCount": "[parameters('updateDomainCount')]",
                "proximityPlacementGroup": "[if(parameters('createProximityPlacementGroup'), createObject('id', resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName')))), null())]"
              },
              "dependsOn": [
                "proximityPlacementGroup"
              ]
            }
          },
          "outputs": {
            "availabilitySetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the availability set"
              },
              "value": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]"
            },
            "availabilitySetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the availability set"
              },
              "value": "[parameters('availabilitySetName')]"
            },
            "proximityPlacementGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the proximity placement group (if created)"
              },
              "value": "[if(parameters('createProximityPlacementGroup'), resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName'))), '')]"
            },
            "availabilitySetConfig": {
              "type": "object",
              "metadata": {
                "description": "The availability set configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Compute/availabilitySets', parameters('availabilitySetName'))]",
                "name": "[parameters('availabilitySetName')]",
                "tier": "[parameters('tier')]",
                "faultDomainCount": "[parameters('faultDomainCount')]",
                "updateDomainCount": "[parameters('updateDomainCount')]",
                "useManagedDisks": "[parameters('useManagedDisks')]",
                "proximityPlacementGroupEnabled": "[parameters('createProximityPlacementGroup')]",
                "proximityPlacementGroupId": "[if(parameters('createProximityPlacementGroup'), resourceId('Microsoft.Compute/proximityPlacementGroups', format('{0}-ppg', parameters('availabilitySetName'))), '')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions"
      ]
    },
    "businessTierLoadBalancer": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "business-tier-load-balancer-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "loadBalancerName": {
            "value": "[reference('namingConventions').outputs.loadBalancerNames.value.business]"
          },
          "sku": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', 'Basic'), createObject('value', 'Standard'))]",
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.businessTier]"
          },
          "privateIpAllocationMethod": {
            "value": "Dynamic"
          },
          "tier": {
            "value": "business"
          },
          "backendAddressPools": {
            "value": [
              {
                "name": "business-tier-pool"
              }
            ]
          },
          "loadBalancingRules": {
            "value": [
              {
                "name": "business-tier-http-rule",
                "frontendPort": 80,
                "backendPort": 80,
                "protocol": "Tcp",
                "enableFloatingIp": false,
                "idleTimeoutInMinutes": 4,
                "loadDistribution": "Default",
                "probeName": "business-tier-http-probe"
              },
              {
                "name": "business-tier-https-rule",
                "frontendPort": 443,
                "backendPort": 443,
                "protocol": "Tcp",
                "enableFloatingIp": false,
                "idleTimeoutInMinutes": 4,
                "loadDistribution": "Default",
                "probeName": "business-tier-https-probe"
              }
            ]
          },
          "healthProbes": {
            "value": [
              {
                "name": "business-tier-http-probe",
                "protocol": "Http",
                "port": 80,
                "requestPath": "/health",
                "intervalInSeconds": 15,
                "numberOfProbes": 2
              },
              {
                "name": "business-tier-https-probe",
                "protocol": "Https",
                "port": 443,
                "requestPath": "/health",
                "intervalInSeconds": 15,
                "numberOfProbes": 2
              }
            ]
          },
          "zones": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', createArray('1', '2', '3')), createObject('value', createArray('1')))]",
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7337058811136690504"
            }
          },
          "definitions": {
            "LoadBalancerConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Load balancer name"
                  }
                },
                "sku": {
                  "type": "string",
                  "allowedValues": [
                    "Basic",
                    "Standard"
                  ],
                  "metadata": {
                    "description": "Load balancer SKU"
                  }
                },
                "frontendIpConfiguration": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "nullable": true
                    },
                    "privateIpAllocationMethod": {
                      "type": "string",
                      "allowedValues": [
                        "Dynamic",
                        "Static"
                      ]
                    },
                    "subnetId": {
                      "type": "string",
                      "nullable": true
                    },
                    "publicIpAddressId": {
                      "type": "string",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "Frontend IP configuration"
                  }
                },
                "backendAddressPools": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      }
                    }
                  },
                  "metadata": {
                    "description": "Backend address pools"
                  }
                },
                "loadBalancingRules": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "frontendPort": {
                        "type": "int"
                      },
                      "backendPort": {
                        "type": "int"
                      },
                      "protocol": {
                        "type": "string",
                        "allowedValues": [
                          "Tcp",
                          "Udp"
                        ]
                      },
                      "enableFloatingIp": {
                        "type": "bool"
                      },
                      "idleTimeoutInMinutes": {
                        "type": "int"
                      },
                      "loadDistribution": {
                        "type": "string",
                        "allowedValues": [
                          "Default",
                          "SourceIP",
                          "SourceIPProtocol"
                        ]
                      }
                    }
                  },
                  "metadata": {
                    "description": "Load balancing rules"
                  }
                },
                "probes": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "protocol": {
                        "type": "string",
                        "allowedValues": [
                          "Http",
                          "Https",
                          "Tcp"
                        ]
                      },
                      "port": {
                        "type": "int"
                      },
                      "requestPath": {
                        "type": "string",
                        "nullable": true
                      },
                      "intervalInSeconds": {
                        "type": "int"
                      },
                      "numberOfProbes": {
                        "type": "int"
                      }
                    }
                  },
                  "metadata": {
                    "description": "Health probes"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "loadBalancerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the load balancer"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "The SKU of the load balancer"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID for the load balancer frontend IP"
              }
            },
            "privateIpAddress": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The private IP address for the load balancer (optional, will use dynamic if not specified)"
              }
            },
            "privateIpAllocationMethod": {
              "type": "string",
              "defaultValue": "Dynamic",
              "allowedValues": [
                "Static",
                "Dynamic"
              ],
              "metadata": {
                "description": "The private IP allocation method"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this load balancer (business or data)"
              }
            },
            "backendAddressPools": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-pool', parameters('tier'))]"
                }
              ],
              "metadata": {
                "description": "Backend address pool configurations"
              }
            },
            "loadBalancingRules": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-http-rule', parameters('tier'))]",
                  "frontendPort": 80,
                  "backendPort": 80,
                  "protocol": "Tcp",
                  "enableFloatingIp": false,
                  "idleTimeoutInMinutes": 4,
                  "loadDistribution": "Default",
                  "probeName": "[format('{0}-tier-http-probe', parameters('tier'))]"
                },
                {
                  "name": "[format('{0}-tier-https-rule', parameters('tier'))]",
                  "frontendPort": 443,
                  "backendPort": 443,
                  "protocol": "Tcp",
                  "enableFloatingIp": false,
                  "idleTimeoutInMinutes": 4,
                  "loadDistribution": "Default",
                  "probeName": "[format('{0}-tier-https-probe', parameters('tier'))]"
                }
              ],
              "metadata": {
                "description": "Load balancing rules configurations"
              }
            },
            "healthProbes": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-http-probe', parameters('tier'))]",
                  "protocol": "Http",
                  "port": 80,
                  "requestPath": "/health",
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                },
                {
                  "name": "[format('{0}-tier-https-probe', parameters('tier'))]",
                  "protocol": "Https",
                  "port": 443,
                  "requestPath": "/health",
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                },
                {
                  "name": "[format('{0}-tier-tcp-probe', parameters('tier'))]",
                  "protocol": "Tcp",
                  "port": 1433,
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                }
              ],
              "metadata": {
                "description": "Health probe configurations"
              }
            },
            "inboundNatRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Inbound NAT rules configurations (optional)"
              }
            },
            "outboundRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Outbound rules configurations (optional)"
              }
            },
            "enableTcpReset": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable TCP reset for idle timeout"
              }
            },
            "enableFloatingIp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable floating IP for SQL Always On scenarios"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the load balancer"
              }
            },
            "zones": {
              "type": "array",
              "defaultValue": [
                "1",
                "2",
                "3"
              ],
              "metadata": {
                "description": "Availability zones for the load balancer (Standard SKU only)"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "backendAddressPoolsCollection",
                "count": "[length(parameters('backendAddressPools'))]",
                "input": {
                  "name": "[parameters('backendAddressPools')[copyIndex('backendAddressPoolsCollection')].name]",
                  "properties": {}
                }
              },
              {
                "name": "probesCollection",
                "count": "[length(parameters('healthProbes'))]",
                "input": {
                  "name": "[parameters('healthProbes')[copyIndex('probesCollection')].name]",
                  "properties": {
                    "protocol": "[parameters('healthProbes')[copyIndex('probesCollection')].protocol]",
                    "port": "[parameters('healthProbes')[copyIndex('probesCollection')].port]",
                    "requestPath": "[if(or(equals(parameters('healthProbes')[copyIndex('probesCollection')].protocol, 'Http'), equals(parameters('healthProbes')[copyIndex('probesCollection')].protocol, 'Https')), parameters('healthProbes')[copyIndex('probesCollection')].requestPath, null())]",
                    "intervalInSeconds": "[parameters('healthProbes')[copyIndex('probesCollection')].intervalInSeconds]",
                    "numberOfProbes": "[parameters('healthProbes')[copyIndex('probesCollection')].numberOfProbes]"
                  }
                }
              },
              {
                "name": "loadBalancingRulesCollection",
                "count": "[length(parameters('loadBalancingRules'))]",
                "input": {
                  "name": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                    },
                    "backendAddressPool": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), parameters('backendAddressPools')[0].name)]"
                    },
                    "probe": "[if(contains(parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')], 'probeName'), createObject('id', resourceId('Microsoft.Network/loadBalancers/probes', parameters('loadBalancerName'), parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].probeName)), null())]",
                    "protocol": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].protocol]",
                    "frontendPort": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].frontendPort]",
                    "backendPort": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].backendPort]",
                    "enableFloatingIP": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].enableFloatingIp]",
                    "idleTimeoutInMinutes": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].idleTimeoutInMinutes]",
                    "loadDistribution": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].loadDistribution]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              },
              {
                "name": "inboundNatRulesCollection",
                "count": "[length(parameters('inboundNatRules'))]",
                "input": {
                  "name": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                    },
                    "protocol": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].protocol]",
                    "frontendPort": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].frontendPort]",
                    "backendPort": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].backendPort]",
                    "enableFloatingIP": "[parameters('enableFloatingIp')]",
                    "idleTimeoutInMinutes": "[if(contains(parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')], 'idleTimeoutInMinutes'), parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].idleTimeoutInMinutes, 4)]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              },
              {
                "name": "outboundRulesCollection",
                "count": "[length(parameters('outboundRules'))]",
                "input": {
                  "name": "[parameters('outboundRules')[copyIndex('outboundRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfigurations": [
                      {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                      }
                    ],
                    "backendAddressPool": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), parameters('backendAddressPools')[0].name)]"
                    },
                    "protocol": "[parameters('outboundRules')[copyIndex('outboundRulesCollection')].protocol]",
                    "allocatedOutboundPorts": "[if(contains(parameters('outboundRules')[copyIndex('outboundRulesCollection')], 'allocatedOutboundPorts'), parameters('outboundRules')[copyIndex('outboundRulesCollection')].allocatedOutboundPorts, 1024)]",
                    "idleTimeoutInMinutes": "[if(contains(parameters('outboundRules')[copyIndex('outboundRulesCollection')], 'idleTimeoutInMinutes'), parameters('outboundRules')[copyIndex('outboundRulesCollection')].idleTimeoutInMinutes, 4)]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              }
            ],
            "frontendIpConfigurationName": "[format('{0}-tier-frontend-ip', parameters('tier'))]",
            "frontendIpConfigurations": [
              {
                "name": "[variables('frontendIpConfigurationName')]",
                "properties": {
                  "subnet": {
                    "id": "[parameters('subnetId')]"
                  },
                  "privateIPAddress": "[parameters('privateIpAddress')]",
                  "privateIPAllocationMethod": "[parameters('privateIpAllocationMethod')]"
                }
              }
            ]
          },
          "resources": {
            "loadBalancer": {
              "type": "Microsoft.Network/loadBalancers",
              "apiVersion": "2023-09-01",
              "name": "[parameters('loadBalancerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "Regional"
              },
              "zones": "[if(equals(parameters('sku'), 'Standard'), parameters('zones'), null())]",
              "properties": {
                "frontendIPConfigurations": "[variables('frontendIpConfigurations')]",
                "backendAddressPools": "[variables('backendAddressPoolsCollection')]",
                "loadBalancingRules": "[variables('loadBalancingRulesCollection')]",
                "probes": "[variables('probesCollection')]",
                "inboundNatRules": "[variables('inboundNatRulesCollection')]",
                "outboundRules": "[if(equals(parameters('sku'), 'Standard'), variables('outboundRulesCollection'), createArray())]"
              }
            }
          },
          "outputs": {
            "loadBalancerId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the load balancer"
              },
              "value": "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName'))]"
            },
            "loadBalancerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the load balancer"
              },
              "value": "[parameters('loadBalancerName')]"
            },
            "privateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "The private IP address of the load balancer"
              },
              "value": "[reference('loadBalancer').frontendIPConfigurations[0].properties.privateIPAddress]"
            },
            "frontendIpConfigurationId": {
              "type": "string",
              "metadata": {
                "description": "The frontend IP configuration resource ID"
              },
              "value": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
            },
            "backendAddressPoolIds": {
              "type": "object",
              "metadata": {
                "description": "The backend address pool resource IDs"
              },
              "value": "[reduce(parameters('backendAddressPools'), createObject(), lambda('cur', 'pool', union(lambdaVariables('cur'), createObject(format('{0}', lambdaVariables('pool').name), resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), lambdaVariables('pool').name)))))]"
            },
            "healthProbeIds": {
              "type": "object",
              "metadata": {
                "description": "The health probe resource IDs"
              },
              "value": "[reduce(parameters('healthProbes'), createObject(), lambda('cur', 'probe', union(lambdaVariables('cur'), createObject(format('{0}', lambdaVariables('probe').name), resourceId('Microsoft.Network/loadBalancers/probes', parameters('loadBalancerName'), lambdaVariables('probe').name)))))]"
            },
            "loadBalancerConfig": {
              "type": "object",
              "metadata": {
                "description": "The load balancer configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName'))]",
                "name": "[parameters('loadBalancerName')]",
                "sku": "[parameters('sku')]",
                "tier": "[parameters('tier')]",
                "privateIpAddress": "[reference('loadBalancer').frontendIPConfigurations[0].properties.privateIPAddress]",
                "backendPools": "[map(parameters('backendAddressPools'), lambda('pool', lambdaVariables('pool').name))]",
                "healthProbes": "[map(parameters('healthProbes'), lambda('probe', lambdaVariables('probe').name))]",
                "loadBalancingRules": "[map(parameters('loadBalancingRules'), lambda('rule', lambdaVariables('rule').name))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "dataTierLoadBalancer": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "data-tier-load-balancer-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "loadBalancerName": {
            "value": "[reference('namingConventions').outputs.loadBalancerNames.value.data]"
          },
          "sku": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', 'Basic'), createObject('value', 'Standard'))]",
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.dataTier]"
          },
          "privateIpAllocationMethod": {
            "value": "Dynamic"
          },
          "tier": {
            "value": "data"
          },
          "backendAddressPools": {
            "value": [
              {
                "name": "data-tier-pool"
              }
            ]
          },
          "loadBalancingRules": {
            "value": [
              {
                "name": "data-tier-sql-rule",
                "frontendPort": 1433,
                "backendPort": 1433,
                "protocol": "Tcp",
                "enableFloatingIp": false,
                "idleTimeoutInMinutes": 4,
                "loadDistribution": "Default",
                "probeName": "data-tier-tcp-probe"
              }
            ]
          },
          "healthProbes": {
            "value": [
              {
                "name": "data-tier-tcp-probe",
                "protocol": "Tcp",
                "port": 1433,
                "intervalInSeconds": 15,
                "numberOfProbes": 2
              }
            ]
          },
          "zones": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', createArray('1', '2', '3')), createObject('value', createArray('1')))]",
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7337058811136690504"
            }
          },
          "definitions": {
            "LoadBalancerConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "metadata": {
                    "description": "Load balancer name"
                  }
                },
                "sku": {
                  "type": "string",
                  "allowedValues": [
                    "Basic",
                    "Standard"
                  ],
                  "metadata": {
                    "description": "Load balancer SKU"
                  }
                },
                "frontendIpConfiguration": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string"
                    },
                    "privateIpAddress": {
                      "type": "string",
                      "nullable": true
                    },
                    "privateIpAllocationMethod": {
                      "type": "string",
                      "allowedValues": [
                        "Dynamic",
                        "Static"
                      ]
                    },
                    "subnetId": {
                      "type": "string",
                      "nullable": true
                    },
                    "publicIpAddressId": {
                      "type": "string",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "Frontend IP configuration"
                  }
                },
                "backendAddressPools": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      }
                    }
                  },
                  "metadata": {
                    "description": "Backend address pools"
                  }
                },
                "loadBalancingRules": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "frontendPort": {
                        "type": "int"
                      },
                      "backendPort": {
                        "type": "int"
                      },
                      "protocol": {
                        "type": "string",
                        "allowedValues": [
                          "Tcp",
                          "Udp"
                        ]
                      },
                      "enableFloatingIp": {
                        "type": "bool"
                      },
                      "idleTimeoutInMinutes": {
                        "type": "int"
                      },
                      "loadDistribution": {
                        "type": "string",
                        "allowedValues": [
                          "Default",
                          "SourceIP",
                          "SourceIPProtocol"
                        ]
                      }
                    }
                  },
                  "metadata": {
                    "description": "Load balancing rules"
                  }
                },
                "probes": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "type": "string"
                      },
                      "protocol": {
                        "type": "string",
                        "allowedValues": [
                          "Http",
                          "Https",
                          "Tcp"
                        ]
                      },
                      "port": {
                        "type": "int"
                      },
                      "requestPath": {
                        "type": "string",
                        "nullable": true
                      },
                      "intervalInSeconds": {
                        "type": "int"
                      },
                      "numberOfProbes": {
                        "type": "int"
                      }
                    }
                  },
                  "metadata": {
                    "description": "Health probes"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "loadBalancerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the load balancer"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Basic",
                "Standard"
              ],
              "metadata": {
                "description": "The SKU of the load balancer"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID for the load balancer frontend IP"
              }
            },
            "privateIpAddress": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "The private IP address for the load balancer (optional, will use dynamic if not specified)"
              }
            },
            "privateIpAllocationMethod": {
              "type": "string",
              "defaultValue": "Dynamic",
              "allowedValues": [
                "Static",
                "Dynamic"
              ],
              "metadata": {
                "description": "The private IP allocation method"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this load balancer (business or data)"
              }
            },
            "backendAddressPools": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-pool', parameters('tier'))]"
                }
              ],
              "metadata": {
                "description": "Backend address pool configurations"
              }
            },
            "loadBalancingRules": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-http-rule', parameters('tier'))]",
                  "frontendPort": 80,
                  "backendPort": 80,
                  "protocol": "Tcp",
                  "enableFloatingIp": false,
                  "idleTimeoutInMinutes": 4,
                  "loadDistribution": "Default",
                  "probeName": "[format('{0}-tier-http-probe', parameters('tier'))]"
                },
                {
                  "name": "[format('{0}-tier-https-rule', parameters('tier'))]",
                  "frontendPort": 443,
                  "backendPort": 443,
                  "protocol": "Tcp",
                  "enableFloatingIp": false,
                  "idleTimeoutInMinutes": 4,
                  "loadDistribution": "Default",
                  "probeName": "[format('{0}-tier-https-probe', parameters('tier'))]"
                }
              ],
              "metadata": {
                "description": "Load balancing rules configurations"
              }
            },
            "healthProbes": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "[format('{0}-tier-http-probe', parameters('tier'))]",
                  "protocol": "Http",
                  "port": 80,
                  "requestPath": "/health",
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                },
                {
                  "name": "[format('{0}-tier-https-probe', parameters('tier'))]",
                  "protocol": "Https",
                  "port": 443,
                  "requestPath": "/health",
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                },
                {
                  "name": "[format('{0}-tier-tcp-probe', parameters('tier'))]",
                  "protocol": "Tcp",
                  "port": 1433,
                  "intervalInSeconds": 15,
                  "numberOfProbes": 2
                }
              ],
              "metadata": {
                "description": "Health probe configurations"
              }
            },
            "inboundNatRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Inbound NAT rules configurations (optional)"
              }
            },
            "outboundRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Outbound rules configurations (optional)"
              }
            },
            "enableTcpReset": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable TCP reset for idle timeout"
              }
            },
            "enableFloatingIp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable floating IP for SQL Always On scenarios"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the load balancer"
              }
            },
            "zones": {
              "type": "array",
              "defaultValue": [
                "1",
                "2",
                "3"
              ],
              "metadata": {
                "description": "Availability zones for the load balancer (Standard SKU only)"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "backendAddressPoolsCollection",
                "count": "[length(parameters('backendAddressPools'))]",
                "input": {
                  "name": "[parameters('backendAddressPools')[copyIndex('backendAddressPoolsCollection')].name]",
                  "properties": {}
                }
              },
              {
                "name": "probesCollection",
                "count": "[length(parameters('healthProbes'))]",
                "input": {
                  "name": "[parameters('healthProbes')[copyIndex('probesCollection')].name]",
                  "properties": {
                    "protocol": "[parameters('healthProbes')[copyIndex('probesCollection')].protocol]",
                    "port": "[parameters('healthProbes')[copyIndex('probesCollection')].port]",
                    "requestPath": "[if(or(equals(parameters('healthProbes')[copyIndex('probesCollection')].protocol, 'Http'), equals(parameters('healthProbes')[copyIndex('probesCollection')].protocol, 'Https')), parameters('healthProbes')[copyIndex('probesCollection')].requestPath, null())]",
                    "intervalInSeconds": "[parameters('healthProbes')[copyIndex('probesCollection')].intervalInSeconds]",
                    "numberOfProbes": "[parameters('healthProbes')[copyIndex('probesCollection')].numberOfProbes]"
                  }
                }
              },
              {
                "name": "loadBalancingRulesCollection",
                "count": "[length(parameters('loadBalancingRules'))]",
                "input": {
                  "name": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                    },
                    "backendAddressPool": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), parameters('backendAddressPools')[0].name)]"
                    },
                    "probe": "[if(contains(parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')], 'probeName'), createObject('id', resourceId('Microsoft.Network/loadBalancers/probes', parameters('loadBalancerName'), parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].probeName)), null())]",
                    "protocol": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].protocol]",
                    "frontendPort": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].frontendPort]",
                    "backendPort": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].backendPort]",
                    "enableFloatingIP": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].enableFloatingIp]",
                    "idleTimeoutInMinutes": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].idleTimeoutInMinutes]",
                    "loadDistribution": "[parameters('loadBalancingRules')[copyIndex('loadBalancingRulesCollection')].loadDistribution]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              },
              {
                "name": "inboundNatRulesCollection",
                "count": "[length(parameters('inboundNatRules'))]",
                "input": {
                  "name": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                    },
                    "protocol": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].protocol]",
                    "frontendPort": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].frontendPort]",
                    "backendPort": "[parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].backendPort]",
                    "enableFloatingIP": "[parameters('enableFloatingIp')]",
                    "idleTimeoutInMinutes": "[if(contains(parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')], 'idleTimeoutInMinutes'), parameters('inboundNatRules')[copyIndex('inboundNatRulesCollection')].idleTimeoutInMinutes, 4)]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              },
              {
                "name": "outboundRulesCollection",
                "count": "[length(parameters('outboundRules'))]",
                "input": {
                  "name": "[parameters('outboundRules')[copyIndex('outboundRulesCollection')].name]",
                  "properties": {
                    "frontendIPConfigurations": [
                      {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
                      }
                    ],
                    "backendAddressPool": {
                      "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), parameters('backendAddressPools')[0].name)]"
                    },
                    "protocol": "[parameters('outboundRules')[copyIndex('outboundRulesCollection')].protocol]",
                    "allocatedOutboundPorts": "[if(contains(parameters('outboundRules')[copyIndex('outboundRulesCollection')], 'allocatedOutboundPorts'), parameters('outboundRules')[copyIndex('outboundRulesCollection')].allocatedOutboundPorts, 1024)]",
                    "idleTimeoutInMinutes": "[if(contains(parameters('outboundRules')[copyIndex('outboundRulesCollection')], 'idleTimeoutInMinutes'), parameters('outboundRules')[copyIndex('outboundRulesCollection')].idleTimeoutInMinutes, 4)]",
                    "enableTcpReset": "[parameters('enableTcpReset')]"
                  }
                }
              }
            ],
            "frontendIpConfigurationName": "[format('{0}-tier-frontend-ip', parameters('tier'))]",
            "frontendIpConfigurations": [
              {
                "name": "[variables('frontendIpConfigurationName')]",
                "properties": {
                  "subnet": {
                    "id": "[parameters('subnetId')]"
                  },
                  "privateIPAddress": "[parameters('privateIpAddress')]",
                  "privateIPAllocationMethod": "[parameters('privateIpAllocationMethod')]"
                }
              }
            ]
          },
          "resources": {
            "loadBalancer": {
              "type": "Microsoft.Network/loadBalancers",
              "apiVersion": "2023-09-01",
              "name": "[parameters('loadBalancerName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "Regional"
              },
              "zones": "[if(equals(parameters('sku'), 'Standard'), parameters('zones'), null())]",
              "properties": {
                "frontendIPConfigurations": "[variables('frontendIpConfigurations')]",
                "backendAddressPools": "[variables('backendAddressPoolsCollection')]",
                "loadBalancingRules": "[variables('loadBalancingRulesCollection')]",
                "probes": "[variables('probesCollection')]",
                "inboundNatRules": "[variables('inboundNatRulesCollection')]",
                "outboundRules": "[if(equals(parameters('sku'), 'Standard'), variables('outboundRulesCollection'), createArray())]"
              }
            }
          },
          "outputs": {
            "loadBalancerId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the load balancer"
              },
              "value": "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName'))]"
            },
            "loadBalancerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the load balancer"
              },
              "value": "[parameters('loadBalancerName')]"
            },
            "privateIpAddress": {
              "type": "string",
              "metadata": {
                "description": "The private IP address of the load balancer"
              },
              "value": "[reference('loadBalancer').frontendIPConfigurations[0].properties.privateIPAddress]"
            },
            "frontendIpConfigurationId": {
              "type": "string",
              "metadata": {
                "description": "The frontend IP configuration resource ID"
              },
              "value": "[resourceId('Microsoft.Network/loadBalancers/frontendIPConfigurations', parameters('loadBalancerName'), variables('frontendIpConfigurationName'))]"
            },
            "backendAddressPoolIds": {
              "type": "object",
              "metadata": {
                "description": "The backend address pool resource IDs"
              },
              "value": "[reduce(parameters('backendAddressPools'), createObject(), lambda('cur', 'pool', union(lambdaVariables('cur'), createObject(format('{0}', lambdaVariables('pool').name), resourceId('Microsoft.Network/loadBalancers/backendAddressPools', parameters('loadBalancerName'), lambdaVariables('pool').name)))))]"
            },
            "healthProbeIds": {
              "type": "object",
              "metadata": {
                "description": "The health probe resource IDs"
              },
              "value": "[reduce(parameters('healthProbes'), createObject(), lambda('cur', 'probe', union(lambdaVariables('cur'), createObject(format('{0}', lambdaVariables('probe').name), resourceId('Microsoft.Network/loadBalancers/probes', parameters('loadBalancerName'), lambdaVariables('probe').name)))))]"
            },
            "loadBalancerConfig": {
              "type": "object",
              "metadata": {
                "description": "The load balancer configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Network/loadBalancers', parameters('loadBalancerName'))]",
                "name": "[parameters('loadBalancerName')]",
                "sku": "[parameters('sku')]",
                "tier": "[parameters('tier')]",
                "privateIpAddress": "[reference('loadBalancer').frontendIPConfigurations[0].properties.privateIPAddress]",
                "backendPools": "[map(parameters('backendAddressPools'), lambda('pool', lambdaVariables('pool').name))]",
                "healthProbes": "[map(parameters('healthProbes'), lambda('probe', lambdaVariables('probe').name))]",
                "loadBalancingRules": "[map(parameters('loadBalancingRules'), lambda('rule', lambdaVariables('rule').name))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "applicationGateway": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "application-gateway-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationGatewayName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.applicationGateway]"
          },
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.applicationGateway]"
          },
          "sku": {
            "value": "[parameters('environmentConfig').applicationGatewaySku]"
          },
          "capacity": {
            "value": "[parameters('environmentConfig').applicationGatewayCapacity]"
          },
          "enableAutoscaling": {
            "value": "[parameters('environmentConfig').enableHighAvailability]"
          },
          "minCapacity": {
            "value": 1
          },
          "maxCapacity": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', mul(parameters('environmentConfig').applicationGatewayCapacity, 3)), createObject('value', parameters('environmentConfig').applicationGatewayCapacity))]",
          "publicIpAddressId": {
            "value": "[reference('applicationGatewayPublicIp').outputs.publicIpAddressId.value]"
          },
          "keyVaultId": {
            "value": "[reference('keyVault').outputs.keyVaultId.value]"
          },
          "sslCertificateName": {
            "value": "ssl-certificate"
          },
          "managedIdentityId": {
            "value": "[reference('managedIdentities').outputs.managedIdentityLookup.value.applicationGateway.id]"
          },
          "backendPools": {
            "value": [
              {
                "name": "web-tier-pool",
                "backendAddresses": []
              }
            ]
          },
          "backendHttpSettings": {
            "value": [
              {
                "name": "web-tier-http-settings",
                "port": 80,
                "protocol": "Http",
                "cookieBasedAffinity": "Disabled",
                "requestTimeout": 30,
                "probeName": "web-tier-health-probe"
              },
              {
                "name": "web-tier-https-settings",
                "port": 443,
                "protocol": "Https",
                "cookieBasedAffinity": "Disabled",
                "requestTimeout": 30,
                "probeName": "web-tier-https-health-probe"
              }
            ]
          },
          "healthProbes": {
            "value": [
              {
                "name": "web-tier-health-probe",
                "protocol": "Http",
                "host": "",
                "path": "/health",
                "interval": 30,
                "timeout": 30,
                "unhealthyThreshold": 3,
                "port": 80
              },
              {
                "name": "web-tier-https-health-probe",
                "protocol": "Https",
                "host": "",
                "path": "/health",
                "interval": 30,
                "timeout": 30,
                "unhealthyThreshold": 3,
                "port": 443
              }
            ]
          },
          "httpListeners": {
            "value": [
              {
                "name": "http-listener",
                "frontendIpConfiguration": "public-frontend-ip",
                "frontendPort": "port-80",
                "protocol": "Http"
              },
              {
                "name": "https-listener",
                "frontendIpConfiguration": "public-frontend-ip",
                "frontendPort": "port-443",
                "protocol": "Https",
                "sslCertificate": "ssl-certificate"
              }
            ]
          },
          "requestRoutingRules": {
            "value": [
              {
                "name": "http-routing-rule",
                "ruleType": "Basic",
                "priority": 100,
                "httpListener": "http-listener",
                "backendAddressPool": "web-tier-pool",
                "backendHttpSettings": "web-tier-http-settings"
              },
              {
                "name": "https-routing-rule",
                "ruleType": "Basic",
                "priority": 200,
                "httpListener": "https-listener",
                "backendAddressPool": "web-tier-pool",
                "backendHttpSettings": "web-tier-https-settings"
              }
            ]
          },
          "wafConfiguration": {
            "value": {
              "enabled": "[equals(parameters('environmentConfig').applicationGatewaySku, 'WAF_v2')]",
              "firewallMode": "Prevention",
              "ruleSetType": "OWASP",
              "ruleSetVersion": "3.2",
              "disabledRuleGroups": [],
              "requestBodyCheck": true,
              "maxRequestBodySizeInKb": 128,
              "fileUploadLimitInMb": 100
            }
          },
          "customWafRules": {
            "value": []
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10051587083912574035"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "applicationGatewayName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Gateway"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID for the Application Gateway"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "WAF_v2",
              "allowedValues": [
                "Standard_v2",
                "WAF_v2"
              ],
              "metadata": {
                "description": "The SKU of the Application Gateway"
              }
            },
            "capacity": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 1,
              "maxValue": 125,
              "metadata": {
                "description": "The capacity (instance count) of the Application Gateway"
              }
            },
            "enableAutoscaling": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable autoscaling for the Application Gateway"
              }
            },
            "minCapacity": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 125,
              "metadata": {
                "description": "Minimum autoscale instance count"
              }
            },
            "maxCapacity": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 125,
              "metadata": {
                "description": "Maximum autoscale instance count"
              }
            },
            "publicIpAddressId": {
              "type": "string",
              "metadata": {
                "description": "Public IP address resource ID for the Application Gateway"
              }
            },
            "keyVaultId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Key Vault resource ID for SSL certificates"
              }
            },
            "sslCertificateName": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "SSL certificate name in Key Vault"
              }
            },
            "managedIdentityId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Managed identity resource ID for Key Vault access"
              }
            },
            "backendPools": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "web-tier-pool",
                  "backendAddresses": []
                }
              ],
              "metadata": {
                "description": "Backend pool configurations"
              }
            },
            "backendHttpSettings": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "web-tier-http-settings",
                  "port": 80,
                  "protocol": "Http",
                  "cookieBasedAffinity": "Disabled",
                  "requestTimeout": 30,
                  "probeName": "web-tier-health-probe"
                },
                {
                  "name": "web-tier-https-settings",
                  "port": 443,
                  "protocol": "Https",
                  "cookieBasedAffinity": "Disabled",
                  "requestTimeout": 30,
                  "probeName": "web-tier-https-health-probe"
                }
              ],
              "metadata": {
                "description": "Backend HTTP settings configurations"
              }
            },
            "healthProbes": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "web-tier-health-probe",
                  "protocol": "Http",
                  "host": "",
                  "path": "/health",
                  "interval": 30,
                  "timeout": 30,
                  "unhealthyThreshold": 3,
                  "port": 80
                },
                {
                  "name": "web-tier-https-health-probe",
                  "protocol": "Https",
                  "host": "",
                  "path": "/health",
                  "interval": 30,
                  "timeout": 30,
                  "unhealthyThreshold": 3,
                  "port": 443
                }
              ],
              "metadata": {
                "description": "Health probe configurations"
              }
            },
            "httpListeners": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "http-listener",
                  "frontendIpConfiguration": "public-frontend-ip",
                  "frontendPort": "port-80",
                  "protocol": "Http"
                },
                {
                  "name": "https-listener",
                  "frontendIpConfiguration": "public-frontend-ip",
                  "frontendPort": "port-443",
                  "protocol": "Https",
                  "sslCertificate": "ssl-certificate"
                }
              ],
              "metadata": {
                "description": "HTTP listeners configurations"
              }
            },
            "requestRoutingRules": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "http-routing-rule",
                  "ruleType": "Basic",
                  "priority": 100,
                  "httpListener": "http-listener",
                  "backendAddressPool": "web-tier-pool",
                  "backendHttpSettings": "web-tier-http-settings"
                },
                {
                  "name": "https-routing-rule",
                  "ruleType": "Basic",
                  "priority": 200,
                  "httpListener": "https-listener",
                  "backendAddressPool": "web-tier-pool",
                  "backendHttpSettings": "web-tier-https-settings"
                }
              ],
              "metadata": {
                "description": "Request routing rules configurations"
              }
            },
            "wafConfiguration": {
              "type": "object",
              "defaultValue": {
                "enabled": true,
                "firewallMode": "Prevention",
                "ruleSetType": "OWASP",
                "ruleSetVersion": "3.2",
                "disabledRuleGroups": [],
                "requestBodyCheck": true,
                "maxRequestBodySizeInKb": 128,
                "fileUploadLimitInMb": 100
              },
              "metadata": {
                "description": "WAF configuration"
              }
            },
            "customWafRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Custom WAF rules"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the Application Gateway"
              }
            },
            "enableHttp2": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable HTTP/2 support"
              }
            },
            "enableWaf": {
              "type": "bool",
              "defaultValue": "[equals(parameters('sku'), 'WAF_v2')]",
              "metadata": {
                "description": "Enable WAF"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "backendAddressPools",
                "count": "[length(parameters('backendPools'))]",
                "input": {
                  "name": "[parameters('backendPools')[copyIndex('backendAddressPools')].name]",
                  "properties": {
                    "backendAddresses": "[parameters('backendPools')[copyIndex('backendAddressPools')].backendAddresses]"
                  }
                }
              },
              {
                "name": "backendHttpSettingsCollection",
                "count": "[length(parameters('backendHttpSettings'))]",
                "input": {
                  "name": "[parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].name]",
                  "properties": {
                    "port": "[parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].port]",
                    "protocol": "[parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].protocol]",
                    "cookieBasedAffinity": "[parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].cookieBasedAffinity]",
                    "requestTimeout": "[parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].requestTimeout]",
                    "probe": "[if(contains(parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')], 'probeName'), createObject('id', resourceId('Microsoft.Network/applicationGateways/probes', parameters('applicationGatewayName'), parameters('backendHttpSettings')[copyIndex('backendHttpSettingsCollection')].probeName)), null())]",
                    "pickHostNameFromBackendAddress": false,
                    "affinityCookieName": "",
                    "trustedRootCertificates": [],
                    "connectionDraining": {
                      "enabled": false,
                      "drainTimeoutInSec": 1
                    }
                  }
                }
              },
              {
                "name": "probes",
                "count": "[length(parameters('healthProbes'))]",
                "input": {
                  "name": "[parameters('healthProbes')[copyIndex('probes')].name]",
                  "properties": {
                    "protocol": "[parameters('healthProbes')[copyIndex('probes')].protocol]",
                    "host": "[if(empty(parameters('healthProbes')[copyIndex('probes')].host), '127.0.0.1', parameters('healthProbes')[copyIndex('probes')].host)]",
                    "path": "[parameters('healthProbes')[copyIndex('probes')].path]",
                    "interval": "[parameters('healthProbes')[copyIndex('probes')].interval]",
                    "timeout": "[parameters('healthProbes')[copyIndex('probes')].timeout]",
                    "unhealthyThreshold": "[parameters('healthProbes')[copyIndex('probes')].unhealthyThreshold]",
                    "port": "[parameters('healthProbes')[copyIndex('probes')].port]",
                    "pickHostNameFromBackendHttpSettings": "[empty(parameters('healthProbes')[copyIndex('probes')].host)]",
                    "minServers": 0,
                    "match": {
                      "statusCodes": [
                        "200-399"
                      ]
                    }
                  }
                }
              },
              {
                "name": "httpListenersCollection",
                "count": "[length(parameters('httpListeners'))]",
                "input": {
                  "name": "[parameters('httpListeners')[copyIndex('httpListenersCollection')].name]",
                  "properties": {
                    "frontendIPConfiguration": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', parameters('applicationGatewayName'), parameters('httpListeners')[copyIndex('httpListenersCollection')].frontendIpConfiguration)]"
                    },
                    "frontendPort": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts', parameters('applicationGatewayName'), parameters('httpListeners')[copyIndex('httpListenersCollection')].frontendPort)]"
                    },
                    "protocol": "[parameters('httpListeners')[copyIndex('httpListenersCollection')].protocol]",
                    "sslCertificate": "[if(and(equals(parameters('httpListeners')[copyIndex('httpListenersCollection')].protocol, 'Https'), contains(parameters('httpListeners')[copyIndex('httpListenersCollection')], 'sslCertificate')), createObject('id', resourceId('Microsoft.Network/applicationGateways/sslCertificates', parameters('applicationGatewayName'), parameters('httpListeners')[copyIndex('httpListenersCollection')].sslCertificate)), null())]",
                    "requireServerNameIndication": "[equals(parameters('httpListeners')[copyIndex('httpListenersCollection')].protocol, 'Https')]"
                  }
                }
              },
              {
                "name": "requestRoutingRulesCollection",
                "count": "[length(parameters('requestRoutingRules'))]",
                "input": {
                  "name": "[parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].name]",
                  "properties": {
                    "ruleType": "[parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].ruleType]",
                    "priority": "[parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].priority]",
                    "httpListener": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/httpListeners', parameters('applicationGatewayName'), parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].httpListener)]"
                    },
                    "backendAddressPool": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', parameters('applicationGatewayName'), parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].backendAddressPool)]"
                    },
                    "backendHttpSettings": {
                      "id": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', parameters('applicationGatewayName'), parameters('requestRoutingRules')[copyIndex('requestRoutingRulesCollection')].backendHttpSettings)]"
                    }
                  }
                }
              }
            ],
            "frontendIpConfigurations": [
              {
                "name": "public-frontend-ip",
                "properties": {
                  "publicIPAddress": {
                    "id": "[parameters('publicIpAddressId')]"
                  }
                }
              }
            ],
            "frontendPorts": [
              {
                "name": "port-80",
                "properties": {
                  "port": 80
                }
              },
              {
                "name": "port-443",
                "properties": {
                  "port": 443
                }
              }
            ],
            "sslCertificates": "[if(and(and(not(equals(parameters('keyVaultId'), null())), not(equals(parameters('sslCertificateName'), null()))), not(equals(parameters('managedIdentityId'), null()))), createArray(createObject('name', 'ssl-certificate', 'properties', createObject('keyVaultSecretId', format('{0}/secrets/{1}', parameters('keyVaultId'), parameters('sslCertificateName'))))), createArray())]",
            "gatewayIpConfigurations": [
              {
                "name": "gateway-ip-configuration",
                "properties": {
                  "subnet": {
                    "id": "[parameters('subnetId')]"
                  }
                }
              }
            ]
          },
          "resources": {
            "applicationGateway": {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2023-09-01",
              "name": "[parameters('applicationGatewayName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": "[if(not(equals(parameters('managedIdentityId'), null())), createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', parameters('managedIdentityId')), createObject())), null())]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]",
                  "tier": "[parameters('sku')]",
                  "capacity": "[if(parameters('enableAutoscaling'), null(), parameters('capacity'))]"
                },
                "autoscaleConfiguration": "[if(parameters('enableAutoscaling'), createObject('minCapacity', parameters('minCapacity'), 'maxCapacity', parameters('maxCapacity')), null())]",
                "gatewayIPConfigurations": "[variables('gatewayIpConfigurations')]",
                "frontendIPConfigurations": "[variables('frontendIpConfigurations')]",
                "frontendPorts": "[variables('frontendPorts')]",
                "sslCertificates": "[variables('sslCertificates')]",
                "backendAddressPools": "[variables('backendAddressPools')]",
                "backendHttpSettingsCollection": "[variables('backendHttpSettingsCollection')]",
                "httpListeners": "[variables('httpListenersCollection')]",
                "requestRoutingRules": "[variables('requestRoutingRulesCollection')]",
                "probes": "[variables('probes')]",
                "webApplicationFirewallConfiguration": "[if(parameters('enableWaf'), createObject('enabled', parameters('wafConfiguration').enabled, 'firewallMode', parameters('wafConfiguration').firewallMode, 'ruleSetType', parameters('wafConfiguration').ruleSetType, 'ruleSetVersion', parameters('wafConfiguration').ruleSetVersion, 'disabledRuleGroups', parameters('wafConfiguration').disabledRuleGroups, 'requestBodyCheck', parameters('wafConfiguration').requestBodyCheck, 'maxRequestBodySizeInKb', parameters('wafConfiguration').maxRequestBodySizeInKb, 'fileUploadLimitInMb', parameters('wafConfiguration').fileUploadLimitInMb), null())]",
                "firewallPolicy": "[if(not(empty(parameters('customWafRules'))), createObject('id', resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', format('{0}-waf-policy', parameters('applicationGatewayName')))), null())]",
                "enableHttp2": "[parameters('enableHttp2')]",
                "forceFirewallPolicyAssociation": "[not(empty(parameters('customWafRules')))]"
              },
              "dependsOn": [
                "wafPolicy"
              ]
            },
            "wafPolicy": {
              "condition": "[not(empty(parameters('customWafRules')))]",
              "type": "Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-waf-policy', parameters('applicationGatewayName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "policySettings": {
                  "requestBodyCheck": "[parameters('wafConfiguration').requestBodyCheck]",
                  "maxRequestBodySizeInKb": "[parameters('wafConfiguration').maxRequestBodySizeInKb]",
                  "fileUploadLimitInMb": "[parameters('wafConfiguration').fileUploadLimitInMb]",
                  "state": "Enabled",
                  "mode": "[parameters('wafConfiguration').firewallMode]"
                },
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "[parameters('wafConfiguration').ruleSetType]",
                      "ruleSetVersion": "[parameters('wafConfiguration').ruleSetVersion]",
                      "ruleGroupOverrides": "[parameters('wafConfiguration').disabledRuleGroups]"
                    }
                  ]
                },
                "customRules": "[parameters('customWafRules')]"
              }
            }
          },
          "outputs": {
            "applicationGatewayId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Application Gateway"
              },
              "value": "[resourceId('Microsoft.Network/applicationGateways', parameters('applicationGatewayName'))]"
            },
            "applicationGatewayName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Gateway"
              },
              "value": "[parameters('applicationGatewayName')]"
            },
            "publicIpAddress": {
              "type": "string",
              "metadata": {
                "description": "The public IP address of the Application Gateway"
              },
              "value": "[reference(parameters('publicIpAddressId'), '2023-09-01').ipAddress]"
            },
            "backendAddressPoolIds": {
              "type": "object",
              "metadata": {
                "description": "The backend address pool resource IDs"
              },
              "value": "[reduce(parameters('backendPools'), createObject(), lambda('cur', 'pool', union(lambdaVariables('cur'), createObject(format('{0}', lambdaVariables('pool').name), resourceId('Microsoft.Network/applicationGateways/backendAddressPools', parameters('applicationGatewayName'), lambdaVariables('pool').name)))))]"
            },
            "frontendIpConfigurationId": {
              "type": "string",
              "metadata": {
                "description": "The frontend IP configuration resource ID"
              },
              "value": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', parameters('applicationGatewayName'), 'public-frontend-ip')]"
            },
            "wafPolicyId": {
              "type": "string",
              "metadata": {
                "description": "The WAF policy resource ID (if created)"
              },
              "value": "[if(not(empty(parameters('customWafRules'))), resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', format('{0}-waf-policy', parameters('applicationGatewayName'))), '')]"
            },
            "applicationGatewayConfig": {
              "type": "object",
              "metadata": {
                "description": "The Application Gateway configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Network/applicationGateways', parameters('applicationGatewayName'))]",
                "name": "[parameters('applicationGatewayName')]",
                "sku": "[parameters('sku')]",
                "capacity": "[if(parameters('enableAutoscaling'), 'Autoscaling', string(parameters('capacity')))]",
                "wafEnabled": "[parameters('enableWaf')]",
                "http2Enabled": "[parameters('enableHttp2')]",
                "backendPools": "[map(parameters('backendPools'), lambda('pool', lambdaVariables('pool').name))]",
                "listeners": "[map(parameters('httpListeners'), lambda('listener', lambdaVariables('listener').name))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "applicationGatewayPublicIp",
        "keyVault",
        "managedIdentities",
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "webTierVmScaleSet": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "web-tier-vmss-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vmScaleSetName": {
            "value": "[format('{0}-web', reference('namingConventions').outputs.namingConvention.value.virtualMachineScaleSet)]"
          },
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.webTier]"
          },
          "loadBalancerBackendAddressPoolIds": {
            "value": []
          },
          "applicationGatewayBackendAddressPoolIds": {
            "value": [
              "[reference('applicationGateway').outputs.backendAddressPoolIds.value['web-tier-pool']]"
            ]
          },
          "vmConfig": {
            "value": {
              "vmSize": "[parameters('environmentConfig').virtualMachineSize]",
              "osType": "Linux",
              "osDisk": {
                "storageAccountType": "[if(equals(parameters('environmentConfig').skuTier, 'Premium'), 'Premium_LRS', 'Standard_LRS')]",
                "diskSizeGB": 128
              },
              "dataDisks": [],
              "networkInterface": {
                "enableAcceleratedNetworking": "[not(equals(parameters('environmentConfig').skuTier, 'Basic'))]",
                "enableIpForwarding": false
              },
              "availability": {
                "availabilitySetId": null,
                "availabilityZone": null
              }
            }
          },
          "tier": {
            "value": "web"
          },
          "instanceCount": {
            "value": "[parameters('environmentConfig').instanceCount]"
          },
          "enableAutoscaling": {
            "value": "[parameters('environmentConfig').enableHighAvailability]"
          },
          "minInstanceCount": {
            "value": 1
          },
          "maxInstanceCount": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', mul(parameters('environmentConfig').instanceCount, 3)), createObject('value', parameters('environmentConfig').instanceCount))]",
          "availabilityZones": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', createArray('1', '2', '3')), createObject('value', createArray('1')))]",
          "adminUsername": {
            "value": "azureuser"
          },
          "sshPublicKey": {
            "value": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7S..."
          },
          "customScriptExtension": {
            "value": {}
          },
          "enableBootDiagnostics": {
            "value": true
          },
          "networkSecurityGroupId": {
            "value": "[reference('networkSecurityGroups').outputs.nsgIds.value.webTier]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14754008257656493111"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "VirtualMachineConfig": {
              "type": "object",
              "properties": {
                "vmSize": {
                  "type": "string",
                  "metadata": {
                    "description": "VM size"
                  }
                },
                "osType": {
                  "type": "string",
                  "allowedValues": [
                    "Linux",
                    "Windows"
                  ],
                  "metadata": {
                    "description": "Operating system type"
                  }
                },
                "osDisk": {
                  "type": "object",
                  "properties": {
                    "storageAccountType": {
                      "type": "string",
                      "allowedValues": [
                        "Premium_LRS",
                        "StandardSSD_LRS",
                        "Standard_LRS"
                      ]
                    },
                    "diskSizeGB": {
                      "type": "int",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "OS disk configuration"
                  }
                },
                "dataDisks": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "diskSizeGB": {
                        "type": "int"
                      },
                      "storageAccountType": {
                        "type": "string",
                        "allowedValues": [
                          "Premium_LRS",
                          "StandardSSD_LRS",
                          "Standard_LRS"
                        ]
                      },
                      "lun": {
                        "type": "int"
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Data disk configurations"
                  }
                },
                "networkInterface": {
                  "type": "object",
                  "properties": {
                    "enableAcceleratedNetworking": {
                      "type": "bool"
                    },
                    "enableIpForwarding": {
                      "type": "bool"
                    }
                  },
                  "metadata": {
                    "description": "Network interface configuration"
                  }
                },
                "availability": {
                  "type": "object",
                  "properties": {
                    "availabilitySetId": {
                      "type": "string",
                      "nullable": true
                    },
                    "availabilityZone": {
                      "type": "string",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "Availability configuration"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "vmScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "The name prefix for the VM scale set"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID for the VM scale set"
              }
            },
            "loadBalancerBackendAddressPoolIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The load balancer backend address pool IDs (optional)"
              }
            },
            "applicationGatewayBackendAddressPoolIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The application gateway backend address pool IDs (optional)"
              }
            },
            "vmConfig": {
              "$ref": "#/definitions/VirtualMachineConfig",
              "metadata": {
                "description": "VM configuration"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "web",
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this VM scale set (web, business, or data)"
              }
            },
            "instanceCount": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 0,
              "maxValue": 1000,
              "metadata": {
                "description": "Initial instance count for the scale set"
              }
            },
            "enableAutoscaling": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable autoscaling"
              }
            },
            "minInstanceCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "Minimum instance count for autoscaling"
              }
            },
            "maxInstanceCount": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "Maximum instance count for autoscaling"
              }
            },
            "availabilityZones": {
              "type": "array",
              "defaultValue": [
                "1",
                "2",
                "3"
              ],
              "metadata": {
                "description": "Availability zones for the scale set"
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Admin username for the VMs"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "nullable": true,
              "metadata": {
                "description": "Admin password for Windows VMs (use Key Vault reference)"
              }
            },
            "sshPublicKey": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "SSH public key for Linux VMs"
              }
            },
            "customScriptExtension": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Custom script extension settings (optional)"
              }
            },
            "enableBootDiagnostics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable boot diagnostics"
              }
            },
            "bootDiagnosticsStorageUri": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Storage account URI for boot diagnostics (optional)"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Network security group ID for the network interface"
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable accelerated networking"
              }
            },
            "enableIpForwarding": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable IP forwarding"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the VM scale set"
              }
            },
            "upgradeMode": {
              "type": "string",
              "defaultValue": "Manual",
              "allowedValues": [
                "Automatic",
                "Manual",
                "Rolling"
              ],
              "metadata": {
                "description": "Upgrade policy mode"
              }
            },
            "singlePlacementGroup": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable single placement group"
              }
            },
            "overprovision": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable over-provisioning"
              }
            }
          },
          "variables": {
            "isWindows": "[equals(parameters('vmConfig').osType, 'Windows')]",
            "imageReference": "[if(variables('isWindows'), createObject('publisher', 'MicrosoftWindowsServer', 'offer', 'WindowsServer', 'sku', '2022-datacenter-azure-edition', 'version', 'latest'), createObject('publisher', 'Canonical', 'offer', '0001-com-ubuntu-server-jammy', 'sku', '22_04-lts-gen2', 'version', 'latest'))]",
            "networkInterfaceConfigurations": [
              {
                "name": "[format('{0}-nic-config', parameters('vmScaleSetName'))]",
                "properties": {
                  "primary": true,
                  "enableAcceleratedNetworking": "[parameters('vmConfig').networkInterface.enableAcceleratedNetworking]",
                  "enableIPForwarding": "[parameters('vmConfig').networkInterface.enableIpForwarding]",
                  "networkSecurityGroup": "[if(not(equals(parameters('networkSecurityGroupId'), null())), createObject('id', parameters('networkSecurityGroupId')), null())]",
                  "ipConfigurations": [
                    {
                      "name": "[format('{0}-ip-config', parameters('vmScaleSetName'))]",
                      "properties": {
                        "primary": true,
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "loadBalancerBackendAddressPools": "[map(parameters('loadBalancerBackendAddressPoolIds'), lambda('poolId', createObject('id', lambdaVariables('poolId'))))]",
                        "applicationGatewayBackendAddressPools": "[map(parameters('applicationGatewayBackendAddressPoolIds'), lambda('poolId', createObject('id', lambdaVariables('poolId'))))]"
                      }
                    }
                  ]
                }
              }
            ],
            "osProfile": "[if(variables('isWindows'), createObject('computerNamePrefix', take(parameters('vmScaleSetName'), 9), 'adminUsername', parameters('adminUsername'), 'adminPassword', parameters('adminPassword'), 'windowsConfiguration', createObject('enableAutomaticUpdates', true(), 'provisionVMAgent', true(), 'patchSettings', createObject('patchMode', 'AutomaticByOS', 'automaticByPlatformSettings', createObject('rebootSetting', 'IfRequired')))), createObject('computerNamePrefix', take(parameters('vmScaleSetName'), 9), 'adminUsername', parameters('adminUsername'), 'linuxConfiguration', createObject('disablePasswordAuthentication', true(), 'ssh', createObject('publicKeys', createArray(createObject('path', format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername')), 'keyData', parameters('sshPublicKey')))), 'patchSettings', createObject('patchMode', 'ImageDefault'))))]",
            "storageProfile": {
              "imageReference": "[variables('imageReference')]",
              "osDisk": {
                "createOption": "FromImage",
                "caching": "ReadWrite",
                "managedDisk": {
                  "storageAccountType": "[parameters('vmConfig').osDisk.storageAccountType]"
                },
                "diskSizeGB": "[parameters('vmConfig').osDisk.diskSizeGB]"
              },
              "dataDisks": "[map(coalesce(parameters('vmConfig').dataDisks, createArray()), lambda('disk', createObject('lun', lambdaVariables('disk').lun, 'createOption', 'Empty', 'caching', 'ReadWrite', 'managedDisk', createObject('storageAccountType', lambdaVariables('disk').storageAccountType), 'diskSizeGB', lambdaVariables('disk').diskSizeGB)))]"
            },
            "extensionProfile": "[if(not(empty(parameters('customScriptExtension'))), createObject('extensions', createArray(createObject('name', 'CustomScriptExtension', 'properties', createObject('publisher', if(variables('isWindows'), 'Microsoft.Compute', 'Microsoft.Azure.Extensions'), 'type', if(variables('isWindows'), 'CustomScriptExtension', 'CustomScript'), 'typeHandlerVersion', if(variables('isWindows'), '1.10', '2.1'), 'autoUpgradeMinorVersion', true(), 'settings', parameters('customScriptExtension'))))), null())]"
          },
          "resources": {
            "vmScaleSet": {
              "type": "Microsoft.Compute/virtualMachineScaleSets",
              "apiVersion": "2023-09-01",
              "name": "[parameters('vmScaleSetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "zones": "[parameters('availabilityZones')]",
              "sku": {
                "name": "[parameters('vmConfig').vmSize]",
                "tier": "Standard",
                "capacity": "[parameters('instanceCount')]"
              },
              "properties": {
                "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
                "upgradePolicy": {
                  "mode": "[parameters('upgradeMode')]",
                  "rollingUpgradePolicy": "[if(equals(parameters('upgradeMode'), 'Rolling'), createObject('maxBatchInstancePercent', 20, 'maxUnhealthyInstancePercent', 20, 'maxUnhealthyUpgradedInstancePercent', 20, 'pauseTimeBetweenBatches', 'PT0S'), null())]"
                },
                "virtualMachineProfile": {
                  "osProfile": "[variables('osProfile')]",
                  "storageProfile": "[variables('storageProfile')]",
                  "networkProfile": {
                    "networkInterfaceConfigurations": "[variables('networkInterfaceConfigurations')]"
                  },
                  "extensionProfile": "[variables('extensionProfile')]",
                  "diagnosticsProfile": "[if(parameters('enableBootDiagnostics'), createObject('bootDiagnostics', createObject('enabled', true(), 'storageUri', parameters('bootDiagnosticsStorageUri'))), null())]"
                },
                "overprovision": "[parameters('overprovision')]",
                "doNotRunExtensionsOnOverprovisionedVMs": false,
                "zoneBalance": true,
                "platformFaultDomainCount": 1
              }
            },
            "autoscaleSettings": {
              "condition": "[parameters('enableAutoscaling')]",
              "type": "Microsoft.Insights/autoscalesettings",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-autoscale', parameters('vmScaleSetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "name": "[format('{0}-autoscale', parameters('vmScaleSetName'))]",
                "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                "enabled": true,
                "profiles": [
                  {
                    "name": "Default",
                    "capacity": {
                      "minimum": "[string(parameters('minInstanceCount'))]",
                      "maximum": "[string(parameters('maxInstanceCount'))]",
                      "default": "[string(parameters('instanceCount'))]"
                    },
                    "rules": [
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "Microsoft.Compute/virtualMachineScaleSets",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "GreaterThan",
                          "threshold": 75
                        },
                        "scaleAction": {
                          "direction": "Increase",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT5M"
                        }
                      },
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "Microsoft.Compute/virtualMachineScaleSets",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "LessThan",
                          "threshold": 25
                        },
                        "scaleAction": {
                          "direction": "Decrease",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT5M"
                        }
                      }
                    ]
                  }
                ],
                "notifications": []
              },
              "dependsOn": [
                "vmScaleSet"
              ]
            }
          },
          "outputs": {
            "vmScaleSetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the VM scale set"
              },
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]"
            },
            "vmScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the VM scale set"
              },
              "value": "[parameters('vmScaleSetName')]"
            },
            "autoscaleSettingsId": {
              "type": "string",
              "metadata": {
                "description": "The autoscale settings resource ID"
              },
              "value": "[if(parameters('enableAutoscaling'), resourceId('Microsoft.Insights/autoscalesettings', format('{0}-autoscale', parameters('vmScaleSetName'))), '')]"
            },
            "vmScaleSetConfig": {
              "type": "object",
              "metadata": {
                "description": "The VM scale set configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                "name": "[parameters('vmScaleSetName')]",
                "tier": "[parameters('tier')]",
                "vmSize": "[parameters('vmConfig').vmSize]",
                "osType": "[parameters('vmConfig').osType]",
                "instanceCount": "[parameters('instanceCount')]",
                "availabilityZones": "[parameters('availabilityZones')]",
                "autoscalingEnabled": "[parameters('enableAutoscaling')]",
                "minInstanceCount": "[if(parameters('enableAutoscaling'), parameters('minInstanceCount'), parameters('instanceCount'))]",
                "maxInstanceCount": "[if(parameters('enableAutoscaling'), parameters('maxInstanceCount'), parameters('instanceCount'))]"
              }
            },
            "networkInterfaceConfigurationName": {
              "type": "string",
              "metadata": {
                "description": "The network interface configuration name"
              },
              "value": "[variables('networkInterfaceConfigurations')[0].name]"
            }
          }
        }
      },
      "dependsOn": [
        "applicationGateway",
        "namingConventions",
        "networkSecurityGroups",
        "virtualNetwork"
      ]
    },
    "businessTierVmScaleSet": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "business-tier-vmss-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vmScaleSetName": {
            "value": "[format('{0}-business', reference('namingConventions').outputs.namingConvention.value.virtualMachineScaleSet)]"
          },
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.businessTier]"
          },
          "loadBalancerBackendAddressPoolIds": {
            "value": [
              "[reference('businessTierLoadBalancer').outputs.backendAddressPoolIds.value['business-tier-pool']]"
            ]
          },
          "applicationGatewayBackendAddressPoolIds": {
            "value": []
          },
          "vmConfig": {
            "value": {
              "vmSize": "[parameters('environmentConfig').virtualMachineSize]",
              "osType": "Linux",
              "osDisk": {
                "storageAccountType": "[if(equals(parameters('environmentConfig').skuTier, 'Premium'), 'Premium_LRS', 'Standard_LRS')]",
                "diskSizeGB": 128
              },
              "dataDisks": [
                {
                  "diskSizeGB": 256,
                  "storageAccountType": "[if(equals(parameters('environmentConfig').skuTier, 'Premium'), 'Premium_LRS', 'Standard_LRS')]",
                  "lun": 0
                }
              ],
              "networkInterface": {
                "enableAcceleratedNetworking": "[not(equals(parameters('environmentConfig').skuTier, 'Basic'))]",
                "enableIpForwarding": false
              },
              "availability": {
                "availabilitySetId": null,
                "availabilityZone": null
              }
            }
          },
          "tier": {
            "value": "business"
          },
          "instanceCount": {
            "value": "[parameters('environmentConfig').instanceCount]"
          },
          "enableAutoscaling": {
            "value": "[parameters('environmentConfig').enableHighAvailability]"
          },
          "minInstanceCount": {
            "value": 1
          },
          "maxInstanceCount": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', mul(parameters('environmentConfig').instanceCount, 2)), createObject('value', parameters('environmentConfig').instanceCount))]",
          "availabilityZones": "[if(parameters('environmentConfig').enableHighAvailability, createObject('value', createArray('1', '2', '3')), createObject('value', createArray('1')))]",
          "adminUsername": {
            "value": "azureuser"
          },
          "sshPublicKey": {
            "value": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7S..."
          },
          "customScriptExtension": {
            "value": {}
          },
          "enableBootDiagnostics": {
            "value": true
          },
          "networkSecurityGroupId": {
            "value": "[reference('networkSecurityGroups').outputs.nsgIds.value.businessTier]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14754008257656493111"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            },
            "VirtualMachineConfig": {
              "type": "object",
              "properties": {
                "vmSize": {
                  "type": "string",
                  "metadata": {
                    "description": "VM size"
                  }
                },
                "osType": {
                  "type": "string",
                  "allowedValues": [
                    "Linux",
                    "Windows"
                  ],
                  "metadata": {
                    "description": "Operating system type"
                  }
                },
                "osDisk": {
                  "type": "object",
                  "properties": {
                    "storageAccountType": {
                      "type": "string",
                      "allowedValues": [
                        "Premium_LRS",
                        "StandardSSD_LRS",
                        "Standard_LRS"
                      ]
                    },
                    "diskSizeGB": {
                      "type": "int",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "OS disk configuration"
                  }
                },
                "dataDisks": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "diskSizeGB": {
                        "type": "int"
                      },
                      "storageAccountType": {
                        "type": "string",
                        "allowedValues": [
                          "Premium_LRS",
                          "StandardSSD_LRS",
                          "Standard_LRS"
                        ]
                      },
                      "lun": {
                        "type": "int"
                      }
                    }
                  },
                  "nullable": true,
                  "metadata": {
                    "description": "Data disk configurations"
                  }
                },
                "networkInterface": {
                  "type": "object",
                  "properties": {
                    "enableAcceleratedNetworking": {
                      "type": "bool"
                    },
                    "enableIpForwarding": {
                      "type": "bool"
                    }
                  },
                  "metadata": {
                    "description": "Network interface configuration"
                  }
                },
                "availability": {
                  "type": "object",
                  "properties": {
                    "availabilitySetId": {
                      "type": "string",
                      "nullable": true
                    },
                    "availabilityZone": {
                      "type": "string",
                      "nullable": true
                    }
                  },
                  "metadata": {
                    "description": "Availability configuration"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "vmScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "The name prefix for the VM scale set"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The subnet ID for the VM scale set"
              }
            },
            "loadBalancerBackendAddressPoolIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The load balancer backend address pool IDs (optional)"
              }
            },
            "applicationGatewayBackendAddressPoolIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The application gateway backend address pool IDs (optional)"
              }
            },
            "vmConfig": {
              "$ref": "#/definitions/VirtualMachineConfig",
              "metadata": {
                "description": "VM configuration"
              }
            },
            "tier": {
              "type": "string",
              "allowedValues": [
                "web",
                "business",
                "data"
              ],
              "metadata": {
                "description": "The tier for this VM scale set (web, business, or data)"
              }
            },
            "instanceCount": {
              "type": "int",
              "defaultValue": 2,
              "minValue": 0,
              "maxValue": 1000,
              "metadata": {
                "description": "Initial instance count for the scale set"
              }
            },
            "enableAutoscaling": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable autoscaling"
              }
            },
            "minInstanceCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "Minimum instance count for autoscaling"
              }
            },
            "maxInstanceCount": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "Maximum instance count for autoscaling"
              }
            },
            "availabilityZones": {
              "type": "array",
              "defaultValue": [
                "1",
                "2",
                "3"
              ],
              "metadata": {
                "description": "Availability zones for the scale set"
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Admin username for the VMs"
              }
            },
            "adminPassword": {
              "type": "securestring",
              "nullable": true,
              "metadata": {
                "description": "Admin password for Windows VMs (use Key Vault reference)"
              }
            },
            "sshPublicKey": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "SSH public key for Linux VMs"
              }
            },
            "customScriptExtension": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Custom script extension settings (optional)"
              }
            },
            "enableBootDiagnostics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable boot diagnostics"
              }
            },
            "bootDiagnosticsStorageUri": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Storage account URI for boot diagnostics (optional)"
              }
            },
            "networkSecurityGroupId": {
              "type": "string",
              "nullable": true,
              "metadata": {
                "description": "Network security group ID for the network interface"
              }
            },
            "enableAcceleratedNetworking": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable accelerated networking"
              }
            },
            "enableIpForwarding": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable IP forwarding"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the VM scale set"
              }
            },
            "upgradeMode": {
              "type": "string",
              "defaultValue": "Manual",
              "allowedValues": [
                "Automatic",
                "Manual",
                "Rolling"
              ],
              "metadata": {
                "description": "Upgrade policy mode"
              }
            },
            "singlePlacementGroup": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable single placement group"
              }
            },
            "overprovision": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable over-provisioning"
              }
            }
          },
          "variables": {
            "isWindows": "[equals(parameters('vmConfig').osType, 'Windows')]",
            "imageReference": "[if(variables('isWindows'), createObject('publisher', 'MicrosoftWindowsServer', 'offer', 'WindowsServer', 'sku', '2022-datacenter-azure-edition', 'version', 'latest'), createObject('publisher', 'Canonical', 'offer', '0001-com-ubuntu-server-jammy', 'sku', '22_04-lts-gen2', 'version', 'latest'))]",
            "networkInterfaceConfigurations": [
              {
                "name": "[format('{0}-nic-config', parameters('vmScaleSetName'))]",
                "properties": {
                  "primary": true,
                  "enableAcceleratedNetworking": "[parameters('vmConfig').networkInterface.enableAcceleratedNetworking]",
                  "enableIPForwarding": "[parameters('vmConfig').networkInterface.enableIpForwarding]",
                  "networkSecurityGroup": "[if(not(equals(parameters('networkSecurityGroupId'), null())), createObject('id', parameters('networkSecurityGroupId')), null())]",
                  "ipConfigurations": [
                    {
                      "name": "[format('{0}-ip-config', parameters('vmScaleSetName'))]",
                      "properties": {
                        "primary": true,
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "loadBalancerBackendAddressPools": "[map(parameters('loadBalancerBackendAddressPoolIds'), lambda('poolId', createObject('id', lambdaVariables('poolId'))))]",
                        "applicationGatewayBackendAddressPools": "[map(parameters('applicationGatewayBackendAddressPoolIds'), lambda('poolId', createObject('id', lambdaVariables('poolId'))))]"
                      }
                    }
                  ]
                }
              }
            ],
            "osProfile": "[if(variables('isWindows'), createObject('computerNamePrefix', take(parameters('vmScaleSetName'), 9), 'adminUsername', parameters('adminUsername'), 'adminPassword', parameters('adminPassword'), 'windowsConfiguration', createObject('enableAutomaticUpdates', true(), 'provisionVMAgent', true(), 'patchSettings', createObject('patchMode', 'AutomaticByOS', 'automaticByPlatformSettings', createObject('rebootSetting', 'IfRequired')))), createObject('computerNamePrefix', take(parameters('vmScaleSetName'), 9), 'adminUsername', parameters('adminUsername'), 'linuxConfiguration', createObject('disablePasswordAuthentication', true(), 'ssh', createObject('publicKeys', createArray(createObject('path', format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername')), 'keyData', parameters('sshPublicKey')))), 'patchSettings', createObject('patchMode', 'ImageDefault'))))]",
            "storageProfile": {
              "imageReference": "[variables('imageReference')]",
              "osDisk": {
                "createOption": "FromImage",
                "caching": "ReadWrite",
                "managedDisk": {
                  "storageAccountType": "[parameters('vmConfig').osDisk.storageAccountType]"
                },
                "diskSizeGB": "[parameters('vmConfig').osDisk.diskSizeGB]"
              },
              "dataDisks": "[map(coalesce(parameters('vmConfig').dataDisks, createArray()), lambda('disk', createObject('lun', lambdaVariables('disk').lun, 'createOption', 'Empty', 'caching', 'ReadWrite', 'managedDisk', createObject('storageAccountType', lambdaVariables('disk').storageAccountType), 'diskSizeGB', lambdaVariables('disk').diskSizeGB)))]"
            },
            "extensionProfile": "[if(not(empty(parameters('customScriptExtension'))), createObject('extensions', createArray(createObject('name', 'CustomScriptExtension', 'properties', createObject('publisher', if(variables('isWindows'), 'Microsoft.Compute', 'Microsoft.Azure.Extensions'), 'type', if(variables('isWindows'), 'CustomScriptExtension', 'CustomScript'), 'typeHandlerVersion', if(variables('isWindows'), '1.10', '2.1'), 'autoUpgradeMinorVersion', true(), 'settings', parameters('customScriptExtension'))))), null())]"
          },
          "resources": {
            "vmScaleSet": {
              "type": "Microsoft.Compute/virtualMachineScaleSets",
              "apiVersion": "2023-09-01",
              "name": "[parameters('vmScaleSetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "zones": "[parameters('availabilityZones')]",
              "sku": {
                "name": "[parameters('vmConfig').vmSize]",
                "tier": "Standard",
                "capacity": "[parameters('instanceCount')]"
              },
              "properties": {
                "singlePlacementGroup": "[parameters('singlePlacementGroup')]",
                "upgradePolicy": {
                  "mode": "[parameters('upgradeMode')]",
                  "rollingUpgradePolicy": "[if(equals(parameters('upgradeMode'), 'Rolling'), createObject('maxBatchInstancePercent', 20, 'maxUnhealthyInstancePercent', 20, 'maxUnhealthyUpgradedInstancePercent', 20, 'pauseTimeBetweenBatches', 'PT0S'), null())]"
                },
                "virtualMachineProfile": {
                  "osProfile": "[variables('osProfile')]",
                  "storageProfile": "[variables('storageProfile')]",
                  "networkProfile": {
                    "networkInterfaceConfigurations": "[variables('networkInterfaceConfigurations')]"
                  },
                  "extensionProfile": "[variables('extensionProfile')]",
                  "diagnosticsProfile": "[if(parameters('enableBootDiagnostics'), createObject('bootDiagnostics', createObject('enabled', true(), 'storageUri', parameters('bootDiagnosticsStorageUri'))), null())]"
                },
                "overprovision": "[parameters('overprovision')]",
                "doNotRunExtensionsOnOverprovisionedVMs": false,
                "zoneBalance": true,
                "platformFaultDomainCount": 1
              }
            },
            "autoscaleSettings": {
              "condition": "[parameters('enableAutoscaling')]",
              "type": "Microsoft.Insights/autoscalesettings",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-autoscale', parameters('vmScaleSetName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "name": "[format('{0}-autoscale', parameters('vmScaleSetName'))]",
                "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                "enabled": true,
                "profiles": [
                  {
                    "name": "Default",
                    "capacity": {
                      "minimum": "[string(parameters('minInstanceCount'))]",
                      "maximum": "[string(parameters('maxInstanceCount'))]",
                      "default": "[string(parameters('instanceCount'))]"
                    },
                    "rules": [
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "Microsoft.Compute/virtualMachineScaleSets",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "GreaterThan",
                          "threshold": 75
                        },
                        "scaleAction": {
                          "direction": "Increase",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT5M"
                        }
                      },
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "Microsoft.Compute/virtualMachineScaleSets",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "LessThan",
                          "threshold": 25
                        },
                        "scaleAction": {
                          "direction": "Decrease",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT5M"
                        }
                      }
                    ]
                  }
                ],
                "notifications": []
              },
              "dependsOn": [
                "vmScaleSet"
              ]
            }
          },
          "outputs": {
            "vmScaleSetId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the VM scale set"
              },
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]"
            },
            "vmScaleSetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the VM scale set"
              },
              "value": "[parameters('vmScaleSetName')]"
            },
            "autoscaleSettingsId": {
              "type": "string",
              "metadata": {
                "description": "The autoscale settings resource ID"
              },
              "value": "[if(parameters('enableAutoscaling'), resourceId('Microsoft.Insights/autoscalesettings', format('{0}-autoscale', parameters('vmScaleSetName'))), '')]"
            },
            "vmScaleSetConfig": {
              "type": "object",
              "metadata": {
                "description": "The VM scale set configuration details"
              },
              "value": {
                "resourceId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmScaleSetName'))]",
                "name": "[parameters('vmScaleSetName')]",
                "tier": "[parameters('tier')]",
                "vmSize": "[parameters('vmConfig').vmSize]",
                "osType": "[parameters('vmConfig').osType]",
                "instanceCount": "[parameters('instanceCount')]",
                "availabilityZones": "[parameters('availabilityZones')]",
                "autoscalingEnabled": "[parameters('enableAutoscaling')]",
                "minInstanceCount": "[if(parameters('enableAutoscaling'), parameters('minInstanceCount'), parameters('instanceCount'))]",
                "maxInstanceCount": "[if(parameters('enableAutoscaling'), parameters('maxInstanceCount'), parameters('instanceCount'))]"
              }
            },
            "networkInterfaceConfigurationName": {
              "type": "string",
              "metadata": {
                "description": "The network interface configuration name"
              },
              "value": "[variables('networkInterfaceConfigurations')[0].name]"
            }
          }
        }
      },
      "dependsOn": [
        "businessTierLoadBalancer",
        "namingConventions",
        "networkSecurityGroups",
        "virtualNetwork"
      ]
    },
    "logAnalyticsWorkspace": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "log-analytics-workspace-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "workspaceName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.logAnalyticsWorkspace]"
          },
          "workspaceSku": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', 'PerGB2018'), createObject('value', 'PerGB2018'))]",
          "retentionInDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "dailyQuotaGb": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', 5), if(equals(parameters('environmentConfig').skuTier, 'Standard'), createObject('value', 10), createObject('value', 50)))]",
          "enablePublicNetworkAccess": {
            "value": "[not(parameters('environmentConfig').enablePrivateEndpoints)]"
          },
          "allowedSubnetIds": "[if(parameters('environmentConfig').enablePrivateEndpoints, createObject('value', createArray(reference('virtualNetwork').outputs.subnetIds.value.management, reference('virtualNetwork').outputs.subnetIds.value.webTier, reference('virtualNetwork').outputs.subnetIds.value.businessTier, reference('virtualNetwork').outputs.subnetIds.value.dataTier)), createObject('value', createArray()))]",
          "allowedIpAddresses": {
            "value": []
          },
          "enableDataExport": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "dataExportStorageAccountId": {
            "value": ""
          },
          "enableDiagnosticSettings": {
            "value": false
          },
          "diagnosticStorageAccountId": {
            "value": ""
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7023259806112555371"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics workspace"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for the Log Analytics workspace"
              }
            },
            "workspaceSku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "Standard",
                "Premium",
                "PerNode",
                "PerGB2018",
                "Standalone",
                "CapacityReservation"
              ],
              "metadata": {
                "description": "The SKU of the Log Analytics workspace"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "The data retention period in days"
              }
            },
            "dailyQuotaGb": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "The daily quota for data ingestion in GB"
              }
            },
            "enablePublicNetworkAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public network access"
              }
            },
            "allowedSubnetIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Subnet IDs allowed to access the workspace"
              }
            },
            "allowedIpAddresses": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "IP addresses allowed to access the workspace"
              }
            },
            "enableDataExport": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable data export"
              }
            },
            "dataExportStorageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account ID for data export"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to the Log Analytics workspace"
              }
            },
            "enableDiagnosticSettings": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings for the workspace itself"
              }
            },
            "diagnosticStorageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Diagnostic settings storage account ID"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "ipRules",
                "count": "[length(parameters('allowedIpAddresses'))]",
                "input": {
                  "value": "[parameters('allowedIpAddresses')[copyIndex('ipRules')]]",
                  "action": "Allow"
                }
              },
              {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnetIds'))]",
                "input": {
                  "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]",
                  "action": "Allow"
                }
              }
            ],
            "workspaceConfig": {
              "sku": {
                "name": "[parameters('workspaceSku')]"
              },
              "retentionInDays": "[parameters('retentionInDays')]",
              "workspaceCapping": {
                "dailyQuotaGb": "[parameters('dailyQuotaGb')]"
              },
              "publicNetworkAccessForIngestion": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]",
              "publicNetworkAccessForQuery": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]"
            },
            "networkAccessControl": {
              "defaultAction": "Deny",
              "ipRules": "[variables('ipRules')]",
              "virtualNetworkRules": "[variables('virtualNetworkRules')]"
            }
          },
          "resources": {
            "logAnalyticsWorkspace": {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": "[if(not(parameters('enablePublicNetworkAccess')), union(variables('workspaceConfig'), createObject('networkAccessControl', variables('networkAccessControl'))), variables('workspaceConfig'))]"
            },
            "dataCollectionRule": {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2023-03-11",
              "name": "[format('{0}-dcr', parameters('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "[format('Data collection rule for {0}', parameters('workspaceName'))]",
                "dataSources": {
                  "performanceCounters": [
                    {
                      "name": "perfCounterDataSource60",
                      "streams": [
                        "Microsoft-Perf"
                      ],
                      "samplingFrequencyInSeconds": 60,
                      "counterSpecifiers": [
                        "\\Processor(_Total)\\% Processor Time",
                        "\\Memory\\Available MBytes",
                        "\\LogicalDisk(_Total)\\Disk Reads/sec",
                        "\\LogicalDisk(_Total)\\Disk Writes/sec",
                        "\\LogicalDisk(_Total)\\% Free Space",
                        "\\Network Interface(*)\\Bytes Total/sec"
                      ]
                    }
                  ],
                  "windowsEventLogs": [
                    {
                      "name": "eventLogsDataSource",
                      "streams": [
                        "Microsoft-Event"
                      ],
                      "xPathQueries": [
                        "Application!*[System[(Level=1 or Level=2 or Level=3)]]",
                        "Security!*[System[(band(Keywords,13510798882111488))]]",
                        "System!*[System[(Level=1 or Level=2 or Level=3)]]"
                      ]
                    }
                  ],
                  "syslog": [
                    {
                      "name": "syslogDataSource",
                      "streams": [
                        "Microsoft-Syslog"
                      ],
                      "facilityNames": [
                        "auth",
                        "authpriv",
                        "cron",
                        "daemon",
                        "kern",
                        "lpr",
                        "mail",
                        "mark",
                        "news",
                        "syslog",
                        "user",
                        "uucp"
                      ],
                      "logLevels": [
                        "Alert",
                        "Critical",
                        "Emergency",
                        "Error",
                        "Warning"
                      ]
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                      "name": "la-destination"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-Perf"
                    ],
                    "destinations": [
                      "la-destination"
                    ],
                    "transformKql": "source",
                    "outputStream": "Microsoft-Perf"
                  },
                  {
                    "streams": [
                      "Microsoft-Event"
                    ],
                    "destinations": [
                      "la-destination"
                    ],
                    "transformKql": "source",
                    "outputStream": "Microsoft-Event"
                  },
                  {
                    "streams": [
                      "Microsoft-Syslog"
                    ],
                    "destinations": [
                      "la-destination"
                    ],
                    "transformKql": "source",
                    "outputStream": "Microsoft-Syslog"
                  }
                ]
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            },
            "dataExportRule": {
              "condition": "[and(parameters('enableDataExport'), not(empty(parameters('dataExportStorageAccountId'))))]",
              "type": "Microsoft.OperationalInsights/workspaces/dataExports",
              "apiVersion": "2020-08-01",
              "name": "[format('{0}/{1}', parameters('workspaceName'), 'export-all-logs')]",
              "properties": {
                "destination": {
                  "resourceId": "[parameters('dataExportStorageAccountId')]",
                  "type": "StorageAccount"
                },
                "tableNames": [
                  "Heartbeat",
                  "Perf",
                  "Event",
                  "Syslog",
                  "SecurityEvent",
                  "AzureActivity",
                  "AzureDiagnostics"
                ],
                "enable": true
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            },
            "securitySolution": {
              "type": "Microsoft.OperationsManagement/solutions",
              "apiVersion": "2015-11-01-preview",
              "name": "[format('Security({0})', parameters('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              },
              "plan": {
                "name": "[format('Security({0})', parameters('workspaceName'))]",
                "publisher": "Microsoft",
                "product": "OMSGallery/Security",
                "promotionCode": ""
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            },
            "updatesSolution": {
              "type": "Microsoft.OperationsManagement/solutions",
              "apiVersion": "2015-11-01-preview",
              "name": "[format('Updates({0})', parameters('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              },
              "plan": {
                "name": "[format('Updates({0})', parameters('workspaceName'))]",
                "publisher": "Microsoft",
                "product": "OMSGallery/Updates",
                "promotionCode": ""
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            },
            "changeTrackingSolution": {
              "type": "Microsoft.OperationsManagement/solutions",
              "apiVersion": "2015-11-01-preview",
              "name": "[format('ChangeTracking({0})', parameters('workspaceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              },
              "plan": {
                "name": "[format('ChangeTracking({0})', parameters('workspaceName'))]",
                "publisher": "Microsoft",
                "product": "OMSGallery/ChangeTracking",
                "promotionCode": ""
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            },
            "workspaceDiagnosticSettings": {
              "condition": "[and(parameters('enableDiagnosticSettings'), not(empty(parameters('diagnosticStorageAccountId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('workspaceName'))]",
              "name": "[format('{0}-diagnostics', parameters('workspaceName'))]",
              "properties": {
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": true,
                      "days": "[parameters('retentionInDays')]"
                    }
                  },
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": true,
                      "days": "[parameters('retentionInDays')]"
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": true,
                      "days": "[parameters('retentionInDays')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "logAnalyticsWorkspace"
              ]
            }
          },
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics workspace"
              },
              "value": "[parameters('workspaceName')]"
            },
            "customerId": {
              "type": "string",
              "metadata": {
                "description": "The customer ID (workspace ID) of the Log Analytics workspace"
              },
              "value": "[reference('logAnalyticsWorkspace').customerId]"
            },
            "primarySharedKey": {
              "type": "securestring",
              "metadata": {
                "description": "The primary shared key of the Log Analytics workspace"
              },
              "value": "[listKeys('logAnalyticsWorkspace', '2023-09-01').primarySharedKey]"
            },
            "secondarySharedKey": {
              "type": "securestring",
              "metadata": {
                "description": "The secondary shared key of the Log Analytics workspace"
              },
              "value": "[listKeys('logAnalyticsWorkspace', '2023-09-01').secondarySharedKey]"
            },
            "dataCollectionRuleId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the data collection rule"
              },
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}-dcr', parameters('workspaceName')))]"
            },
            "dataExportRuleId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the data export rule"
              },
              "value": "[if(and(parameters('enableDataExport'), not(empty(parameters('dataExportStorageAccountId')))), resourceId('Microsoft.OperationalInsights/workspaces/dataExports', parameters('workspaceName'), 'export-all-logs'), '')]"
            },
            "workspaceConfig": {
              "type": "object",
              "metadata": {
                "description": "The Log Analytics workspace configuration"
              },
              "value": {
                "id": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                "name": "[parameters('workspaceName')]",
                "customerId": "[reference('logAnalyticsWorkspace').customerId]",
                "location": "[reference('logAnalyticsWorkspace', '2023-09-01', 'full').location]",
                "sku": "[reference('logAnalyticsWorkspace').sku.name]",
                "retentionInDays": "[reference('logAnalyticsWorkspace').retentionInDays]",
                "dailyQuotaGb": "[reference('logAnalyticsWorkspace').workspaceCapping.dailyQuotaGb]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "managedIdentityDiagnostics": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "managed-identity-diagnostics-update",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedIdentityBaseName": {
            "value": "[format('{0}-{1}-{2}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'))]"
          },
          "userAssignedIdentities": {
            "value": [
              {
                "name": "application-services",
                "description": "Managed identity for application services",
                "roleAssignments": []
              },
              {
                "name": "key-vault-access",
                "description": "Managed identity for Key Vault access",
                "roleAssignments": []
              },
              {
                "name": "storage-access",
                "description": "Managed identity for storage account access",
                "roleAssignments": []
              },
              {
                "name": "sql-access",
                "description": "Managed identity for SQL database access",
                "roleAssignments": []
              },
              {
                "name": "application-gateway",
                "description": "Managed identity for Application Gateway Key Vault access",
                "roleAssignments": []
              }
            ]
          },
          "enableDiagnostics": {
            "value": true
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "enableTelemetry": {
            "value": false
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6924630922910097285"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "managedIdentityBaseName": {
              "type": "string",
              "metadata": {
                "description": "The base name for managed identities"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "userAssignedIdentities": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "application-services",
                  "description": "Managed identity for application services",
                  "roleAssignments": []
                },
                {
                  "name": "key-vault-access",
                  "description": "Managed identity for Key Vault access",
                  "roleAssignments": []
                },
                {
                  "name": "storage-access",
                  "description": "Managed identity for storage account access",
                  "roleAssignments": []
                },
                {
                  "name": "sql-access",
                  "description": "Managed identity for SQL database access",
                  "roleAssignments": []
                }
              ],
              "metadata": {
                "description": "List of user-assigned managed identities to create"
              }
            },
            "enableDiagnostics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings for managed identities"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for diagnostic settings"
              }
            },
            "enableTelemetry": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable telemetry for the module"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "identityNames",
                "count": "[length(parameters('userAssignedIdentities'))]",
                "input": "[format('{0}-{1}-mi', parameters('managedIdentityBaseName'), parameters('userAssignedIdentities')[copyIndex('identityNames')].name)]"
              }
            ],
            "commonRoleDefinitions": {
              "storageBlobDataContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "storageBlobDataReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
              "storageAccountContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
              "keyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
              "keyVaultCertificateUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
              "keyVaultCryptoUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
              "sqlDbContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9b7fa17d-e63e-47b0-bb0a-15c516ac86ec')]",
              "monitoringContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '749f88d5-cbae-40b8-bcfc-e573ddc772fa')]",
              "monitoringReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
              "contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
              "reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
            }
          },
          "resources": {
            "userAssignedManagedIdentities": {
              "copy": {
                "name": "userAssignedManagedIdentities",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[variables('identityNames')[copyIndex()]]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('Purpose', parameters('userAssignedIdentities')[copyIndex()].description, 'IdentityType', 'UserAssigned'))]"
            },
            "managedIdentityRoleAssignments": {
              "copy": {
                "name": "managedIdentityRoleAssignments",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "condition": "[not(empty(parameters('userAssignedIdentities')[copyIndex()].roleAssignments))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()]), parameters('userAssignedIdentities')[copyIndex()].name, 'role-assignment')]",
              "properties": {
                "roleDefinitionId": "[variables('commonRoleDefinitions')[parameters('userAssignedIdentities')[copyIndex()].roleAssignments[0].role]]",
                "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]",
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
              ]
            },
            "managedIdentityDiagnostics": {
              "copy": {
                "name": "managedIdentityDiagnostics",
                "count": "[length(parameters('userAssignedIdentities'))]"
              },
              "condition": "[and(parameters('enableDiagnostics'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ManagedIdentity/userAssignedIdentities/{0}', variables('identityNames')[copyIndex()])]",
              "name": "[format('{0}-diagnostics', variables('identityNames')[copyIndex()])]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
              ]
            },
            "telemetryDeployment": {
              "condition": "[parameters('enableTelemetry')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
              "properties": {
                "mode": "Incremental",
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "resources": []
                }
              }
            }
          },
          "outputs": {
            "managedIdentityIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity resource IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]])]"
              }
            },
            "managedIdentityNames": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity names"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]]]"
              }
            },
            "managedIdentityPrincipalIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity principal IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).principalId]"
              }
            },
            "managedIdentityClientIds": {
              "type": "array",
              "metadata": {
                "description": "Array of user-assigned managed identity client IDs"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
                "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).clientId]"
              }
            },
            "managedIdentityConfigs": {
              "type": "array",
              "metadata": {
                "description": "Managed identity configuration details"
              },
              "copy": {
                "count": "[length(parameters('userAssignedIdentities'))]",
                "input": {
                  "name": "[variables('identityNames')[copyIndex()]]",
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).clientId]",
                  "purpose": "[parameters('userAssignedIdentities')[copyIndex()].description]",
                  "type": "UserAssigned"
                }
              }
            },
            "managedIdentityLookup": {
              "type": "object",
              "metadata": {
                "description": "Managed identity lookup object for easy reference"
              },
              "value": {
                "applicationServices": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[0])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).clientId]"
                },
                "keyVaultAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[1])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).clientId]"
                },
                "storageAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[2])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).clientId]"
                },
                "sqlAccess": {
                  "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[3])]",
                  "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).principalId]",
                  "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).clientId]"
                }
              }
            },
            "roleDefinitions": {
              "type": "object",
              "metadata": {
                "description": "Common role definitions for reference"
              },
              "value": "[variables('commonRoleDefinitions')]"
            }
          }
        }
      },
      "dependsOn": [
        "logAnalyticsWorkspace",
        "managedIdentities"
      ]
    },
    "applicationInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "application-insights-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "applicationInsightsName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.applicationInsights]"
          },
          "applicationType": {
            "value": "web"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "enablePublicNetworkAccessForIngestion": {
            "value": "[not(parameters('environmentConfig').enablePrivateEndpoints)]"
          },
          "enablePublicNetworkAccessForQuery": {
            "value": "[not(parameters('environmentConfig').enablePrivateEndpoints)]"
          },
          "retentionInDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "dailyDataCapInGB": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', 1), if(equals(parameters('environmentConfig').skuTier, 'Standard'), createObject('value', 5), createObject('value', 20)))]",
          "samplingPercentage": "[if(equals(parameters('environment'), 'dev'), createObject('value', 50), createObject('value', 100))]",
          "availabilityTestUrls": {
            "value": [
              "[format('https://{0}/health', reference('applicationGateway').outputs.publicIpAddress.value)]"
            ]
          },
          "availabilityTestLocations": {
            "value": [
              "us-east-1",
              "us-west-1",
              "europe-west-1"
            ]
          },
          "enableCustomMetrics": {
            "value": true
          },
          "enableLiveMetrics": {
            "value": true
          },
          "enableProfiler": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "enableSnapshotDebugger": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15662354832407278316"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights instance"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for Application Insights"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "The type of application being monitored"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "enablePublicNetworkAccessForIngestion": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public network access for ingestion"
              }
            },
            "enablePublicNetworkAccessForQuery": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public network access for query"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Data retention period in days"
              }
            },
            "dailyDataCapInGB": {
              "type": "int",
              "defaultValue": 10,
              "minValue": 1,
              "maxValue": 1000,
              "metadata": {
                "description": "Daily data cap in GB"
              }
            },
            "samplingPercentage": {
              "type": "int",
              "defaultValue": 100,
              "minValue": 0,
              "maxValue": 100,
              "metadata": {
                "description": "Sampling percentage for telemetry"
              }
            },
            "availabilityTestUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "URLs to monitor with availability tests"
              }
            },
            "availabilityTestLocations": {
              "type": "array",
              "defaultValue": [
                "us-east-1",
                "us-west-1",
                "europe-west-1",
                "asia-southeast-1",
                "australia-east-1"
              ],
              "metadata": {
                "description": "Locations for availability tests"
              }
            },
            "enableCustomMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable custom metrics and events"
              }
            },
            "enableLiveMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable live metrics stream"
              }
            },
            "enableProfiler": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable profiler"
              }
            },
            "enableSnapshotDebugger": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable snapshot debugger"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to Application Insights"
              }
            }
          },
          "variables": {
            "workspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]"
          },
          "resources": {
            "applicationInsights": {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[variables('workspaceResourceId')]",
                "publicNetworkAccessForIngestion": "[if(parameters('enablePublicNetworkAccessForIngestion'), 'Enabled', 'Disabled')]",
                "publicNetworkAccessForQuery": "[if(parameters('enablePublicNetworkAccessForQuery'), 'Enabled', 'Disabled')]",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "IngestionMode": "LogAnalytics",
                "SamplingPercentage": "[parameters('samplingPercentage')]",
                "DisableIpMasking": false,
                "DisableLocalAuth": true
              }
            },
            "dataCapConfig": {
              "type": "microsoft.insights/components/pricingPlans",
              "apiVersion": "2017-10-01",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'current')]",
              "properties": {
                "cap": "[parameters('dailyDataCapInGB')]",
                "warningThreshold": 80,
                "stopSendNotificationWhenHitCap": false
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "availabilityTests": {
              "copy": {
                "name": "availabilityTests",
                "count": "[length(parameters('availabilityTestUrls'))]"
              },
              "type": "Microsoft.Insights/webtests",
              "apiVersion": "2022-06-15",
              "name": "[format('{0}-availability-test-{1}', parameters('applicationInsightsName'), copyIndex())]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject(format('hidden-link:{0}', resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))), 'Resource'))]",
              "properties": {
                "copy": [
                  {
                    "name": "Locations",
                    "count": "[length(parameters('availabilityTestLocations'))]",
                    "input": {
                      "Id": "[parameters('availabilityTestLocations')[copyIndex('Locations')]]"
                    }
                  }
                ],
                "SyntheticMonitorId": "[format('{0}-availability-test-{1}', parameters('applicationInsightsName'), copyIndex())]",
                "Name": "[format('Availability Test - {0}', parameters('availabilityTestUrls')[copyIndex()])]",
                "Description": "[format('Availability test for {0}', parameters('availabilityTestUrls')[copyIndex()])]",
                "Enabled": true,
                "Frequency": 300,
                "Timeout": 30,
                "Kind": "ping",
                "RetryEnabled": true,
                "Configuration": {
                  "WebTest": "[format('<WebTest Name=\"Availability Test - {0}\" Id=\"{1}\" Enabled=\"True\" CssProjectStructure=\"\" CssIteration=\"\" Timeout=\"30\" WorkItemIds=\"\" xmlns=\"http://microsoft.com/schemas/VisualStudio/TeamTest/2010\" Description=\"\" CredentialUserName=\"\" CredentialPassword=\"\" PreAuthenticate=\"True\" Proxy=\"default\" StopOnError=\"False\" RecordedResultFile=\"\" ResultsLocale=\"\"><Items><Request Method=\"GET\" Guid=\"{2}\" Version=\"1.1\" Url=\"{3}\" ThinkTime=\"0\" Timeout=\"30\" ParseDependentRequests=\"False\" FollowRedirects=\"True\" RecordResult=\"True\" Cache=\"False\" ResponseTimeGoal=\"0\" Encoding=\"utf-8\" ExpectedHttpStatusCode=\"200\" ExpectedResponseUrl=\"\" ReportingName=\"\" IgnoreHttpStatusCode=\"False\" /></Items></WebTest>', parameters('availabilityTestUrls')[copyIndex()], guid(parameters('availabilityTestUrls')[copyIndex()]), guid(parameters('availabilityTestUrls')[copyIndex()], 'request'), parameters('availabilityTestUrls')[copyIndex()])]"
                }
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "customMetricsConfig": {
              "condition": "[parameters('enableCustomMetrics')]",
              "type": "microsoft.insights/components/analyticsItems",
              "apiVersion": "2015-05-01",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'item')]",
              "properties": {
                "name": "Custom Metrics Configuration",
                "type": "query",
                "scope": "shared",
                "content": "// Custom metrics queries for application monitoring\r\nlet customMetrics = () {\r\n    customMetrics\r\n    | where name in (\"BusinessMetric1\", \"BusinessMetric2\", \"PerformanceCounter\")\r\n    | summarize avg(value) by name, bin(timestamp, 5m)\r\n};\r\nlet errorRates = () {\r\n    requests\r\n    | summarize ErrorRate = (countif(success == false) * 100.0) / count() by bin(timestamp, 5m)\r\n    | where ErrorRate > 5\r\n};\r\nlet responseTimePercentiles = () {\r\n    requests\r\n    | summarize \r\n        P50 = percentile(duration, 50),\r\n        P95 = percentile(duration, 95),\r\n        P99 = percentile(duration, 99)\r\n    by bin(timestamp, 5m)\r\n};\r\nunion customMetrics(), errorRates(), responseTimePercentiles()\r\n"
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "liveMetricsConfig": {
              "condition": "[parameters('enableLiveMetrics')]",
              "type": "Microsoft.Insights/components/ProactiveDetectionConfigs",
              "apiVersion": "2018-05-01-preview",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'extension_traceseveritydetector')]",
              "properties": {
                "enabled": true,
                "sendEmailsToSubscriptionOwners": true,
                "customEmails": []
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "profilerConfig": {
              "condition": "[parameters('enableProfiler')]",
              "type": "Microsoft.Insights/components/ProactiveDetectionConfigs",
              "apiVersion": "2018-05-01-preview",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'extension_exceptionchangeextension')]",
              "properties": {
                "enabled": true,
                "sendEmailsToSubscriptionOwners": false,
                "customEmails": []
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "snapshotDebuggerConfig": {
              "condition": "[parameters('enableSnapshotDebugger')]",
              "type": "Microsoft.Insights/components/ProactiveDetectionConfigs",
              "apiVersion": "2018-05-01-preview",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'extension_memoryleakextension')]",
              "properties": {
                "enabled": true,
                "sendEmailsToSubscriptionOwners": false,
                "customEmails": []
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "apiKey": {
              "type": "Microsoft.Insights/components/ApiKeys",
              "apiVersion": "2015-05-01",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), format('{0}-api-key', parameters('applicationInsightsName')))]",
              "properties": {
                "name": "[format('{0}-api-key', parameters('applicationInsightsName'))]",
                "linkedReadProperties": [
                  "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
                ],
                "linkedWriteProperties": []
              },
              "dependsOn": [
                "applicationInsights"
              ]
            },
            "continuousExport": {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/components/exportconfigurations",
              "apiVersion": "2015-05-01",
              "name": "[format('{0}/{1}', parameters('applicationInsightsName'), 'continuous-export-config')]",
              "properties": {
                "ExportId": "[guid(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), 'export')]",
                "ExportStatus": "Enabled",
                "InstrumentationKey": "[reference('applicationInsights').InstrumentationKey]",
                "RecordTypes": "Requests,Event,Exception,Metric,PageView,PageViewPerformance,Rdd,PerformanceCounter,Availability",
                "ApplicationName": "[parameters('applicationInsightsName')]",
                "SubscriptionId": "[subscription().subscriptionId]",
                "ResourceGroupName": "[resourceGroup().name]",
                "DestinationType": "Blob",
                "IsUserEnabled": false
              },
              "dependsOn": [
                "applicationInsights"
              ]
            }
          },
          "outputs": {
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Application Insights instance"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Application Insights instance"
              },
              "value": "[parameters('applicationInsightsName')]"
            },
            "instrumentationKey": {
              "type": "securestring",
              "metadata": {
                "description": "The instrumentation key for Application Insights"
              },
              "value": "[reference('applicationInsights').InstrumentationKey]"
            },
            "connectionString": {
              "type": "securestring",
              "metadata": {
                "description": "The connection string for Application Insights"
              },
              "value": "[reference('applicationInsights').ConnectionString]"
            },
            "appId": {
              "type": "string",
              "metadata": {
                "description": "The App ID for Application Insights"
              },
              "value": "[reference('applicationInsights').AppId]"
            },
            "apiKey": {
              "type": "securestring",
              "metadata": {
                "description": "The API key for programmatic access"
              },
              "value": "[reference('apiKey').ApiKey]"
            },
            "availabilityTestIds": {
              "type": "array",
              "metadata": {
                "description": "The resource IDs of availability tests"
              },
              "copy": {
                "count": "[length(parameters('availabilityTestUrls'))]",
                "input": "[resourceId('Microsoft.Insights/webtests', format('{0}-availability-test-{1}', parameters('applicationInsightsName'), copyIndex()))]"
              }
            },
            "applicationInsightsConfig": {
              "type": "object",
              "metadata": {
                "description": "The Application Insights configuration"
              },
              "value": {
                "id": "[resourceId('Microsoft.Insights/components', parameters('applicationInsightsName'))]",
                "name": "[parameters('applicationInsightsName')]",
                "appId": "[reference('applicationInsights').AppId]",
                "location": "[reference('applicationInsights', '2020-02-02', 'full').location]",
                "applicationType": "[parameters('applicationType')]",
                "workspaceResourceId": "[variables('workspaceResourceId')]",
                "retentionInDays": "[parameters('retentionInDays')]",
                "dailyDataCapInGB": "[parameters('dailyDataCapInGB')]",
                "samplingPercentage": "[parameters('samplingPercentage')]",
                "availabilityTestCount": "[length(parameters('availabilityTestUrls'))]",
                "customMetricsEnabled": "[parameters('enableCustomMetrics')]",
                "liveMetricsEnabled": "[parameters('enableLiveMetrics')]",
                "profilerEnabled": "[parameters('enableProfiler')]",
                "snapshotDebuggerEnabled": "[parameters('enableSnapshotDebugger')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "applicationGateway",
        "logAnalyticsWorkspace",
        "namingConventions"
      ]
    },
    "monitoringAlerts": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-alerts-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "alertNamePrefix": {
            "value": "[format('{0}-{1}-{2}', parameters('resourcePrefix'), parameters('workloadName'), parameters('environment'))]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "applicationInsightsId": {
            "value": "[reference('applicationInsights').outputs.applicationInsightsId.value]"
          },
          "alertEmailAddresses": {
            "value": []
          },
          "alertSmsNumbers": {
            "value": []
          },
          "alertWebhookUrls": {
            "value": []
          },
          "enableSecurityAlerts": {
            "value": true
          },
          "enablePerformanceAlerts": {
            "value": true
          },
          "enableAvailabilityAlerts": {
            "value": true
          },
          "monitoredResourceIds": {
            "value": [
              "[reference('webTierVmScaleSet').outputs.vmScaleSetId.value]",
              "[reference('businessTierVmScaleSet').outputs.vmScaleSetId.value]",
              "[reference('applicationGateway').outputs.applicationGatewayId.value]",
              "[reference('sqlServer').outputs.sqlServerId.value]",
              "[reference('storageAccount').outputs.storageAccountId.value]"
            ]
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "8967993647047571117"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "alertNamePrefix": {
              "type": "string",
              "metadata": {
                "description": "The prefix for alert rule names"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location for alert resources"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "applicationInsightsId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Application Insights instance"
              }
            },
            "alertEmailAddresses": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Email addresses for alert notifications"
              }
            },
            "alertSmsNumbers": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "SMS phone numbers for critical alerts"
              }
            },
            "alertWebhookUrls": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Webhook URLs for alert notifications"
              }
            },
            "enableSecurityAlerts": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable security alerts"
              }
            },
            "enablePerformanceAlerts": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable performance alerts"
              }
            },
            "enableAvailabilityAlerts": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable availability alerts"
              }
            },
            "monitoredResourceIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Resource IDs to monitor for alerts"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to alert resources"
              }
            }
          },
          "variables": {
            "actionGroupName": "[format('{0}-action-group', parameters('alertNamePrefix'))]",
            "criticalActionGroupName": "[format('{0}-critical-action-group', parameters('alertNamePrefix'))]"
          },
          "resources": {
            "actionGroup": {
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "[variables('actionGroupName')]",
              "location": "Global",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "emailReceivers",
                    "count": "[length(parameters('alertEmailAddresses'))]",
                    "input": {
                      "name": "[format('email-{0}', copyIndex('emailReceivers'))]",
                      "emailAddress": "[parameters('alertEmailAddresses')[copyIndex('emailReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  },
                  {
                    "name": "smsReceivers",
                    "count": "[length(parameters('alertSmsNumbers'))]",
                    "input": {
                      "name": "[format('sms-{0}', copyIndex('smsReceivers'))]",
                      "countryCode": "1",
                      "phoneNumber": "[parameters('alertSmsNumbers')[copyIndex('smsReceivers')]]"
                    }
                  },
                  {
                    "name": "webhookReceivers",
                    "count": "[length(parameters('alertWebhookUrls'))]",
                    "input": {
                      "name": "[format('webhook-{0}', copyIndex('webhookReceivers'))]",
                      "serviceUri": "[parameters('alertWebhookUrls')[copyIndex('webhookReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  }
                ],
                "groupShortName": "[substring(variables('actionGroupName'), 0, min(length(variables('actionGroupName')), 12))]",
                "enabled": true
              }
            },
            "criticalActionGroup": {
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "[variables('criticalActionGroupName')]",
              "location": "Global",
              "tags": "[parameters('tags')]",
              "properties": {
                "copy": [
                  {
                    "name": "emailReceivers",
                    "count": "[length(parameters('alertEmailAddresses'))]",
                    "input": {
                      "name": "[format('email-{0}', copyIndex('emailReceivers'))]",
                      "emailAddress": "[parameters('alertEmailAddresses')[copyIndex('emailReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  },
                  {
                    "name": "smsReceivers",
                    "count": "[length(parameters('alertSmsNumbers'))]",
                    "input": {
                      "name": "[format('sms-{0}', copyIndex('smsReceivers'))]",
                      "countryCode": "1",
                      "phoneNumber": "[parameters('alertSmsNumbers')[copyIndex('smsReceivers')]]"
                    }
                  },
                  {
                    "name": "webhookReceivers",
                    "count": "[length(parameters('alertWebhookUrls'))]",
                    "input": {
                      "name": "[format('webhook-{0}', copyIndex('webhookReceivers'))]",
                      "serviceUri": "[parameters('alertWebhookUrls')[copyIndex('webhookReceivers')]]",
                      "useCommonAlertSchema": true
                    }
                  }
                ],
                "groupShortName": "[substring(variables('criticalActionGroupName'), 0, min(length(variables('criticalActionGroupName')), 12))]",
                "enabled": true
              }
            },
            "securityFailedLoginsAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-failed-logins', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security - Multiple Failed Login Attempts",
                "description": "Alert when there are multiple failed login attempts from the same IP",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityEvent | where EventID == 4625 | summarize FailedAttempts = count() by IpAddress | where FailedAttempts > 5",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "IpAddress",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            },
            "securityPrivilegeEscalationAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-privilege-escalation', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security - Privilege Escalation Detected",
                "description": "Alert when privilege escalation activities are detected",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityEvent | where EventID in (4672, 4673, 4674) | summarize count() by Account",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "Account",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            },
            "performanceCpuAlert": {
              "condition": "[and(parameters('enablePerformanceAlerts'), not(empty(parameters('monitoredResourceIds'))))]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('{0}-performance-high-cpu', parameters('alertNamePrefix'))]",
              "location": "Global",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Performance - High CPU Usage",
                "description": "Alert when CPU usage exceeds 80% for 10 minutes",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "windowSize": "PT10M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "HighCPU",
                      "metricName": "Percentage CPU",
                      "metricNamespace": "Microsoft.Compute/virtualMachines",
                      "operator": "GreaterThan",
                      "threshold": 80,
                      "timeAggregation": "Average",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  }
                ],
                "scopes": "[parameters('monitoredResourceIds')]"
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "performanceMemoryAlert": {
              "condition": "[and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-performance-low-memory', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Performance - Low Available Memory",
                "description": "Alert when available memory is below 10% for 5 minutes",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "Perf | where ObjectName == \"Memory\" and CounterName == \"Available MBytes\" | summarize AvgMemory = avg(CounterValue) by Computer | where AvgMemory < 1024",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "Computer",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "performanceDiskSpaceAlert": {
              "condition": "[and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-performance-low-disk-space', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Performance - Low Disk Space",
                "description": "Alert when disk free space is below 10%",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "Perf | where ObjectName == \"LogicalDisk\" and CounterName == \"% Free Space\" | summarize AvgFreeSpace = avg(CounterValue) by Computer, InstanceName | where AvgFreeSpace < 10",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "Computer",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        },
                        {
                          "name": "InstanceName",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "availabilityApplicationInsightsAlert": {
              "condition": "[and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId'))))]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('{0}-availability-app-insights', parameters('alertNamePrefix'))]",
              "location": "Global",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Availability - Application Insights Availability",
                "description": "Alert when application availability drops below 95%",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "LowAvailability",
                      "metricName": "availabilityResults/availabilityPercentage",
                      "metricNamespace": "Microsoft.Insights/components",
                      "operator": "LessThan",
                      "threshold": 95,
                      "timeAggregation": "Average",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  }
                ],
                "scopes": [
                  "[parameters('applicationInsightsId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            },
            "availabilityResponseTimeAlert": {
              "condition": "[and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId'))))]",
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('{0}-availability-response-time', parameters('alertNamePrefix'))]",
              "location": "Global",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Availability - High Response Time",
                "description": "Alert when average response time exceeds 5 seconds",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT1M",
                "windowSize": "PT5M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "HighResponseTime",
                      "metricName": "requests/duration",
                      "metricNamespace": "Microsoft.Insights/components",
                      "operator": "GreaterThan",
                      "threshold": 5000,
                      "timeAggregation": "Average",
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  }
                ],
                "scopes": [
                  "[parameters('applicationInsightsId')]"
                ]
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "databaseConnectionAlert": {
              "condition": "[and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-database-connection-failures', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Database - Connection Failures",
                "description": "Alert when database connection failures exceed threshold",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "AzureDiagnostics | where ResourceProvider == \"MICROSOFT.SQL\" and Category == \"Errors\" | summarize ErrorCount = count() by Resource | where ErrorCount > 10",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "Resource",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "securityCenterHighSeverityAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-center-high-severity', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security Center - High Severity Recommendations",
                "description": "Alert when Security Center detects high severity security recommendations",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT15M",
                "windowSize": "PT30M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityRecommendation | where RecommendationSeverity == \"High\" | summarize HighSeverityCount = count() by RecommendationName | where HighSeverityCount > 0",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "RecommendationName",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            },
            "securityCenterThreatDetectionAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-center-threat-detection', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security Center - Threat Detection Alerts",
                "description": "Alert when Security Center detects potential security threats",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityAlert | where AlertSeverity in (\"High\", \"Medium\") | summarize ThreatCount = count() by AlertName, AlertSeverity | where ThreatCount > 0",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "AlertName",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        },
                        {
                          "name": "AlertSeverity",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            },
            "securityCenterComplianceAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-center-compliance', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security Center - Compliance Score Degradation",
                "description": "Alert when Security Center compliance score drops below threshold",
                "severity": 2,
                "enabled": true,
                "evaluationFrequency": "PT1H",
                "windowSize": "PT2H",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityRecommendation | summarize CompliancePercentage = (todouble(countif(RecommendationState == \"Completed\")) / todouble(count())) * 100 | where CompliancePercentage < 80",
                      "timeAggregation": "Count",
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "actionGroup"
              ]
            },
            "securityCenterVulnerabilityAlert": {
              "condition": "[and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/scheduledQueryRules",
              "apiVersion": "2023-03-15-preview",
              "name": "[format('{0}-security-center-vulnerabilities', parameters('alertNamePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "displayName": "Security Center - Critical Vulnerabilities Detected",
                "description": "Alert when Security Center detects critical vulnerabilities",
                "severity": 1,
                "enabled": true,
                "evaluationFrequency": "PT30M",
                "windowSize": "PT1H",
                "criteria": {
                  "allOf": [
                    {
                      "query": "SecurityRecommendation | where RecommendationName contains \"vulnerability\" and RecommendationSeverity == \"High\" | summarize CriticalVulnCount = count() by ResourceId | where CriticalVulnCount > 0",
                      "timeAggregation": "Count",
                      "dimensions": [
                        {
                          "name": "ResourceId",
                          "operator": "Include",
                          "values": [
                            "*"
                          ]
                        }
                      ],
                      "operator": "GreaterThan",
                      "threshold": 0,
                      "failingPeriods": {
                        "numberOfEvaluationPeriods": 1,
                        "minFailingPeriodsToAlert": 1
                      }
                    }
                  ]
                },
                "actions": {
                  "actionGroups": [
                    "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
                  ]
                },
                "scopes": [
                  "[parameters('logAnalyticsWorkspaceId')]"
                ]
              },
              "dependsOn": [
                "criticalActionGroup"
              ]
            }
          },
          "outputs": {
            "actionGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the general action group"
              },
              "value": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]"
            },
            "criticalActionGroupId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the critical action group"
              },
              "value": "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]"
            },
            "alertRuleIds": {
              "type": "array",
              "metadata": {
                "description": "The resource IDs of all created alert rules"
              },
              "value": [
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-failed-logins', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-privilege-escalation', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('monitoredResourceIds')))), resourceId('Microsoft.Insights/metricAlerts', format('{0}-performance-high-cpu', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-performance-low-memory', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-performance-low-disk-space', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId')))), resourceId('Microsoft.Insights/metricAlerts', format('{0}-availability-app-insights', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId')))), resourceId('Microsoft.Insights/metricAlerts', format('{0}-availability-response-time', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-database-connection-failures', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-high-severity', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-threat-detection', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-compliance', parameters('alertNamePrefix'))), '')]",
                "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-vulnerabilities', parameters('alertNamePrefix'))), '')]"
              ]
            },
            "alertsConfig": {
              "type": "object",
              "metadata": {
                "description": "The monitoring alerts configuration"
              },
              "value": {
                "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('actionGroupName'))]",
                "criticalActionGroupId": "[resourceId('Microsoft.Insights/actionGroups', variables('criticalActionGroupName'))]",
                "securityAlertsEnabled": "[parameters('enableSecurityAlerts')]",
                "performanceAlertsEnabled": "[parameters('enablePerformanceAlerts')]",
                "availabilityAlertsEnabled": "[parameters('enableAvailabilityAlerts')]",
                "securityCenterAlertsEnabled": "[parameters('enableSecurityAlerts')]",
                "alertRuleCount": "[length(filter(createArray(if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'security1', ''), if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'security2', ''), if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('monitoredResourceIds')))), 'perf1', ''), if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'perf2', ''), if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'perf3', ''), if(and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId')))), 'avail1', ''), if(and(parameters('enableAvailabilityAlerts'), not(empty(parameters('applicationInsightsId')))), 'avail2', ''), if(and(parameters('enablePerformanceAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'db1', ''), if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'sc1', ''), if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'sc2', ''), if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'sc3', ''), if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), 'sc4', '')), lambda('item', not(empty(lambdaVariables('item'))))))]",
                "securityCenterAlerts": {
                  "highSeverityRecommendations": "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-high-severity', parameters('alertNamePrefix'))), '')]",
                  "threatDetection": "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-threat-detection', parameters('alertNamePrefix'))), '')]",
                  "complianceScore": "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-compliance', parameters('alertNamePrefix'))), '')]",
                  "vulnerabilities": "[if(and(parameters('enableSecurityAlerts'), not(empty(parameters('logAnalyticsWorkspaceId')))), resourceId('Microsoft.Insights/scheduledQueryRules', format('{0}-security-center-vulnerabilities', parameters('alertNamePrefix'))), '')]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "applicationGateway",
        "applicationInsights",
        "businessTierVmScaleSet",
        "logAnalyticsWorkspace",
        "sqlServer",
        "storageAccount",
        "webTierVmScaleSet"
      ]
    },
    "keyVaultDiagnostics": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "key-vault-diagnostics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diagnosticSettingName": {
            "value": "[format('{0}-diagnostics', reference('keyVault').outputs.keyVaultName.value)]"
          },
          "targetResourceId": {
            "value": "[reference('keyVault').outputs.keyVaultId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "storageAccountId": {
            "value": "[reference('storageAccount').outputs.storageAccountId.value]"
          },
          "enableAllLogs": {
            "value": true
          },
          "enableAllMetrics": {
            "value": true
          },
          "logRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "metricRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15526568201000582608"
            }
          },
          "parameters": {
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              }
            },
            "targetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the target resource to configure diagnostics for"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "storageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Storage Account for log archival"
              }
            },
            "eventHubAuthorizationRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Event Hub for log streaming"
              }
            },
            "eventHubName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the Event Hub"
              }
            },
            "logRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Log retention period in days for storage account"
              }
            },
            "metricRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Metric retention period in days for storage account"
              }
            },
            "enableAllLogs": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all log categories"
              }
            },
            "enableAllMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all metrics"
              }
            },
            "logCategories": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Specific log categories to enable (if enableAllLogs is false)"
              }
            }
          },
          "variables": {
            "hasLogAnalytics": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
            "hasStorageAccount": "[not(empty(parameters('storageAccountId')))]",
            "hasEventHub": "[and(not(empty(parameters('eventHubAuthorizationRuleId'))), not(empty(parameters('eventHubName'))))]",
            "hasDestination": "[or(or(variables('hasLogAnalytics'), variables('hasStorageAccount')), variables('hasEventHub'))]",
            "commonLogCategories": {
              "Microsoft.KeyVault/vaults": [
                "AuditEvent",
                "AzurePolicyEvaluationDetails"
              ],
              "Microsoft.Storage/storageAccounts": [
                "StorageRead",
                "StorageWrite",
                "StorageDelete"
              ],
              "Microsoft.Sql/servers/databases": [
                "SQLInsights",
                "AutomaticTuning",
                "QueryStoreRuntimeStatistics",
                "QueryStoreWaitStatistics",
                "Errors",
                "DatabaseWaitStatistics",
                "Timeouts",
                "Blocks",
                "Deadlocks"
              ],
              "Microsoft.Network/applicationGateways": [
                "ApplicationGatewayAccessLog",
                "ApplicationGatewayPerformanceLog",
                "ApplicationGatewayFirewallLog"
              ],
              "Microsoft.Network/loadBalancers": [
                "LoadBalancerAlertEvent",
                "LoadBalancerProbeHealthStatus"
              ],
              "Microsoft.Network/networkSecurityGroups": [
                "NetworkSecurityGroupEvent",
                "NetworkSecurityGroupRuleCounter"
              ],
              "Microsoft.Network/virtualNetworks": [
                "VMProtectionAlerts"
              ],
              "Microsoft.Compute/virtualMachines": [
                "Microsoft-Windows-Kernel-Process/Analytic",
                "Microsoft-Windows-Kernel-Network/Analytic"
              ]
            },
            "resourceTypeParts": "[split(parameters('targetResourceId'), '/')]",
            "resourceType": "[if(greater(length(variables('resourceTypeParts')), 7), format('{0}/{1}', variables('resourceTypeParts')[6], variables('resourceTypeParts')[7]), 'Unknown')]",
            "defaultLogCategories": "[if(contains(variables('commonLogCategories'), variables('resourceType')), variables('commonLogCategories')[variables('resourceType')], createArray())]"
          },
          "resources": [
            {
              "condition": "[variables('hasDestination')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('diagnosticSettingName')]",
              "properties": {
                "workspaceId": "[if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), null())]",
                "storageAccountId": "[if(variables('hasStorageAccount'), parameters('storageAccountId'), null())]",
                "eventHubAuthorizationRuleId": "[if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), null())]",
                "eventHubName": "[if(variables('hasEventHub'), parameters('eventHubName'), null())]",
                "logs": "[if(parameters('enableAllLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null())), createObject('categoryGroup', 'audit', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null()))), createArray())]",
                "metrics": "[if(parameters('enableAllMetrics'), createArray(createObject('category', 'AllMetrics', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('metricRetentionDays')), null()))), createArray())]"
              }
            }
          ],
          "outputs": {
            "diagnosticSettingId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), '')]"
            },
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), parameters('diagnosticSettingName'), '')]"
            },
            "diagnosticSettingConfig": {
              "type": "object",
              "metadata": {
                "description": "The configuration of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), createObject('id', resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), 'name', parameters('diagnosticSettingName'), 'targetResourceId', parameters('targetResourceId'), 'workspaceId', if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), ''), 'storageAccountId', if(variables('hasStorageAccount'), parameters('storageAccountId'), ''), 'eventHubAuthorizationRuleId', if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), ''), 'eventHubName', if(variables('hasEventHub'), parameters('eventHubName'), ''), 'logRetentionDays', parameters('logRetentionDays'), 'metricRetentionDays', parameters('metricRetentionDays')), createObject())]"
            }
          }
        }
      },
      "dependsOn": [
        "keyVault",
        "logAnalyticsWorkspace",
        "storageAccount"
      ]
    },
    "applicationGatewayDiagnostics": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "application-gateway-diagnostics-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diagnosticSettingName": {
            "value": "[format('{0}-diagnostics', reference('applicationGateway').outputs.applicationGatewayName.value)]"
          },
          "targetResourceId": {
            "value": "[reference('applicationGateway').outputs.applicationGatewayId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "storageAccountId": {
            "value": "[reference('storageAccount').outputs.storageAccountId.value]"
          },
          "enableAllLogs": {
            "value": true
          },
          "enableAllMetrics": {
            "value": true
          },
          "logRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "metricRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15526568201000582608"
            }
          },
          "parameters": {
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              }
            },
            "targetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the target resource to configure diagnostics for"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "storageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Storage Account for log archival"
              }
            },
            "eventHubAuthorizationRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Event Hub for log streaming"
              }
            },
            "eventHubName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the Event Hub"
              }
            },
            "logRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Log retention period in days for storage account"
              }
            },
            "metricRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Metric retention period in days for storage account"
              }
            },
            "enableAllLogs": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all log categories"
              }
            },
            "enableAllMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all metrics"
              }
            },
            "logCategories": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Specific log categories to enable (if enableAllLogs is false)"
              }
            }
          },
          "variables": {
            "hasLogAnalytics": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
            "hasStorageAccount": "[not(empty(parameters('storageAccountId')))]",
            "hasEventHub": "[and(not(empty(parameters('eventHubAuthorizationRuleId'))), not(empty(parameters('eventHubName'))))]",
            "hasDestination": "[or(or(variables('hasLogAnalytics'), variables('hasStorageAccount')), variables('hasEventHub'))]",
            "commonLogCategories": {
              "Microsoft.KeyVault/vaults": [
                "AuditEvent",
                "AzurePolicyEvaluationDetails"
              ],
              "Microsoft.Storage/storageAccounts": [
                "StorageRead",
                "StorageWrite",
                "StorageDelete"
              ],
              "Microsoft.Sql/servers/databases": [
                "SQLInsights",
                "AutomaticTuning",
                "QueryStoreRuntimeStatistics",
                "QueryStoreWaitStatistics",
                "Errors",
                "DatabaseWaitStatistics",
                "Timeouts",
                "Blocks",
                "Deadlocks"
              ],
              "Microsoft.Network/applicationGateways": [
                "ApplicationGatewayAccessLog",
                "ApplicationGatewayPerformanceLog",
                "ApplicationGatewayFirewallLog"
              ],
              "Microsoft.Network/loadBalancers": [
                "LoadBalancerAlertEvent",
                "LoadBalancerProbeHealthStatus"
              ],
              "Microsoft.Network/networkSecurityGroups": [
                "NetworkSecurityGroupEvent",
                "NetworkSecurityGroupRuleCounter"
              ],
              "Microsoft.Network/virtualNetworks": [
                "VMProtectionAlerts"
              ],
              "Microsoft.Compute/virtualMachines": [
                "Microsoft-Windows-Kernel-Process/Analytic",
                "Microsoft-Windows-Kernel-Network/Analytic"
              ]
            },
            "resourceTypeParts": "[split(parameters('targetResourceId'), '/')]",
            "resourceType": "[if(greater(length(variables('resourceTypeParts')), 7), format('{0}/{1}', variables('resourceTypeParts')[6], variables('resourceTypeParts')[7]), 'Unknown')]",
            "defaultLogCategories": "[if(contains(variables('commonLogCategories'), variables('resourceType')), variables('commonLogCategories')[variables('resourceType')], createArray())]"
          },
          "resources": [
            {
              "condition": "[variables('hasDestination')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('diagnosticSettingName')]",
              "properties": {
                "workspaceId": "[if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), null())]",
                "storageAccountId": "[if(variables('hasStorageAccount'), parameters('storageAccountId'), null())]",
                "eventHubAuthorizationRuleId": "[if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), null())]",
                "eventHubName": "[if(variables('hasEventHub'), parameters('eventHubName'), null())]",
                "logs": "[if(parameters('enableAllLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null())), createObject('categoryGroup', 'audit', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null()))), createArray())]",
                "metrics": "[if(parameters('enableAllMetrics'), createArray(createObject('category', 'AllMetrics', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('metricRetentionDays')), null()))), createArray())]"
              }
            }
          ],
          "outputs": {
            "diagnosticSettingId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), '')]"
            },
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), parameters('diagnosticSettingName'), '')]"
            },
            "diagnosticSettingConfig": {
              "type": "object",
              "metadata": {
                "description": "The configuration of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), createObject('id', resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), 'name', parameters('diagnosticSettingName'), 'targetResourceId', parameters('targetResourceId'), 'workspaceId', if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), ''), 'storageAccountId', if(variables('hasStorageAccount'), parameters('storageAccountId'), ''), 'eventHubAuthorizationRuleId', if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), ''), 'eventHubName', if(variables('hasEventHub'), parameters('eventHubName'), ''), 'logRetentionDays', parameters('logRetentionDays'), 'metricRetentionDays', parameters('metricRetentionDays')), createObject())]"
            }
          }
        }
      },
      "dependsOn": [
        "applicationGateway",
        "logAnalyticsWorkspace",
        "storageAccount"
      ]
    },
    "loadBalancerDiagnostics": {
      "copy": {
        "name": "loadBalancerDiagnostics",
        "count": "[length(createArray('business', 'data'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-tier-load-balancer-diagnostics-deployment', createArray('business', 'data')[copyIndex()])]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diagnosticSettingName": {
            "value": "[format('{0}-tier-load-balancer-diagnostics', createArray('business', 'data')[copyIndex()])]"
          },
          "targetResourceId": "[if(equals(createArray('business', 'data')[copyIndex()], 'business'), createObject('value', reference('businessTierLoadBalancer').outputs.loadBalancerId.value), createObject('value', reference('dataTierLoadBalancer').outputs.loadBalancerId.value))]",
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "storageAccountId": {
            "value": "[reference('storageAccount').outputs.storageAccountId.value]"
          },
          "enableAllLogs": {
            "value": true
          },
          "enableAllMetrics": {
            "value": true
          },
          "logRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "metricRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15526568201000582608"
            }
          },
          "parameters": {
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              }
            },
            "targetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the target resource to configure diagnostics for"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "storageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Storage Account for log archival"
              }
            },
            "eventHubAuthorizationRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Event Hub for log streaming"
              }
            },
            "eventHubName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the Event Hub"
              }
            },
            "logRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Log retention period in days for storage account"
              }
            },
            "metricRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Metric retention period in days for storage account"
              }
            },
            "enableAllLogs": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all log categories"
              }
            },
            "enableAllMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all metrics"
              }
            },
            "logCategories": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Specific log categories to enable (if enableAllLogs is false)"
              }
            }
          },
          "variables": {
            "hasLogAnalytics": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
            "hasStorageAccount": "[not(empty(parameters('storageAccountId')))]",
            "hasEventHub": "[and(not(empty(parameters('eventHubAuthorizationRuleId'))), not(empty(parameters('eventHubName'))))]",
            "hasDestination": "[or(or(variables('hasLogAnalytics'), variables('hasStorageAccount')), variables('hasEventHub'))]",
            "commonLogCategories": {
              "Microsoft.KeyVault/vaults": [
                "AuditEvent",
                "AzurePolicyEvaluationDetails"
              ],
              "Microsoft.Storage/storageAccounts": [
                "StorageRead",
                "StorageWrite",
                "StorageDelete"
              ],
              "Microsoft.Sql/servers/databases": [
                "SQLInsights",
                "AutomaticTuning",
                "QueryStoreRuntimeStatistics",
                "QueryStoreWaitStatistics",
                "Errors",
                "DatabaseWaitStatistics",
                "Timeouts",
                "Blocks",
                "Deadlocks"
              ],
              "Microsoft.Network/applicationGateways": [
                "ApplicationGatewayAccessLog",
                "ApplicationGatewayPerformanceLog",
                "ApplicationGatewayFirewallLog"
              ],
              "Microsoft.Network/loadBalancers": [
                "LoadBalancerAlertEvent",
                "LoadBalancerProbeHealthStatus"
              ],
              "Microsoft.Network/networkSecurityGroups": [
                "NetworkSecurityGroupEvent",
                "NetworkSecurityGroupRuleCounter"
              ],
              "Microsoft.Network/virtualNetworks": [
                "VMProtectionAlerts"
              ],
              "Microsoft.Compute/virtualMachines": [
                "Microsoft-Windows-Kernel-Process/Analytic",
                "Microsoft-Windows-Kernel-Network/Analytic"
              ]
            },
            "resourceTypeParts": "[split(parameters('targetResourceId'), '/')]",
            "resourceType": "[if(greater(length(variables('resourceTypeParts')), 7), format('{0}/{1}', variables('resourceTypeParts')[6], variables('resourceTypeParts')[7]), 'Unknown')]",
            "defaultLogCategories": "[if(contains(variables('commonLogCategories'), variables('resourceType')), variables('commonLogCategories')[variables('resourceType')], createArray())]"
          },
          "resources": [
            {
              "condition": "[variables('hasDestination')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('diagnosticSettingName')]",
              "properties": {
                "workspaceId": "[if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), null())]",
                "storageAccountId": "[if(variables('hasStorageAccount'), parameters('storageAccountId'), null())]",
                "eventHubAuthorizationRuleId": "[if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), null())]",
                "eventHubName": "[if(variables('hasEventHub'), parameters('eventHubName'), null())]",
                "logs": "[if(parameters('enableAllLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null())), createObject('categoryGroup', 'audit', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null()))), createArray())]",
                "metrics": "[if(parameters('enableAllMetrics'), createArray(createObject('category', 'AllMetrics', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('metricRetentionDays')), null()))), createArray())]"
              }
            }
          ],
          "outputs": {
            "diagnosticSettingId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), '')]"
            },
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), parameters('diagnosticSettingName'), '')]"
            },
            "diagnosticSettingConfig": {
              "type": "object",
              "metadata": {
                "description": "The configuration of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), createObject('id', resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), 'name', parameters('diagnosticSettingName'), 'targetResourceId', parameters('targetResourceId'), 'workspaceId', if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), ''), 'storageAccountId', if(variables('hasStorageAccount'), parameters('storageAccountId'), ''), 'eventHubAuthorizationRuleId', if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), ''), 'eventHubName', if(variables('hasEventHub'), parameters('eventHubName'), ''), 'logRetentionDays', parameters('logRetentionDays'), 'metricRetentionDays', parameters('metricRetentionDays')), createObject())]"
            }
          }
        }
      },
      "dependsOn": [
        "businessTierLoadBalancer",
        "dataTierLoadBalancer",
        "logAnalyticsWorkspace",
        "storageAccount"
      ]
    },
    "networkSecurityGroupDiagnostics": {
      "copy": {
        "name": "networkSecurityGroupDiagnostics",
        "count": "[length(createArray('web', 'business', 'data', 'management'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-tier-nsg-diagnostics-deployment', createArray('web', 'business', 'data', 'management')[copyIndex()])]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diagnosticSettingName": {
            "value": "[format('{0}-tier-nsg-diagnostics', createArray('web', 'business', 'data', 'management')[copyIndex()])]"
          },
          "targetResourceId": {
            "value": "[reference('networkSecurityGroups').outputs.nsgIds.value[format('{0}Tier', createArray('web', 'business', 'data', 'management')[copyIndex()])]]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "storageAccountId": {
            "value": "[reference('storageAccount').outputs.storageAccountId.value]"
          },
          "enableAllLogs": {
            "value": true
          },
          "enableAllMetrics": {
            "value": true
          },
          "logRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          },
          "metricRetentionDays": {
            "value": "[parameters('environmentConfig').logRetentionDays]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15526568201000582608"
            }
          },
          "parameters": {
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              }
            },
            "targetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the target resource to configure diagnostics for"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              }
            },
            "storageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Storage Account for log archival"
              }
            },
            "eventHubAuthorizationRuleId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The resource ID of the Event Hub for log streaming"
              }
            },
            "eventHubName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "The name of the Event Hub"
              }
            },
            "logRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Log retention period in days for storage account"
              }
            },
            "metricRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Metric retention period in days for storage account"
              }
            },
            "enableAllLogs": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all log categories"
              }
            },
            "enableAllMetrics": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable all metrics"
              }
            },
            "logCategories": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Specific log categories to enable (if enableAllLogs is false)"
              }
            }
          },
          "variables": {
            "hasLogAnalytics": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
            "hasStorageAccount": "[not(empty(parameters('storageAccountId')))]",
            "hasEventHub": "[and(not(empty(parameters('eventHubAuthorizationRuleId'))), not(empty(parameters('eventHubName'))))]",
            "hasDestination": "[or(or(variables('hasLogAnalytics'), variables('hasStorageAccount')), variables('hasEventHub'))]",
            "commonLogCategories": {
              "Microsoft.KeyVault/vaults": [
                "AuditEvent",
                "AzurePolicyEvaluationDetails"
              ],
              "Microsoft.Storage/storageAccounts": [
                "StorageRead",
                "StorageWrite",
                "StorageDelete"
              ],
              "Microsoft.Sql/servers/databases": [
                "SQLInsights",
                "AutomaticTuning",
                "QueryStoreRuntimeStatistics",
                "QueryStoreWaitStatistics",
                "Errors",
                "DatabaseWaitStatistics",
                "Timeouts",
                "Blocks",
                "Deadlocks"
              ],
              "Microsoft.Network/applicationGateways": [
                "ApplicationGatewayAccessLog",
                "ApplicationGatewayPerformanceLog",
                "ApplicationGatewayFirewallLog"
              ],
              "Microsoft.Network/loadBalancers": [
                "LoadBalancerAlertEvent",
                "LoadBalancerProbeHealthStatus"
              ],
              "Microsoft.Network/networkSecurityGroups": [
                "NetworkSecurityGroupEvent",
                "NetworkSecurityGroupRuleCounter"
              ],
              "Microsoft.Network/virtualNetworks": [
                "VMProtectionAlerts"
              ],
              "Microsoft.Compute/virtualMachines": [
                "Microsoft-Windows-Kernel-Process/Analytic",
                "Microsoft-Windows-Kernel-Network/Analytic"
              ]
            },
            "resourceTypeParts": "[split(parameters('targetResourceId'), '/')]",
            "resourceType": "[if(greater(length(variables('resourceTypeParts')), 7), format('{0}/{1}', variables('resourceTypeParts')[6], variables('resourceTypeParts')[7]), 'Unknown')]",
            "defaultLogCategories": "[if(contains(variables('commonLogCategories'), variables('resourceType')), variables('commonLogCategories')[variables('resourceType')], createArray())]"
          },
          "resources": [
            {
              "condition": "[variables('hasDestination')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('diagnosticSettingName')]",
              "properties": {
                "workspaceId": "[if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), null())]",
                "storageAccountId": "[if(variables('hasStorageAccount'), parameters('storageAccountId'), null())]",
                "eventHubAuthorizationRuleId": "[if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), null())]",
                "eventHubName": "[if(variables('hasEventHub'), parameters('eventHubName'), null())]",
                "logs": "[if(parameters('enableAllLogs'), createArray(createObject('categoryGroup', 'allLogs', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null())), createObject('categoryGroup', 'audit', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('logRetentionDays')), null()))), createArray())]",
                "metrics": "[if(parameters('enableAllMetrics'), createArray(createObject('category', 'AllMetrics', 'enabled', true(), 'retentionPolicy', if(variables('hasStorageAccount'), createObject('enabled', true(), 'days', parameters('metricRetentionDays')), null()))), createArray())]"
              }
            }
          ],
          "outputs": {
            "diagnosticSettingId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), '')]"
            },
            "diagnosticSettingName": {
              "type": "string",
              "metadata": {
                "description": "The name of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), parameters('diagnosticSettingName'), '')]"
            },
            "diagnosticSettingConfig": {
              "type": "object",
              "metadata": {
                "description": "The configuration of the diagnostic setting"
              },
              "value": "[if(variables('hasDestination'), createObject('id', resourceId('Microsoft.Insights/diagnosticSettings', parameters('diagnosticSettingName')), 'name', parameters('diagnosticSettingName'), 'targetResourceId', parameters('targetResourceId'), 'workspaceId', if(variables('hasLogAnalytics'), parameters('logAnalyticsWorkspaceId'), ''), 'storageAccountId', if(variables('hasStorageAccount'), parameters('storageAccountId'), ''), 'eventHubAuthorizationRuleId', if(variables('hasEventHub'), parameters('eventHubAuthorizationRuleId'), ''), 'eventHubName', if(variables('hasEventHub'), parameters('eventHubName'), ''), 'logRetentionDays', parameters('logRetentionDays'), 'metricRetentionDays', parameters('metricRetentionDays')), createObject())]"
            }
          }
        }
      },
      "dependsOn": [
        "logAnalyticsWorkspace",
        "networkSecurityGroups",
        "storageAccount"
      ]
    },
    "sqlServer": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sql-server-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "sqlServerName": {
            "value": "[reference('namingConventions').outputs.namingConvention.value.sqlServer]"
          },
          "sqlDatabaseName": {
            "value": "[replace(reference('namingConventions').outputs.namingConvention.value.sqlDatabase, '{dbName}', parameters('workloadName'))]"
          },
          "administratorLogin": {
            "value": "sqladmin"
          },
          "administratorLoginPassword": {
            "value": "P@ssw0rd123!"
          },
          "databaseSku": {
            "value": {
              "name": "[parameters('environmentConfig').sqlDatabaseSku]",
              "tier": "[parameters('environmentConfig').sqlDatabaseSku]",
              "capacity": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), 5, if(equals(parameters('environmentConfig').skuTier, 'Standard'), 20, 100))]"
            }
          },
          "maxSizeBytes": "[if(equals(parameters('environmentConfig').skuTier, 'Basic'), createObject('value', json('2147483648')), if(equals(parameters('environmentConfig').skuTier, 'Standard'), createObject('value', json('268435456000')), createObject('value', json('1099511627776'))))]",
          "enableAzureAdAuthentication": {
            "value": true
          },
          "azureAdAdministratorObjectId": {
            "value": "[reference('managedIdentities').outputs.managedIdentityLookup.value.sqlAccess.principalId]"
          },
          "azureAdAdministratorLogin": {
            "value": "SQL Administrators"
          },
          "enableTransparentDataEncryption": {
            "value": true
          },
          "enableAdvancedDataSecurity": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "enableVulnerabilityAssessment": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "vulnerabilityAssessmentStorageEndpoint": "[if(not(equals(parameters('environment'), 'dev')), createObject('value', reference('storageAccount').outputs.storageAccountEndpoints.value.blob), createObject('value', ''))]",
          "vulnerabilityAssessmentStorageAccessKey": "[if(not(equals(parameters('environment'), 'dev')), createObject('value', reference('storageAccount').outputs.storageAccountKey.value), createObject('value', ''))]",
          "enablePublicNetworkAccess": {
            "value": "[not(parameters('environmentConfig').enablePrivateEndpoints)]"
          },
          "allowedSubnetIds": "[if(parameters('environmentConfig').enablePrivateEndpoints, createObject('value', createArray()), createObject('value', createArray(reference('virtualNetwork').outputs.subnetIds.value.dataTier, reference('virtualNetwork').outputs.subnetIds.value.businessTier, reference('virtualNetwork').outputs.subnetIds.value.management)))]",
          "allowedIpAddresses": {
            "value": []
          },
          "minimalTlsVersion": {
            "value": "1.2"
          },
          "backupRetentionDays": "[if(equals(parameters('environment'), 'prod'), createObject('value', 35), createObject('value', 7))]",
          "enableGeoRedundantBackup": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "enableLongTermRetention": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "longTermRetentionBackup": "[if(equals(parameters('environment'), 'prod'), createObject('value', createObject('weeklyRetention', 'P12W', 'monthlyRetention', 'P12M', 'yearlyRetention', 'P7Y', 'weekOfYear', 1)), createObject('value', createObject('weeklyRetention', 'PT0S', 'monthlyRetention', 'PT0S', 'yearlyRetention', 'PT0S', 'weekOfYear', 1)))]",
          "enableDiagnosticSettings": {
            "value": true
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "diagnosticStorageAccountId": {
            "value": "[reference('storageAccount').outputs.storageAccountId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9996807611789975777"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Server"
              }
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Database"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "administratorLogin": {
              "type": "string",
              "metadata": {
                "description": "SQL Server administrator login name"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "SQL Server administrator password (should come from Key Vault)"
              }
            },
            "databaseSku": {
              "type": "object",
              "defaultValue": {
                "name": "Standard",
                "tier": "Standard",
                "capacity": 20
              },
              "metadata": {
                "description": "SQL Database SKU configuration"
              }
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 268435456000,
              "metadata": {
                "description": "Maximum database size in bytes"
              }
            },
            "enableAzureAdAuthentication": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Azure AD authentication"
              }
            },
            "azureAdAdministratorObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD administrator object ID"
              }
            },
            "azureAdAdministratorLogin": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AD administrator login name"
              }
            },
            "enableTransparentDataEncryption": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Transparent Data Encryption"
              }
            },
            "enableAdvancedDataSecurity": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable Advanced Data Security"
              }
            },
            "enableVulnerabilityAssessment": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable vulnerability assessment"
              }
            },
            "vulnerabilityAssessmentStorageEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account endpoint for vulnerability assessment"
              }
            },
            "vulnerabilityAssessmentStorageAccessKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account access key for vulnerability assessment"
              }
            },
            "enablePublicNetworkAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public network access"
              }
            },
            "allowedSubnetIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed subnet IDs for firewall rules"
              }
            },
            "allowedIpAddresses": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed IP addresses for firewall rules"
              }
            },
            "minimalTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "allowedValues": [
                "1.0",
                "1.1",
                "1.2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 7,
              "maxValue": 35,
              "metadata": {
                "description": "Backup retention period in days"
              }
            },
            "enableGeoRedundantBackup": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable geo-redundant backup"
              }
            },
            "enableLongTermRetention": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable long-term retention backup"
              }
            },
            "longTermRetentionBackup": {
              "type": "object",
              "defaultValue": {
                "weeklyRetention": "PT0S",
                "monthlyRetention": "PT0S",
                "yearlyRetention": "PT0S",
                "weekOfYear": 1
              },
              "metadata": {
                "description": "Long-term retention backup configuration"
              }
            },
            "enableDiagnosticSettings": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for diagnostic settings"
              }
            },
            "diagnosticStorageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account ID for diagnostic settings"
              }
            }
          },
          "variables": {
            "sqlServerResourceName": "[parameters('sqlServerName')]",
            "sqlDatabaseResourceName": "[parameters('sqlDatabaseName')]"
          },
          "resources": {
            "sqlServer": {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-05-01-preview",
              "name": "[variables('sqlServerResourceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "[parameters('administratorLogin')]",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "version": "12.0",
                "minimalTlsVersion": "[parameters('minimalTlsVersion')]",
                "publicNetworkAccess": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]",
                "restrictOutboundNetworkAccess": "Disabled"
              },
              "identity": "[if(parameters('enableAzureAdAuthentication'), createObject('type', 'SystemAssigned'), null())]"
            },
            "sqlServerAzureAdAdministrator": {
              "condition": "[and(parameters('enableAzureAdAuthentication'), not(empty(parameters('azureAdAdministratorObjectId'))))]",
              "type": "Microsoft.Sql/servers/administrators",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), 'ActiveDirectory')]",
              "properties": {
                "administratorType": "ActiveDirectory",
                "login": "[parameters('azureAdAdministratorLogin')]",
                "sid": "[parameters('azureAdAdministratorObjectId')]",
                "tenantId": "[tenant().tenantId]"
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "sqlDatabase": {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": "[parameters('databaseSku')]",
              "properties": {
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
                "zoneRedundant": "[or(equals(parameters('databaseSku').tier, 'Premium'), equals(parameters('databaseSku').tier, 'BusinessCritical'))]",
                "readScale": "[if(or(equals(parameters('databaseSku').tier, 'Premium'), equals(parameters('databaseSku').tier, 'BusinessCritical')), 'Enabled', 'Disabled')]",
                "requestedBackupStorageRedundancy": "[if(parameters('enableGeoRedundantBackup'), 'Geo', 'Local')]",
                "isLedgerOn": false
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "transparentDataEncryption": {
              "condition": "[parameters('enableTransparentDataEncryption')]",
              "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'), 'current')]",
              "properties": {
                "state": "Enabled"
              },
              "dependsOn": [
                "sqlDatabase"
              ]
            },
            "advancedDataSecurity": {
              "condition": "[parameters('enableAdvancedDataSecurity')]",
              "type": "Microsoft.Sql/servers/securityAlertPolicies",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), 'default')]",
              "properties": {
                "state": "Enabled",
                "emailAccountAdmins": true,
                "emailAddresses": [],
                "retentionDays": 30,
                "storageEndpoint": "[if(not(empty(parameters('vulnerabilityAssessmentStorageEndpoint'))), parameters('vulnerabilityAssessmentStorageEndpoint'), null())]",
                "storageAccountAccessKey": "[if(not(empty(parameters('vulnerabilityAssessmentStorageAccessKey'))), parameters('vulnerabilityAssessmentStorageAccessKey'), null())]"
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "vulnerabilityAssessment": {
              "condition": "[and(parameters('enableVulnerabilityAssessment'), not(empty(parameters('vulnerabilityAssessmentStorageEndpoint'))))]",
              "type": "Microsoft.Sql/servers/vulnerabilityAssessments",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), 'default')]",
              "properties": {
                "storageContainerPath": "[format('{0}vulnerability-assessment', parameters('vulnerabilityAssessmentStorageEndpoint'))]",
                "storageAccountAccessKey": "[parameters('vulnerabilityAssessmentStorageAccessKey')]",
                "recurringScans": {
                  "isEnabled": true,
                  "emailSubscriptionAdmins": true,
                  "emails": []
                }
              },
              "dependsOn": [
                "advancedDataSecurity",
                "sqlServer"
              ]
            },
            "subnetFirewallRules": {
              "copy": {
                "name": "subnetFirewallRules",
                "count": "[length(parameters('allowedSubnetIds'))]"
              },
              "type": "Microsoft.Sql/servers/virtualNetworkRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), format('subnet-rule-{0}', copyIndex()))]",
              "properties": {
                "virtualNetworkSubnetId": "[parameters('allowedSubnetIds')[copyIndex()]]",
                "ignoreMissingVnetServiceEndpoint": false
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "ipFirewallRules": {
              "copy": {
                "name": "ipFirewallRules",
                "count": "[length(parameters('allowedIpAddresses'))]"
              },
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), format('ip-rule-{0}', copyIndex()))]",
              "properties": {
                "startIpAddress": "[parameters('allowedIpAddresses')[copyIndex()]]",
                "endIpAddress": "[parameters('allowedIpAddresses')[copyIndex()]]"
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "azureServicesFirewallRule": {
              "condition": "[parameters('enablePublicNetworkAccess')]",
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}', variables('sqlServerResourceName'), 'AllowAllWindowsAzureIps')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "longTermRetentionPolicy": {
              "condition": "[parameters('enableLongTermRetention')]",
              "type": "Microsoft.Sql/servers/databases/backupLongTermRetentionPolicies",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'), 'default')]",
              "properties": {
                "weeklyRetention": "[parameters('longTermRetentionBackup').weeklyRetention]",
                "monthlyRetention": "[parameters('longTermRetentionBackup').monthlyRetention]",
                "yearlyRetention": "[parameters('longTermRetentionBackup').yearlyRetention]",
                "weekOfYear": "[parameters('longTermRetentionBackup').weekOfYear]"
              },
              "dependsOn": [
                "sqlDatabase"
              ]
            },
            "shortTermRetentionPolicy": {
              "type": "Microsoft.Sql/servers/databases/backupShortTermRetentionPolicies",
              "apiVersion": "2023-05-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'), 'default')]",
              "properties": {
                "retentionDays": "[parameters('backupRetentionDays')]"
              },
              "dependsOn": [
                "sqlDatabase"
              ]
            },
            "sqlServerDiagnosticSettings": {
              "condition": "[and(parameters('enableDiagnosticSettings'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Sql/servers/{0}', variables('sqlServerResourceName'))]",
              "name": "[format('{0}-diagnostics', variables('sqlServerResourceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "sqlServer"
              ]
            },
            "sqlDatabaseDiagnosticSettings": {
              "condition": "[and(parameters('enableDiagnosticSettings'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Sql/servers/{0}/databases/{1}', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'))]",
              "name": "[format('{0}-diagnostics', variables('sqlDatabaseResourceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "sqlDatabase"
              ]
            }
          },
          "outputs": {
            "sqlServerId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the SQL Server"
              },
              "value": "[resourceId('Microsoft.Sql/servers', variables('sqlServerResourceName'))]"
            },
            "sqlServerName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Server"
              },
              "value": "[variables('sqlServerResourceName')]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "metadata": {
                "description": "The fully qualified domain name of the SQL Server"
              },
              "value": "[reference('sqlServer').fullyQualifiedDomainName]"
            },
            "sqlDatabaseId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the SQL Database"
              },
              "value": "[resourceId('Microsoft.Sql/servers/databases', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'))]"
            },
            "sqlDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the SQL Database"
              },
              "value": "[variables('sqlDatabaseResourceName')]"
            },
            "connectionStringTemplate": {
              "type": "string",
              "metadata": {
                "description": "The connection string for the SQL Database (without password)"
              },
              "value": "[format('Server=tcp:{0},1433;Initial Catalog={1};Persist Security Info=False;User ID={2};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', reference('sqlServer').fullyQualifiedDomainName, variables('sqlDatabaseResourceName'), parameters('administratorLogin'))]"
            },
            "sqlServerConfig": {
              "type": "object",
              "metadata": {
                "description": "SQL Server configuration details"
              },
              "value": {
                "id": "[resourceId('Microsoft.Sql/servers', variables('sqlServerResourceName'))]",
                "name": "[variables('sqlServerResourceName')]",
                "fqdn": "[reference('sqlServer').fullyQualifiedDomainName]",
                "version": "[reference('sqlServer').version]",
                "administratorLogin": "[reference('sqlServer').administratorLogin]",
                "minimalTlsVersion": "[reference('sqlServer').minimalTlsVersion]",
                "publicNetworkAccess": "[reference('sqlServer').publicNetworkAccess]",
                "azureAdOnlyAuthentication": "[parameters('enableAzureAdAuthentication')]",
                "enabledFeatures": {
                  "transparentDataEncryption": "[parameters('enableTransparentDataEncryption')]",
                  "advancedDataSecurity": "[parameters('enableAdvancedDataSecurity')]",
                  "vulnerabilityAssessment": "[parameters('enableVulnerabilityAssessment')]",
                  "longTermRetention": "[parameters('enableLongTermRetention')]",
                  "diagnosticSettings": "[parameters('enableDiagnosticSettings')]"
                }
              }
            },
            "sqlDatabaseConfig": {
              "type": "object",
              "metadata": {
                "description": "SQL Database configuration details"
              },
              "value": {
                "id": "[resourceId('Microsoft.Sql/servers/databases', variables('sqlServerResourceName'), variables('sqlDatabaseResourceName'))]",
                "name": "[variables('sqlDatabaseResourceName')]",
                "sku": "[reference('sqlDatabase', '2023-05-01-preview', 'full').sku]",
                "maxSizeBytes": "[reference('sqlDatabase').maxSizeBytes]",
                "collation": "[reference('sqlDatabase').collation]",
                "zoneRedundant": "[reference('sqlDatabase').zoneRedundant]",
                "readScale": "[reference('sqlDatabase').readScale]",
                "backupStorageRedundancy": "[reference('sqlDatabase').requestedBackupStorageRedundancy]",
                "backupRetentionDays": "[parameters('backupRetentionDays')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "keyVault",
        "logAnalyticsWorkspace",
        "managedIdentities",
        "namingConventions",
        "storageAccount",
        "virtualNetwork"
      ]
    },
    "storageAccount": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-account-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[reference('namingConventions').outputs.specializedNames.value.storageAccount]"
          },
          "storageAccountSku": {
            "value": "[parameters('environmentConfig').storageAccountSku]"
          },
          "storageAccountKind": {
            "value": "StorageV2"
          },
          "accessTier": {
            "value": "Hot"
          },
          "enableHierarchicalNamespace": {
            "value": false
          },
          "enableLargeFileShares": {
            "value": false
          },
          "enableSftp": {
            "value": false
          },
          "enablePublicNetworkAccess": {
            "value": "[not(parameters('environmentConfig').enablePrivateEndpoints)]"
          },
          "allowedSubnetIds": "[if(parameters('environmentConfig').enablePrivateEndpoints, createObject('value', createArray()), createObject('value', createArray(reference('virtualNetwork').outputs.subnetIds.value.dataTier, reference('virtualNetwork').outputs.subnetIds.value.businessTier, reference('virtualNetwork').outputs.subnetIds.value.webTier, reference('virtualNetwork').outputs.subnetIds.value.management)))]",
          "allowedIpAddresses": {
            "value": []
          },
          "defaultNetworkAccessRule": "[if(parameters('environmentConfig').enablePrivateEndpoints, createObject('value', 'Deny'), createObject('value', 'Allow'))]",
          "networkRulesBypass": {
            "value": "AzureServices"
          },
          "minimumTlsVersion": {
            "value": "TLS1_2"
          },
          "enableHttpsTrafficOnly": {
            "value": true
          },
          "enableBlobPublicAccess": {
            "value": false
          },
          "enableSharedKeyAccess": {
            "value": true
          },
          "enableInfrastructureEncryption": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "customerManagedKey": {
            "value": {
              "enabled": "[equals(parameters('environment'), 'prod')]",
              "keyVaultId": "[if(equals(parameters('environment'), 'prod'), reference('keyVault').outputs.keyVaultId.value, '')]",
              "keyName": "[if(equals(parameters('environment'), 'prod'), 'storage-encryption-key', '')]",
              "keyVersion": "",
              "userAssignedIdentityId": "[if(equals(parameters('environment'), 'prod'), reference('managedIdentities').outputs.managedIdentityLookup.value.storageAccess.id, '')]"
            }
          },
          "enableBlobVersioning": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "enableBlobChangeFeed": {
            "value": "[not(equals(parameters('environment'), 'dev'))]"
          },
          "enableBlobPointInTimeRestore": {
            "value": false
          },
          "pointInTimeRestoreRetentionDays": {
            "value": 7
          },
          "enableBlobSoftDelete": {
            "value": true
          },
          "blobSoftDeleteRetentionDays": "[if(equals(parameters('environment'), 'prod'), createObject('value', 30), createObject('value', 7))]",
          "enableContainerSoftDelete": {
            "value": true
          },
          "containerSoftDeleteRetentionDays": "[if(equals(parameters('environment'), 'prod'), createObject('value', 30), createObject('value', 7))]",
          "enableLifecycleManagement": {
            "value": true
          },
          "lifecycleRules": {
            "value": [
              {
                "name": "default-lifecycle-rule",
                "enabled": true,
                "type": "Lifecycle",
                "definition": {
                  "filters": {
                    "blobTypes": [
                      "blockBlob"
                    ],
                    "prefixMatch": []
                  },
                  "actions": {
                    "baseBlob": {
                      "tierToCool": {
                        "daysAfterModificationGreaterThan": "[if(equals(parameters('environment'), 'prod'), 30, 90)]"
                      },
                      "tierToArchive": {
                        "daysAfterModificationGreaterThan": "[if(equals(parameters('environment'), 'prod'), 90, 180)]"
                      },
                      "delete": {
                        "daysAfterModificationGreaterThan": "[if(equals(parameters('environment'), 'prod'), 2555, 365)]"
                      }
                    },
                    "snapshot": {
                      "delete": {
                        "daysAfterCreationGreaterThan": "[if(equals(parameters('environment'), 'prod'), 90, 30)]"
                      }
                    },
                    "version": {
                      "delete": {
                        "daysAfterCreationGreaterThan": "[if(equals(parameters('environment'), 'prod'), 90, 30)]"
                      }
                    }
                  }
                }
              }
            ]
          },
          "enableDiagnosticSettings": {
            "value": true
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]"
          },
          "diagnosticStorageAccountId": {
            "value": ""
          },
          "blobContainers": {
            "value": [
              {
                "name": "application-data",
                "publicAccess": "None",
                "metadata": {
                  "purpose": "Application data storage",
                  "tier": "data"
                }
              },
              {
                "name": "application-logs",
                "publicAccess": "None",
                "metadata": {
                  "purpose": "Application log storage",
                  "tier": "logging"
                }
              },
              {
                "name": "database-backups",
                "publicAccess": "None",
                "metadata": {
                  "purpose": "Database backup storage",
                  "tier": "backup"
                }
              },
              {
                "name": "vulnerability-assessment",
                "publicAccess": "None",
                "metadata": {
                  "purpose": "SQL vulnerability assessment reports",
                  "tier": "security"
                }
              }
            ]
          },
          "fileShares": {
            "value": [
              {
                "name": "shared-files",
                "shareQuota": "[if(equals(parameters('environment'), 'prod'), 1024, 100)]",
                "enabledProtocols": "SMB",
                "accessTier": "TransactionOptimized"
              }
            ]
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7179710638109364672"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "storageAccountSku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_ZRS",
                "Standard_GZRS",
                "Premium_LRS",
                "Premium_ZRS"
              ],
              "metadata": {
                "description": "Storage account SKU"
              }
            },
            "storageAccountKind": {
              "type": "string",
              "defaultValue": "StorageV2",
              "allowedValues": [
                "Storage",
                "StorageV2",
                "BlobStorage",
                "FileStorage",
                "BlockBlobStorage"
              ],
              "metadata": {
                "description": "Storage account kind"
              }
            },
            "accessTier": {
              "type": "string",
              "defaultValue": "Hot",
              "allowedValues": [
                "Hot",
                "Cool"
              ],
              "metadata": {
                "description": "Storage account access tier"
              }
            },
            "enableHierarchicalNamespace": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable hierarchical namespace (Data Lake Gen2)"
              }
            },
            "enableLargeFileShares": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable large file shares"
              }
            },
            "enableSftp": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable SFTP"
              }
            },
            "enablePublicNetworkAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable public network access"
              }
            },
            "allowedSubnetIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed subnet IDs for network rules"
              }
            },
            "allowedIpAddresses": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Allowed IP addresses for network rules"
              }
            },
            "defaultNetworkAccessRule": {
              "type": "string",
              "defaultValue": "Deny",
              "allowedValues": [
                "Allow",
                "Deny"
              ],
              "metadata": {
                "description": "Default network access rule"
              }
            },
            "networkRulesBypass": {
              "type": "string",
              "defaultValue": "AzureServices",
              "allowedValues": [
                "None",
                "AzureServices",
                "Logging",
                "Metrics"
              ],
              "metadata": {
                "description": "Bypass network rules for Azure services"
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2",
              "allowedValues": [
                "TLS1_0",
                "TLS1_1",
                "TLS1_2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            },
            "enableHttpsTrafficOnly": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable HTTPS traffic only"
              }
            },
            "enableBlobPublicAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable blob public access"
              }
            },
            "enableSharedKeyAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable shared key access"
              }
            },
            "enableInfrastructureEncryption": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable infrastructure encryption"
              }
            },
            "customerManagedKey": {
              "type": "object",
              "defaultValue": {
                "enabled": false,
                "keyVaultId": "",
                "keyName": "",
                "keyVersion": "",
                "userAssignedIdentityId": ""
              },
              "metadata": {
                "description": "Customer-managed key configuration"
              }
            },
            "enableBlobVersioning": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable blob versioning"
              }
            },
            "enableBlobChangeFeed": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable blob change feed"
              }
            },
            "enableBlobPointInTimeRestore": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable blob point-in-time restore"
              }
            },
            "pointInTimeRestoreRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Point-in-time restore retention days"
              }
            },
            "enableBlobSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable blob soft delete"
              }
            },
            "blobSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Blob soft delete retention days"
              }
            },
            "enableContainerSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable container soft delete"
              }
            },
            "containerSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "minValue": 1,
              "maxValue": 365,
              "metadata": {
                "description": "Container soft delete retention days"
              }
            },
            "enableLifecycleManagement": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable lifecycle management"
              }
            },
            "lifecycleRules": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "default-lifecycle-rule",
                  "enabled": true,
                  "type": "Lifecycle",
                  "definition": {
                    "filters": {
                      "blobTypes": [
                        "blockBlob"
                      ],
                      "prefixMatch": []
                    },
                    "actions": {
                      "baseBlob": {
                        "tierToCool": {
                          "daysAfterModificationGreaterThan": 30
                        },
                        "tierToArchive": {
                          "daysAfterModificationGreaterThan": 90
                        },
                        "delete": {
                          "daysAfterModificationGreaterThan": 365
                        }
                      },
                      "snapshot": {
                        "delete": {
                          "daysAfterCreationGreaterThan": 30
                        }
                      },
                      "version": {
                        "delete": {
                          "daysAfterCreationGreaterThan": 30
                        }
                      }
                    }
                  }
                }
              ],
              "metadata": {
                "description": "Lifecycle management rules"
              }
            },
            "enableDiagnosticSettings": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable diagnostic settings"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics workspace ID for diagnostic settings"
              }
            },
            "diagnosticStorageAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account ID for diagnostic settings"
              }
            },
            "blobContainers": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "data",
                  "publicAccess": "None",
                  "metadata": {}
                },
                {
                  "name": "logs",
                  "publicAccess": "None",
                  "metadata": {}
                },
                {
                  "name": "backups",
                  "publicAccess": "None",
                  "metadata": {}
                }
              ],
              "metadata": {
                "description": "Blob containers to create"
              }
            },
            "fileShares": {
              "type": "array",
              "defaultValue": [
                {
                  "name": "shared",
                  "shareQuota": 100,
                  "enabledProtocols": "SMB",
                  "accessTier": "TransactionOptimized"
                }
              ],
              "metadata": {
                "description": "File shares to create"
              }
            }
          },
          "variables": {
            "storageAccountResourceName": "[parameters('storageAccountName')]"
          },
          "resources": {
            "storageAccount": {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountResourceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('storageAccountSku')]"
              },
              "kind": "[parameters('storageAccountKind')]",
              "identity": "[if(parameters('customerManagedKey').enabled, createObject('type', 'UserAssigned', 'userAssignedIdentities', createObject(format('{0}', parameters('customerManagedKey').userAssignedIdentityId), createObject())), createObject('type', 'SystemAssigned'))]",
              "properties": {
                "accessTier": "[parameters('accessTier')]",
                "allowBlobPublicAccess": "[parameters('enableBlobPublicAccess')]",
                "allowSharedKeyAccess": "[parameters('enableSharedKeyAccess')]",
                "allowCrossTenantReplication": false,
                "defaultToOAuthAuthentication": true,
                "dnsEndpointType": "Standard",
                "isHnsEnabled": "[parameters('enableHierarchicalNamespace')]",
                "isLocalUserEnabled": "[parameters('enableSftp')]",
                "isNfsV3Enabled": false,
                "isSftpEnabled": "[parameters('enableSftp')]",
                "largeFileSharesState": "[if(parameters('enableLargeFileShares'), 'Enabled', 'Disabled')]",
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "publicNetworkAccess": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]",
                "supportsHttpsTrafficOnly": "[parameters('enableHttpsTrafficOnly')]",
                "networkAcls": {
                  "copy": [
                    {
                      "name": "ipRules",
                      "count": "[length(parameters('allowedIpAddresses'))]",
                      "input": {
                        "value": "[parameters('allowedIpAddresses')[copyIndex('ipRules')]]",
                        "action": "Allow"
                      }
                    },
                    {
                      "name": "virtualNetworkRules",
                      "count": "[length(parameters('allowedSubnetIds'))]",
                      "input": {
                        "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]",
                        "action": "Allow",
                        "state": "Succeeded"
                      }
                    }
                  ],
                  "bypass": "[parameters('networkRulesBypass')]",
                  "defaultAction": "[parameters('defaultNetworkAccessRule')]"
                },
                "encryption": {
                  "requireInfrastructureEncryption": "[parameters('enableInfrastructureEncryption')]",
                  "services": {
                    "blob": {
                      "enabled": true,
                      "keyType": "[if(parameters('customerManagedKey').enabled, 'Account', 'Service')]"
                    },
                    "file": {
                      "enabled": true,
                      "keyType": "[if(parameters('customerManagedKey').enabled, 'Account', 'Service')]"
                    },
                    "table": {
                      "enabled": true,
                      "keyType": "Service"
                    },
                    "queue": {
                      "enabled": true,
                      "keyType": "Service"
                    }
                  },
                  "keySource": "[if(parameters('customerManagedKey').enabled, 'Microsoft.Keyvault', 'Microsoft.Storage')]",
                  "keyvaultproperties": "[if(parameters('customerManagedKey').enabled, createObject('keyname', parameters('customerManagedKey').keyName, 'keyversion', parameters('customerManagedKey').keyVersion, 'keyvaulturi', format('https://{0}.{1}/', split(parameters('customerManagedKey').keyVaultId, '/')[8], environment().suffixes.keyvaultDns)), null())]"
                }
              }
            },
            "blobService": {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountResourceName'), 'default')]",
              "properties": {
                "changeFeed": {
                  "enabled": "[parameters('enableBlobChangeFeed')]",
                  "retentionInDays": "[if(parameters('enableBlobChangeFeed'), 7, null())]"
                },
                "restorePolicy": "[if(parameters('enableBlobPointInTimeRestore'), createObject('enabled', true(), 'days', parameters('pointInTimeRestoreRetentionDays')), createObject('enabled', false()))]",
                "deleteRetentionPolicy": {
                  "enabled": "[parameters('enableBlobSoftDelete')]",
                  "days": "[if(parameters('enableBlobSoftDelete'), parameters('blobSoftDeleteRetentionDays'), null())]"
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": "[parameters('enableContainerSoftDelete')]",
                  "days": "[if(parameters('enableContainerSoftDelete'), parameters('containerSoftDeleteRetentionDays'), null())]"
                },
                "isVersioningEnabled": "[parameters('enableBlobVersioning')]"
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "blobContainersResource": {
              "copy": {
                "name": "blobContainersResource",
                "count": "[length(parameters('blobContainers'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountResourceName'), 'default', parameters('blobContainers')[copyIndex()].name)]",
              "properties": {
                "publicAccess": "[parameters('blobContainers')[copyIndex()].publicAccess]",
                "metadata": "[parameters('blobContainers')[copyIndex()].metadata]"
              },
              "dependsOn": [
                "blobService"
              ]
            },
            "fileService": {
              "condition": "[greater(length(parameters('fileShares')), 0)]",
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountResourceName'), 'default')]",
              "properties": {
                "shareDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "fileSharesResource": {
              "copy": {
                "name": "fileSharesResource",
                "count": "[length(parameters('fileShares'))]"
              },
              "condition": "[greater(length(parameters('fileShares')), 0)]",
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountResourceName'), 'default', parameters('fileShares')[copyIndex()].name)]",
              "properties": {
                "shareQuota": "[parameters('fileShares')[copyIndex()].shareQuota]",
                "enabledProtocols": "[parameters('fileShares')[copyIndex()].enabledProtocols]",
                "accessTier": "[parameters('fileShares')[copyIndex()].accessTier]"
              },
              "dependsOn": [
                "fileService"
              ]
            },
            "managementPolicy": {
              "condition": "[parameters('enableLifecycleManagement')]",
              "type": "Microsoft.Storage/storageAccounts/managementPolicies",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountResourceName'), 'default')]",
              "properties": {
                "policy": {
                  "rules": "[parameters('lifecycleRules')]"
                }
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "storageAccountDiagnosticSettings": {
              "condition": "[and(parameters('enableDiagnosticSettings'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', variables('storageAccountResourceName'))]",
              "name": "[format('{0}-diagnostics', variables('storageAccountResourceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "Capacity",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "blobServiceDiagnosticSettings": {
              "condition": "[and(parameters('enableDiagnosticSettings'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', variables('storageAccountResourceName'), 'default')]",
              "name": "[format('{0}-blob-diagnostics', variables('storageAccountResourceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "Capacity",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "blobService"
              ]
            },
            "fileServiceDiagnosticSettings": {
              "condition": "[and(and(parameters('enableDiagnosticSettings'), not(empty(parameters('logAnalyticsWorkspaceId')))), greater(length(parameters('fileShares')), 0))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}/fileServices/{1}', variables('storageAccountResourceName'), 'default')]",
              "name": "[format('{0}-file-diagnostics', variables('storageAccountResourceName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "storageAccountId": "[if(not(empty(parameters('diagnosticStorageAccountId'))), parameters('diagnosticStorageAccountId'), null())]",
                "logs": [
                  {
                    "categoryGroup": "audit",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  },
                  {
                    "category": "Capacity",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "fileService"
              ]
            }
          },
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the storage account"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountResourceName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the storage account"
              },
              "value": "[variables('storageAccountResourceName')]"
            },
            "storageAccountEndpoints": {
              "type": "object",
              "metadata": {
                "description": "The primary endpoints of the storage account"
              },
              "value": "[reference('storageAccount').primaryEndpoints]"
            },
            "storageAccountKey": {
              "type": "string",
              "metadata": {
                "description": "The primary access key of the storage account"
              },
              "value": "[listKeys('storageAccount', '2023-01-01').keys[0].value]"
            },
            "storageAccountConnectionString": {
              "type": "string",
              "metadata": {
                "description": "The connection string for the storage account"
              },
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', variables('storageAccountResourceName'), listKeys('storageAccount', '2023-01-01').keys[0].value, environment().suffixes.storage)]"
            },
            "blobContainerNames": {
              "type": "array",
              "metadata": {
                "description": "The blob container names"
              },
              "copy": {
                "count": "[length(parameters('blobContainers'))]",
                "input": "[parameters('blobContainers')[copyIndex()].name]"
              }
            },
            "fileShareNames": {
              "type": "array",
              "metadata": {
                "description": "The file share names"
              },
              "copy": {
                "count": "[length(parameters('fileShares'))]",
                "input": "[parameters('fileShares')[copyIndex()].name]"
              }
            },
            "storageAccountConfig": {
              "type": "object",
              "metadata": {
                "description": "Storage account configuration details"
              },
              "value": {
                "id": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountResourceName'))]",
                "name": "[variables('storageAccountResourceName')]",
                "sku": "[reference('storageAccount', '2023-01-01', 'full').sku]",
                "kind": "[reference('storageAccount', '2023-01-01', 'full').kind]",
                "accessTier": "[reference('storageAccount').accessTier]",
                "endpoints": "[reference('storageAccount').primaryEndpoints]",
                "networkAccess": "[reference('storageAccount').publicNetworkAccess]",
                "httpsOnly": "[reference('storageAccount').supportsHttpsTrafficOnly]",
                "minimumTlsVersion": "[reference('storageAccount').minimumTlsVersion]",
                "enabledFeatures": {
                  "hierarchicalNamespace": "[reference('storageAccount').isHnsEnabled]",
                  "blobPublicAccess": "[reference('storageAccount').allowBlobPublicAccess]",
                  "sharedKeyAccess": "[reference('storageAccount').allowSharedKeyAccess]",
                  "infrastructureEncryption": "[parameters('enableInfrastructureEncryption')]",
                  "blobVersioning": "[parameters('enableBlobVersioning')]",
                  "blobChangeFeed": "[parameters('enableBlobChangeFeed')]",
                  "blobSoftDelete": "[parameters('enableBlobSoftDelete')]",
                  "containerSoftDelete": "[parameters('enableContainerSoftDelete')]",
                  "lifecycleManagement": "[parameters('enableLifecycleManagement')]",
                  "diagnosticSettings": "[parameters('enableDiagnosticSettings')]"
                },
                "containers": "[parameters('blobContainers')]",
                "fileShares": "[parameters('fileShares')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "keyVault",
        "logAnalyticsWorkspace",
        "managedIdentities",
        "namingConventions",
        "virtualNetwork"
      ]
    },
    "privateEndpoints": {
      "condition": "[parameters('environmentConfig').enablePrivateEndpoints]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "private-endpoints-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "privateEndpointNamePrefix": {
            "value": "[replace(reference('namingConventions').outputs.namingConvention.value.privateEndpoint, '{serviceName}', '')]"
          },
          "subnetId": {
            "value": "[reference('virtualNetwork').outputs.subnetIds.value.dataTier]"
          },
          "virtualNetworkId": {
            "value": "[reference('virtualNetwork').outputs.virtualNetworkId.value]"
          },
          "privateEndpointConfigs": {
            "value": [
              {
                "name": "sql-server",
                "privateLinkServiceId": "[reference('sqlServer').outputs.sqlServerId.value]",
                "groupId": "sqlServer"
              },
              {
                "name": "storage-blob",
                "privateLinkServiceId": "[reference('storageAccount').outputs.storageAccountId.value]",
                "groupId": "storageBlob"
              },
              {
                "name": "storage-file",
                "privateLinkServiceId": "[reference('storageAccount').outputs.storageAccountId.value]",
                "groupId": "storageFile"
              },
              {
                "name": "storage-queue",
                "privateLinkServiceId": "[reference('storageAccount').outputs.storageAccountId.value]",
                "groupId": "storageQueue"
              },
              {
                "name": "storage-table",
                "privateLinkServiceId": "[reference('storageAccount').outputs.storageAccountId.value]",
                "groupId": "storageTable"
              },
              {
                "name": "key-vault",
                "privateLinkServiceId": "[reference('keyVault').outputs.keyVaultId.value]",
                "groupId": "keyVault"
              }
            ]
          },
          "enablePrivateDnsZones": {
            "value": true
          },
          "existingPrivateDnsZoneIds": {
            "value": {}
          },
          "customDnsServers": {
            "value": []
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14586416306715185298"
            }
          },
          "definitions": {
            "TagConfiguration": {
              "type": "object",
              "properties": {
                "Environment": {
                  "type": "string",
                  "metadata": {
                    "description": "Environment tag"
                  }
                },
                "Workload": {
                  "type": "string",
                  "metadata": {
                    "description": "Workload tag"
                  }
                },
                "ManagedBy": {
                  "type": "string",
                  "metadata": {
                    "description": "Managed by tag"
                  }
                },
                "CostCenter": {
                  "type": "string",
                  "metadata": {
                    "description": "Cost center tag"
                  }
                },
                "Owner": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Owner tag"
                  }
                },
                "Project": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Project tag"
                  }
                },
                "DeploymentDate": {
                  "type": "string",
                  "nullable": true,
                  "metadata": {
                    "description": "Deployment date tag"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../shared/parameter-schemas.bicep"
                }
              }
            }
          },
          "parameters": {
            "privateEndpointNamePrefix": {
              "type": "string",
              "metadata": {
                "description": "The name prefix for private endpoints"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The Azure region for deployment"
              }
            },
            "tags": {
              "$ref": "#/definitions/TagConfiguration",
              "metadata": {
                "description": "Tags to apply to all resources"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID where private endpoints will be created"
              }
            },
            "virtualNetworkId": {
              "type": "string",
              "metadata": {
                "description": "Virtual Network ID for DNS zone linking"
              }
            },
            "privateEndpointConfigs": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "privateLinkServiceId": {
                    "type": "string"
                  },
                  "groupId": {
                    "type": "string",
                    "allowedValues": [
                      "agentsvc",
                      "cognitiveServices",
                      "cosmosDb",
                      "eventHub",
                      "keyVault",
                      "monitor",
                      "ods",
                      "oms",
                      "redis",
                      "search",
                      "serviceBus",
                      "sqlServer",
                      "storageBlob",
                      "storageDfs",
                      "storageFile",
                      "storageQueue",
                      "storageTable",
                      "storageWeb"
                    ]
                  }
                }
              },
              "defaultValue": [],
              "metadata": {
                "description": "Private endpoint configurations"
              }
            },
            "enablePrivateDnsZones": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable private DNS zone creation and linking"
              }
            },
            "existingPrivateDnsZoneIds": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Existing private DNS zone resource IDs (if not creating new ones)"
              }
            },
            "customDnsServers": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Custom DNS servers for private DNS zones"
              }
            },
            "enableCustomDnsConfiguration": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable custom DNS configuration for private endpoints"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "dnsZoneVnetLinksArray",
                "count": "[length(parameters('privateEndpointConfigs'))]",
                "input": {
                  "name": "[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].name]",
                  "groupId": "[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId]",
                  "dnsZoneName": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId]]",
                  "vnetLinkId": "[if(parameters('enablePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId], format('{0}-vnet-link', parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId)), '')]",
                  "registrationEnabled": false
                }
              }
            ],
            "privateDnsZoneNames": {
              "sqlServer": "[format('privatelink{0}', environment().suffixes.sqlServerHostname)]",
              "storageBlob": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
              "storageFile": "[format('privatelink.file.{0}', environment().suffixes.storage)]",
              "storageQueue": "[format('privatelink.queue.{0}', environment().suffixes.storage)]",
              "storageTable": "[format('privatelink.table.{0}', environment().suffixes.storage)]",
              "storageWeb": "[format('privatelink.web.{0}', environment().suffixes.storage)]",
              "storageDfs": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]",
              "keyVault": "[format('privatelink{0}', environment().suffixes.keyvaultDns)]",
              "cosmosDb": "privatelink.documents.azure.com",
              "serviceBus": "privatelink.servicebus.windows.net",
              "eventHub": "privatelink.servicebus.windows.net",
              "redis": "privatelink.redis.cache.windows.net",
              "cognitiveServices": "privatelink.cognitiveservices.azure.com",
              "search": "privatelink.search.windows.net",
              "monitor": "privatelink.monitor.azure.com",
              "oms": "privatelink.oms.opinsights.azure.com",
              "ods": "privatelink.ods.opinsights.azure.com",
              "agentsvc": "privatelink.agentsvc.azure-automation.net"
            }
          },
          "resources": {
            "privateDnsZones": {
              "copy": {
                "name": "privateDnsZones",
                "count": "[length(parameters('privateEndpointConfigs'))]"
              },
              "condition": "[and(parameters('enablePrivateDnsZones'), not(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId)))]",
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {}
            },
            "privateDnsZoneVnetLinks": {
              "copy": {
                "name": "privateDnsZoneVnetLinks",
                "count": "[length(parameters('privateEndpointConfigs'))]"
              },
              "condition": "[and(parameters('enablePrivateDnsZones'), not(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId)))]",
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId], format('{0}-vnet-link', parameters('privateEndpointConfigs')[copyIndex()].groupId))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[parameters('virtualNetworkId')]"
                }
              },
              "dependsOn": [
                "[format('privateDnsZones[{0}]', copyIndex())]"
              ]
            },
            "privateEndpoints": {
              "copy": {
                "name": "privateEndpoints",
                "count": "[length(parameters('privateEndpointConfigs'))]"
              },
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-connection', parameters('privateEndpointConfigs')[copyIndex()].name)]",
                    "properties": {
                      "privateLinkServiceId": "[parameters('privateEndpointConfigs')[copyIndex()].privateLinkServiceId]",
                      "groupIds": [
                        "[parameters('privateEndpointConfigs')[copyIndex()].groupId]"
                      ],
                      "requestMessage": "[format('Private endpoint connection for {0}', parameters('privateEndpointConfigs')[copyIndex()].name)]"
                    }
                  }
                ],
                "customNetworkInterfaceName": "[format('{0}-{1}-nic', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name)]",
                "customDnsConfigs": "[if(and(parameters('enableCustomDnsConfiguration'), greater(length(parameters('customDnsServers')), 0)), createArray(createObject('fqdn', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId], 'ipAddresses', parameters('customDnsServers'))), createArray())]",
                "ipConfigurations": []
              }
            },
            "privateDnsZoneGroups": {
              "copy": {
                "name": "privateDnsZoneGroups",
                "count": "[length(parameters('privateEndpointConfigs'))]"
              },
              "condition": "[parameters('enablePrivateDnsZones')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[parameters('privateEndpointConfigs')[copyIndex()].groupId]",
                    "properties": {
                      "privateDnsZoneId": "[if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[format('privateDnsZones[{0}]', copyIndex())]",
                "[format('privateEndpoints[{0}]', copyIndex())]"
              ]
            }
          },
          "outputs": {
            "privateEndpointIds": {
              "type": "array",
              "metadata": {
                "description": "Private endpoint resource IDs"
              },
              "copy": {
                "count": "[length(parameters('privateEndpointConfigs'))]",
                "input": {
                  "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
                  "id": "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name))]",
                  "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
                  "customDnsConfigs": "[reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs]"
                }
              }
            },
            "privateDnsZoneIds": {
              "type": "array",
              "metadata": {
                "description": "Private DNS zone resource IDs"
              },
              "copy": {
                "count": "[length(parameters('privateEndpointConfigs'))]",
                "input": "[if(parameters('enablePrivateDnsZones'), if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId])), '')]"
              }
            },
            "privateEndpointConfigs": {
              "type": "array",
              "metadata": {
                "description": "Private endpoint configuration details"
              },
              "copy": {
                "count": "[length(parameters('privateEndpointConfigs'))]",
                "input": {
                  "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
                  "id": "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name))]",
                  "groupId": "[parameters('privateEndpointConfigs')[copyIndex()].groupId]",
                  "privateLinkServiceId": "[parameters('privateEndpointConfigs')[copyIndex()].privateLinkServiceId]",
                  "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
                  "privateIpAddress": "[if(greater(length(reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs), 0), reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs[0].ipAddresses[0], '')]",
                  "fqdn": "[if(greater(length(reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs), 0), reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs[0].fqdn, '')]",
                  "dnsZoneId": "[if(parameters('enablePrivateDnsZones'), if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId])), '')]",
                  "dnsZoneName": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]]",
                  "connectionState": "Approved"
                }
              }
            },
            "privateDnsZoneNames": {
              "type": "object",
              "metadata": {
                "description": "Private DNS zone names"
              },
              "value": "[variables('privateDnsZoneNames')]"
            },
            "networkInterfaceDetails": {
              "type": "array",
              "metadata": {
                "description": "Private endpoint network interface details"
              },
              "copy": {
                "count": "[length(parameters('privateEndpointConfigs'))]",
                "input": {
                  "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
                  "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
                  "privateIpAddress": "",
                  "subnetId": "[parameters('subnetId')]"
                }
              }
            },
            "dnsZoneVnetLinks": {
              "type": "array",
              "metadata": {
                "description": "Private DNS zone virtual network links"
              },
              "value": "[if(parameters('enablePrivateDnsZones'), variables('dnsZoneVnetLinksArray'), createArray())]"
            },
            "deploymentSummary": {
              "type": "object",
              "metadata": {
                "description": "Summary of private endpoint deployment"
              },
              "value": {
                "totalEndpoints": "[length(parameters('privateEndpointConfigs'))]",
                "enabledPrivateDnsZones": "[parameters('enablePrivateDnsZones')]",
                "customDnsConfiguration": "[parameters('enableCustomDnsConfiguration')]",
                "subnetId": "[parameters('subnetId')]",
                "virtualNetworkId": "[parameters('virtualNetworkId')]",
                "supportedServicesCount": "[length(items(variables('privateDnsZoneNames')))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "keyVault",
        "namingConventions",
        "sqlServer",
        "storageAccount",
        "virtualNetwork"
      ]
    }
  },
  "outputs": {
    "namingConvention": {
      "type": "object",
      "value": "[reference('namingConventions').outputs.namingConvention.value]"
    },
    "deploymentTags": {
      "$ref": "#/definitions/TagConfiguration",
      "value": "[parameters('tags')]"
    },
    "environmentConfig": {
      "$ref": "#/definitions/EnvironmentConfig",
      "value": "[parameters('environmentConfig')]"
    },
    "commonVariables": {
      "type": "object",
      "value": "[reference('commonVariables').outputs]"
    },
    "resourcePrefix": {
      "type": "string",
      "value": "[parameters('resourcePrefix')]"
    },
    "environment": {
      "type": "string",
      "value": "[parameters('environment')]"
    },
    "workloadName": {
      "type": "string",
      "value": "[parameters('workloadName')]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "networking": {
      "type": "object",
      "value": {
        "virtualNetwork": {
          "id": "[reference('virtualNetwork').outputs.virtualNetworkId.value]",
          "name": "[reference('virtualNetwork').outputs.virtualNetworkName.value]",
          "addressSpace": "[reference('virtualNetwork').outputs.addressSpace.value]",
          "subnets": {
            "ids": "[reference('virtualNetwork').outputs.subnetIds.value]",
            "names": "[reference('virtualNetwork').outputs.subnetNames.value]",
            "addressPrefixes": "[reference('virtualNetwork').outputs.subnetAddressPrefixes.value]"
          }
        },
        "networkSecurityGroups": {
          "ids": "[reference('networkSecurityGroups').outputs.nsgIds.value]",
          "names": "[reference('networkSecurityGroups').outputs.nsgNames.value]"
        },
        "ddosProtection": "[if(parameters('environmentConfig').enableDdosProtection, createObject('id', reference('ddosProtection').outputs.ddosProtectionPlanId.value, 'name', reference('ddosProtection').outputs.ddosProtectionPlanName.value, 'config', reference('ddosProtection').outputs.ddosProtectionConfig.value), createObject('id', '', 'name', '', 'config', createObject('id', '', 'enabled', false())))]",
        "virtualNetworkManager": {
          "id": "[reference('virtualNetworkManager').outputs.virtualNetworkManagerId.value]",
          "name": "[reference('virtualNetworkManager').outputs.virtualNetworkManagerName.value]",
          "networkGroups": {
            "ids": "[reference('virtualNetworkManager').outputs.networkGroupIds.value]",
            "names": "[reference('virtualNetworkManager').outputs.networkGroupNames.value]"
          },
          "connectivityConfigurations": "[reference('virtualNetworkManager').outputs.connectivityConfigurationIds.value]",
          "securityAdminConfigurations": "[reference('virtualNetworkManager').outputs.securityAdminConfigurationIds.value]"
        }
      }
    },
    "security": {
      "type": "object",
      "value": {
        "keyVault": {
          "id": "[reference('keyVault').outputs.keyVaultId.value]",
          "name": "[reference('keyVault').outputs.keyVaultName.value]",
          "uri": "[reference('keyVault').outputs.keyVaultUri.value]",
          "config": "[reference('keyVault').outputs.keyVaultConfig.value]"
        },
        "securityCenter": "[if(not(equals(parameters('environment'), 'dev')), createObject('defenderPlansConfig', reference('securityCenter').outputs.defenderPlansConfig.value, 'securityContactsConfig', reference('securityCenter').outputs.securityContactsConfig.value, 'autoProvisioningConfig', reference('securityCenter').outputs.autoProvisioningConfig.value, 'workspaceSettingsConfig', reference('securityCenter').outputs.workspaceSettingsConfig.value, 'securityPolicyAssignment', reference('securityCenter').outputs.securityPolicyAssignment.value, 'customSecurityAssessment', reference('securityCenter').outputs.customSecurityAssessment.value, 'securityCenterConfig', reference('securityCenter').outputs.securityCenterConfig.value), createObject('defenderPlansConfig', createArray(), 'securityContactsConfig', createArray(), 'autoProvisioningConfig', createObject(), 'workspaceSettingsConfig', createObject(), 'securityPolicyAssignment', createObject(), 'customSecurityAssessment', createObject(), 'securityCenterConfig', createObject()))]",
        "managedIdentities": {
          "ids": "[reference('managedIdentities').outputs.managedIdentityIds.value]",
          "names": "[reference('managedIdentities').outputs.managedIdentityNames.value]",
          "principalIds": "[reference('managedIdentities').outputs.managedIdentityPrincipalIds.value]",
          "clientIds": "[reference('managedIdentities').outputs.managedIdentityClientIds.value]",
          "configs": "[reference('managedIdentities').outputs.managedIdentityConfigs.value]",
          "lookup": "[reference('managedIdentities').outputs.managedIdentityLookup.value]",
          "roleDefinitions": "[reference('managedIdentities').outputs.roleDefinitions.value]"
        }
      }
    },
    "compute": {
      "type": "object",
      "value": {
        "publicIpAddress": {
          "applicationGateway": {
            "id": "[reference('applicationGatewayPublicIp').outputs.publicIpAddressId.value]",
            "name": "[reference('applicationGatewayPublicIp').outputs.publicIpAddressName.value]",
            "ipAddress": "[reference('applicationGatewayPublicIp').outputs.ipAddress.value]",
            "fqdn": "[reference('applicationGatewayPublicIp').outputs.fqdn.value]",
            "config": "[reference('applicationGatewayPublicIp').outputs.publicIpConfig.value]"
          }
        },
        "applicationGateway": {
          "id": "[reference('applicationGateway').outputs.applicationGatewayId.value]",
          "name": "[reference('applicationGateway').outputs.applicationGatewayName.value]",
          "publicIpAddress": "[reference('applicationGateway').outputs.publicIpAddress.value]",
          "backendAddressPoolIds": "[reference('applicationGateway').outputs.backendAddressPoolIds.value]",
          "frontendIpConfigurationId": "[reference('applicationGateway').outputs.frontendIpConfigurationId.value]",
          "wafPolicyId": "[reference('applicationGateway').outputs.wafPolicyId.value]",
          "config": "[reference('applicationGateway').outputs.applicationGatewayConfig.value]"
        },
        "loadBalancers": {
          "businessTier": {
            "id": "[reference('businessTierLoadBalancer').outputs.loadBalancerId.value]",
            "name": "[reference('businessTierLoadBalancer').outputs.loadBalancerName.value]",
            "privateIpAddress": "[reference('businessTierLoadBalancer').outputs.privateIpAddress.value]",
            "frontendIpConfigurationId": "[reference('businessTierLoadBalancer').outputs.frontendIpConfigurationId.value]",
            "backendAddressPoolIds": "[reference('businessTierLoadBalancer').outputs.backendAddressPoolIds.value]",
            "healthProbeIds": "[reference('businessTierLoadBalancer').outputs.healthProbeIds.value]",
            "config": "[reference('businessTierLoadBalancer').outputs.loadBalancerConfig.value]"
          },
          "dataTier": {
            "id": "[reference('dataTierLoadBalancer').outputs.loadBalancerId.value]",
            "name": "[reference('dataTierLoadBalancer').outputs.loadBalancerName.value]",
            "privateIpAddress": "[reference('dataTierLoadBalancer').outputs.privateIpAddress.value]",
            "frontendIpConfigurationId": "[reference('dataTierLoadBalancer').outputs.frontendIpConfigurationId.value]",
            "backendAddressPoolIds": "[reference('dataTierLoadBalancer').outputs.backendAddressPoolIds.value]",
            "healthProbeIds": "[reference('dataTierLoadBalancer').outputs.healthProbeIds.value]",
            "config": "[reference('dataTierLoadBalancer').outputs.loadBalancerConfig.value]"
          }
        },
        "availabilitySets": {
          "webTier": "[if(not(parameters('environmentConfig').enableHighAvailability), createObject('id', reference('webTierAvailabilitySet').outputs.availabilitySetId.value, 'name', reference('webTierAvailabilitySet').outputs.availabilitySetName.value, 'config', reference('webTierAvailabilitySet').outputs.availabilitySetConfig.value), createObject('id', '', 'name', '', 'config', createObject()))]",
          "businessTier": "[if(not(parameters('environmentConfig').enableHighAvailability), createObject('id', reference('businessTierAvailabilitySet').outputs.availabilitySetId.value, 'name', reference('businessTierAvailabilitySet').outputs.availabilitySetName.value, 'config', reference('businessTierAvailabilitySet').outputs.availabilitySetConfig.value), createObject('id', '', 'name', '', 'config', createObject()))]"
        },
        "virtualMachineScaleSets": {
          "webTier": {
            "id": "[reference('webTierVmScaleSet').outputs.vmScaleSetId.value]",
            "name": "[reference('webTierVmScaleSet').outputs.vmScaleSetName.value]",
            "config": "[reference('webTierVmScaleSet').outputs.vmScaleSetConfig.value]",
            "autoscaleSettingsId": "[reference('webTierVmScaleSet').outputs.autoscaleSettingsId.value]"
          },
          "businessTier": {
            "id": "[reference('businessTierVmScaleSet').outputs.vmScaleSetId.value]",
            "name": "[reference('businessTierVmScaleSet').outputs.vmScaleSetName.value]",
            "config": "[reference('businessTierVmScaleSet').outputs.vmScaleSetConfig.value]",
            "autoscaleSettingsId": "[reference('businessTierVmScaleSet').outputs.autoscaleSettingsId.value]"
          }
        }
      }
    },
    "data": {
      "type": "object",
      "value": {
        "sqlServer": {
          "id": "[reference('sqlServer').outputs.sqlServerId.value]",
          "name": "[reference('sqlServer').outputs.sqlServerName.value]",
          "fqdn": "[reference('sqlServer').outputs.sqlServerFqdn.value]",
          "connectionStringTemplate": "[reference('sqlServer').outputs.connectionStringTemplate.value]",
          "config": "[reference('sqlServer').outputs.sqlServerConfig.value]"
        },
        "sqlDatabase": {
          "id": "[reference('sqlServer').outputs.sqlDatabaseId.value]",
          "name": "[reference('sqlServer').outputs.sqlDatabaseName.value]",
          "config": "[reference('sqlServer').outputs.sqlDatabaseConfig.value]"
        },
        "storageAccount": {
          "id": "[reference('storageAccount').outputs.storageAccountId.value]",
          "name": "[reference('storageAccount').outputs.storageAccountName.value]",
          "endpoints": "[reference('storageAccount').outputs.storageAccountEndpoints.value]",
          "connectionString": "[reference('storageAccount').outputs.storageAccountConnectionString.value]",
          "blobContainers": "[reference('storageAccount').outputs.blobContainerNames.value]",
          "fileShares": "[reference('storageAccount').outputs.fileShareNames.value]",
          "config": "[reference('storageAccount').outputs.storageAccountConfig.value]"
        },
        "privateEndpoints": "[if(parameters('environmentConfig').enablePrivateEndpoints, createObject('endpoints', reference('privateEndpoints').outputs.privateEndpointIds.value, 'dnsZones', reference('privateEndpoints').outputs.privateDnsZoneIds.value, 'configs', reference('privateEndpoints').outputs.privateEndpointConfigs.value, 'dnsZoneNames', reference('privateEndpoints').outputs.privateDnsZoneNames.value), createObject('endpoints', createArray(), 'dnsZones', createObject(), 'configs', createArray(), 'dnsZoneNames', createObject()))]"
      }
    },
    "monitoring": {
      "type": "object",
      "value": {
        "logAnalyticsWorkspace": {
          "id": "[reference('logAnalyticsWorkspace').outputs.workspaceId.value]",
          "name": "[reference('logAnalyticsWorkspace').outputs.workspaceName.value]",
          "customerId": "[reference('logAnalyticsWorkspace').outputs.customerId.value]",
          "dataCollectionRuleId": "[reference('logAnalyticsWorkspace').outputs.dataCollectionRuleId.value]",
          "config": "[reference('logAnalyticsWorkspace').outputs.workspaceConfig.value]"
        },
        "applicationInsights": {
          "id": "[reference('applicationInsights').outputs.applicationInsightsId.value]",
          "name": "[reference('applicationInsights').outputs.applicationInsightsName.value]",
          "appId": "[reference('applicationInsights').outputs.appId.value]",
          "availabilityTestIds": "[reference('applicationInsights').outputs.availabilityTestIds.value]",
          "config": "[reference('applicationInsights').outputs.applicationInsightsConfig.value]"
        },
        "alerts": {
          "actionGroupId": "[reference('monitoringAlerts').outputs.actionGroupId.value]",
          "criticalActionGroupId": "[reference('monitoringAlerts').outputs.criticalActionGroupId.value]",
          "alertRuleIds": "[reference('monitoringAlerts').outputs.alertRuleIds.value]",
          "config": "[reference('monitoringAlerts').outputs.alertsConfig.value]"
        }
      }
    }
  }
}