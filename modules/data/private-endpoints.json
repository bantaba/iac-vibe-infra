{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "14586416306715185298"
    }
  },
  "definitions": {
    "TagConfiguration": {
      "type": "object",
      "properties": {
        "Environment": {
          "type": "string",
          "metadata": {
            "description": "Environment tag"
          }
        },
        "Workload": {
          "type": "string",
          "metadata": {
            "description": "Workload tag"
          }
        },
        "ManagedBy": {
          "type": "string",
          "metadata": {
            "description": "Managed by tag"
          }
        },
        "CostCenter": {
          "type": "string",
          "metadata": {
            "description": "Cost center tag"
          }
        },
        "Owner": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Owner tag"
          }
        },
        "Project": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Project tag"
          }
        },
        "DeploymentDate": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Deployment date tag"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../shared/parameter-schemas.bicep"
        }
      }
    }
  },
  "parameters": {
    "privateEndpointNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "The name prefix for private endpoints"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The Azure region for deployment"
      }
    },
    "tags": {
      "$ref": "#/definitions/TagConfiguration",
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "subnetId": {
      "type": "string",
      "metadata": {
        "description": "Subnet ID where private endpoints will be created"
      }
    },
    "virtualNetworkId": {
      "type": "string",
      "metadata": {
        "description": "Virtual Network ID for DNS zone linking"
      }
    },
    "privateEndpointConfigs": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "privateLinkServiceId": {
            "type": "string"
          },
          "groupId": {
            "type": "string",
            "allowedValues": [
              "agentsvc",
              "cognitiveServices",
              "cosmosDb",
              "eventHub",
              "keyVault",
              "monitor",
              "ods",
              "oms",
              "redis",
              "search",
              "serviceBus",
              "sqlServer",
              "storageBlob",
              "storageDfs",
              "storageFile",
              "storageQueue",
              "storageTable",
              "storageWeb"
            ]
          }
        }
      },
      "defaultValue": [],
      "metadata": {
        "description": "Private endpoint configurations"
      }
    },
    "enablePrivateDnsZones": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable private DNS zone creation and linking"
      }
    },
    "existingPrivateDnsZoneIds": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Existing private DNS zone resource IDs (if not creating new ones)"
      }
    },
    "customDnsServers": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Custom DNS servers for private DNS zones"
      }
    },
    "enableCustomDnsConfiguration": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable custom DNS configuration for private endpoints"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "dnsZoneVnetLinksArray",
        "count": "[length(parameters('privateEndpointConfigs'))]",
        "input": {
          "name": "[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].name]",
          "groupId": "[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId]",
          "dnsZoneName": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId]]",
          "vnetLinkId": "[if(parameters('enablePrivateDnsZones'), resourceId('Microsoft.Network/privateDnsZones/virtualNetworkLinks', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId], format('{0}-vnet-link', parameters('privateEndpointConfigs')[copyIndex('dnsZoneVnetLinksArray')].groupId)), '')]",
          "registrationEnabled": false
        }
      }
    ],
    "privateDnsZoneNames": {
      "sqlServer": "[format('privatelink{0}', environment().suffixes.sqlServerHostname)]",
      "storageBlob": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
      "storageFile": "[format('privatelink.file.{0}', environment().suffixes.storage)]",
      "storageQueue": "[format('privatelink.queue.{0}', environment().suffixes.storage)]",
      "storageTable": "[format('privatelink.table.{0}', environment().suffixes.storage)]",
      "storageWeb": "[format('privatelink.web.{0}', environment().suffixes.storage)]",
      "storageDfs": "[format('privatelink.dfs.{0}', environment().suffixes.storage)]",
      "keyVault": "[format('privatelink{0}', environment().suffixes.keyvaultDns)]",
      "cosmosDb": "privatelink.documents.azure.com",
      "serviceBus": "privatelink.servicebus.windows.net",
      "eventHub": "privatelink.servicebus.windows.net",
      "redis": "privatelink.redis.cache.windows.net",
      "cognitiveServices": "privatelink.cognitiveservices.azure.com",
      "search": "privatelink.search.windows.net",
      "monitor": "privatelink.monitor.azure.com",
      "oms": "privatelink.oms.opinsights.azure.com",
      "ods": "privatelink.ods.opinsights.azure.com",
      "agentsvc": "privatelink.agentsvc.azure-automation.net"
    }
  },
  "resources": {
    "privateDnsZones": {
      "copy": {
        "name": "privateDnsZones",
        "count": "[length(parameters('privateEndpointConfigs'))]"
      },
      "condition": "[and(parameters('enablePrivateDnsZones'), not(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId)))]",
      "type": "Microsoft.Network/privateDnsZones",
      "apiVersion": "2020-06-01",
      "name": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {}
    },
    "privateDnsZoneVnetLinks": {
      "copy": {
        "name": "privateDnsZoneVnetLinks",
        "count": "[length(parameters('privateEndpointConfigs'))]"
      },
      "condition": "[and(parameters('enablePrivateDnsZones'), not(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId)))]",
      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
      "apiVersion": "2020-06-01",
      "name": "[format('{0}/{1}', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId], format('{0}-vnet-link', parameters('privateEndpointConfigs')[copyIndex()].groupId))]",
      "location": "global",
      "tags": "[parameters('tags')]",
      "properties": {
        "registrationEnabled": false,
        "virtualNetwork": {
          "id": "[parameters('virtualNetworkId')]"
        }
      },
      "dependsOn": [
        "[format('privateDnsZones[{0}]', copyIndex())]"
      ]
    },
    "privateEndpoints": {
      "copy": {
        "name": "privateEndpoints",
        "count": "[length(parameters('privateEndpointConfigs'))]"
      },
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name)]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "[format('{0}-connection', parameters('privateEndpointConfigs')[copyIndex()].name)]",
            "properties": {
              "privateLinkServiceId": "[parameters('privateEndpointConfigs')[copyIndex()].privateLinkServiceId]",
              "groupIds": [
                "[parameters('privateEndpointConfigs')[copyIndex()].groupId]"
              ],
              "requestMessage": "[format('Private endpoint connection for {0}', parameters('privateEndpointConfigs')[copyIndex()].name)]"
            }
          }
        ],
        "customNetworkInterfaceName": "[format('{0}-{1}-nic', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name)]",
        "customDnsConfigs": "[if(and(parameters('enableCustomDnsConfiguration'), greater(length(parameters('customDnsServers')), 0)), createArray(createObject('fqdn', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId], 'ipAddresses', parameters('customDnsServers'))), createArray())]",
        "ipConfigurations": []
      }
    },
    "privateDnsZoneGroups": {
      "copy": {
        "name": "privateDnsZoneGroups",
        "count": "[length(parameters('privateEndpointConfigs'))]"
      },
      "condition": "[parameters('enablePrivateDnsZones')]",
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name), 'default')]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "[parameters('privateEndpointConfigs')[copyIndex()].groupId]",
            "properties": {
              "privateDnsZoneId": "[if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[format('privateDnsZones[{0}]', copyIndex())]",
        "[format('privateEndpoints[{0}]', copyIndex())]"
      ]
    }
  },
  "outputs": {
    "privateEndpointIds": {
      "type": "array",
      "metadata": {
        "description": "Private endpoint resource IDs"
      },
      "copy": {
        "count": "[length(parameters('privateEndpointConfigs'))]",
        "input": {
          "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
          "id": "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name))]",
          "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
          "customDnsConfigs": "[reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs]"
        }
      }
    },
    "privateDnsZoneIds": {
      "type": "array",
      "metadata": {
        "description": "Private DNS zone resource IDs"
      },
      "copy": {
        "count": "[length(parameters('privateEndpointConfigs'))]",
        "input": "[if(parameters('enablePrivateDnsZones'), if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId])), '')]"
      }
    },
    "privateEndpointConfigs": {
      "type": "array",
      "metadata": {
        "description": "Private endpoint configuration details"
      },
      "copy": {
        "count": "[length(parameters('privateEndpointConfigs'))]",
        "input": {
          "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
          "id": "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndpointNamePrefix'), parameters('privateEndpointConfigs')[copyIndex()].name))]",
          "groupId": "[parameters('privateEndpointConfigs')[copyIndex()].groupId]",
          "privateLinkServiceId": "[parameters('privateEndpointConfigs')[copyIndex()].privateLinkServiceId]",
          "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
          "privateIpAddress": "[if(greater(length(reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs), 0), reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs[0].ipAddresses[0], '')]",
          "fqdn": "[if(greater(length(reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs), 0), reference(format('privateEndpoints[{0}]', copyIndex())).customDnsConfigs[0].fqdn, '')]",
          "dnsZoneId": "[if(parameters('enablePrivateDnsZones'), if(contains(parameters('existingPrivateDnsZoneIds'), parameters('privateEndpointConfigs')[copyIndex()].groupId), parameters('existingPrivateDnsZoneIds')[parameters('privateEndpointConfigs')[copyIndex()].groupId], resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId])), '')]",
          "dnsZoneName": "[variables('privateDnsZoneNames')[parameters('privateEndpointConfigs')[copyIndex()].groupId]]",
          "connectionState": "Approved"
        }
      }
    },
    "privateDnsZoneNames": {
      "type": "object",
      "metadata": {
        "description": "Private DNS zone names"
      },
      "value": "[variables('privateDnsZoneNames')]"
    },
    "networkInterfaceDetails": {
      "type": "array",
      "metadata": {
        "description": "Private endpoint network interface details"
      },
      "copy": {
        "count": "[length(parameters('privateEndpointConfigs'))]",
        "input": {
          "name": "[parameters('privateEndpointConfigs')[copyIndex()].name]",
          "networkInterfaceId": "[reference(format('privateEndpoints[{0}]', copyIndex())).networkInterfaces[0].id]",
          "privateIpAddress": "",
          "subnetId": "[parameters('subnetId')]"
        }
      }
    },
    "dnsZoneVnetLinks": {
      "type": "array",
      "metadata": {
        "description": "Private DNS zone virtual network links"
      },
      "value": "[if(parameters('enablePrivateDnsZones'), variables('dnsZoneVnetLinksArray'), createArray())]"
    },
    "deploymentSummary": {
      "type": "object",
      "metadata": {
        "description": "Summary of private endpoint deployment"
      },
      "value": {
        "totalEndpoints": "[length(parameters('privateEndpointConfigs'))]",
        "enabledPrivateDnsZones": "[parameters('enablePrivateDnsZones')]",
        "customDnsConfiguration": "[parameters('enableCustomDnsConfiguration')]",
        "subnetId": "[parameters('subnetId')]",
        "virtualNetworkId": "[parameters('virtualNetworkId')]",
        "supportedServicesCount": "[length(items(variables('privateDnsZoneNames')))]"
      }
    }
  }
}