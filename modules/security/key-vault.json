{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "5748297240115920289"
    }
  },
  "definitions": {
    "KeyVaultConfig": {
      "type": "object",
      "properties": {
        "sku": {
          "type": "string",
          "allowedValues": [
            "premium",
            "standard"
          ],
          "metadata": {
            "description": "Key Vault SKU"
          }
        },
        "enableSoftDelete": {
          "type": "bool",
          "metadata": {
            "description": "Enable soft delete"
          }
        },
        "softDeleteRetentionInDays": {
          "type": "int",
          "minValue": 7,
          "maxValue": 90,
          "metadata": {
            "description": "Soft delete retention days"
          }
        },
        "enablePurgeProtection": {
          "type": "bool",
          "metadata": {
            "description": "Enable purge protection"
          }
        },
        "enableRbacAuthorization": {
          "type": "bool",
          "metadata": {
            "description": "Enable RBAC authorization"
          }
        },
        "networkAcls": {
          "type": "object",
          "properties": {
            "bypass": {
              "type": "string",
              "allowedValues": [
                "AzureServices",
                "None"
              ]
            },
            "defaultAction": {
              "type": "string",
              "allowedValues": [
                "Allow",
                "Deny"
              ]
            },
            "ipRules": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "nullable": true
            },
            "virtualNetworkRules": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "nullable": true
            }
          },
          "metadata": {
            "description": "Network access control"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../shared/parameter-schemas.bicep"
        }
      }
    },
    "TagConfiguration": {
      "type": "object",
      "properties": {
        "Environment": {
          "type": "string",
          "metadata": {
            "description": "Environment tag"
          }
        },
        "Workload": {
          "type": "string",
          "metadata": {
            "description": "Workload tag"
          }
        },
        "ManagedBy": {
          "type": "string",
          "metadata": {
            "description": "Managed by tag"
          }
        },
        "CostCenter": {
          "type": "string",
          "metadata": {
            "description": "Cost center tag"
          }
        },
        "Owner": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Owner tag"
          }
        },
        "Project": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Project tag"
          }
        },
        "DeploymentDate": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Deployment date tag"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../shared/parameter-schemas.bicep"
        }
      }
    }
  },
  "parameters": {
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Key Vault"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The Azure region for deployment"
      }
    },
    "tags": {
      "$ref": "#/definitions/TagConfiguration",
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "keyVaultConfig": {
      "$ref": "#/definitions/KeyVaultConfig",
      "defaultValue": {
        "sku": "standard",
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "enablePurgeProtection": true,
        "enableRbacAuthorization": true,
        "networkAcls": {
          "bypass": "AzureServices",
          "defaultAction": "Deny",
          "ipRules": [],
          "virtualNetworkRules": []
        }
      },
      "metadata": {
        "description": "Key Vault configuration settings"
      }
    },
    "allowedSubnetIds": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Subnet IDs that should have access to Key Vault"
      }
    },
    "allowedIpAddresses": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "IP addresses that should have access to Key Vault"
      }
    },
    "keyVaultAdministrators": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Object IDs of users/groups/service principals that should have Key Vault Administrator access"
      }
    },
    "keyVaultSecretsUsers": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Object IDs of users/groups/service principals that should have Key Vault Secrets User access"
      }
    },
    "keyVaultCertificateUsers": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "defaultValue": [],
      "metadata": {
        "description": "Object IDs of users/groups/service principals that should have Key Vault Certificate User access"
      }
    },
    "enableDiagnostics": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable diagnostic settings for Key Vault"
      }
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Log Analytics workspace ID for diagnostic settings"
      }
    },
    "enableTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable telemetry for the module"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "ipRules",
        "count": "[length(parameters('allowedIpAddresses'))]",
        "input": {
          "value": "[parameters('allowedIpAddresses')[copyIndex('ipRules')]]"
        }
      },
      {
        "name": "virtualNetworkRules",
        "count": "[length(parameters('allowedSubnetIds'))]",
        "input": {
          "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]",
          "ignoreMissingVnetServiceEndpoint": false
        }
      }
    ],
    "networkRules": {
      "bypass": "[parameters('keyVaultConfig').networkAcls.bypass]",
      "defaultAction": "[parameters('keyVaultConfig').networkAcls.defaultAction]",
      "ipRules": "[variables('ipRules')]",
      "virtualNetworkRules": "[variables('virtualNetworkRules')]"
    },
    "roleDefinitions": {
      "keyVaultAdministrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '00482a5a-887f-4fb3-b363-3b7fe8e74483')]",
      "keyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
      "keyVaultCertificateUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
      "keyVaultCryptoUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]"
    }
  },
  "resources": {
    "keyVault": {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-07-01",
      "name": "[parameters('keyVaultName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "[parameters('keyVaultConfig').sku]"
        },
        "tenantId": "[tenant().tenantId]",
        "enableSoftDelete": "[parameters('keyVaultConfig').enableSoftDelete]",
        "softDeleteRetentionInDays": "[parameters('keyVaultConfig').softDeleteRetentionInDays]",
        "enablePurgeProtection": "[if(parameters('keyVaultConfig').enablePurgeProtection, true(), null())]",
        "enableRbacAuthorization": "[parameters('keyVaultConfig').enableRbacAuthorization]",
        "enabledForDeployment": false,
        "enabledForDiskEncryption": true,
        "enabledForTemplateDeployment": true,
        "networkAcls": "[variables('networkRules')]",
        "publicNetworkAccess": "[if(equals(parameters('keyVaultConfig').networkAcls.defaultAction, 'Allow'), 'Enabled', 'Disabled')]"
      }
    },
    "keyVaultAdminRoleAssignments": {
      "copy": {
        "name": "keyVaultAdminRoleAssignments",
        "count": "[length(parameters('keyVaultAdministrators'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultAdministrators')[copyIndex()], variables('roleDefinitions').keyVaultAdministrator)]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').keyVaultAdministrator]",
        "principalId": "[parameters('keyVaultAdministrators')[copyIndex()]]",
        "principalType": "User"
      },
      "dependsOn": [
        "keyVault"
      ]
    },
    "keyVaultSecretsUserRoleAssignments": {
      "copy": {
        "name": "keyVaultSecretsUserRoleAssignments",
        "count": "[length(parameters('keyVaultSecretsUsers'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultSecretsUsers')[copyIndex()], variables('roleDefinitions').keyVaultSecretsUser)]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').keyVaultSecretsUser]",
        "principalId": "[parameters('keyVaultSecretsUsers')[copyIndex()]]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "keyVault"
      ]
    },
    "keyVaultCertificateUserRoleAssignments": {
      "copy": {
        "name": "keyVaultCertificateUserRoleAssignments",
        "count": "[length(parameters('keyVaultCertificateUsers'))]"
      },
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('keyVaultCertificateUsers')[copyIndex()], variables('roleDefinitions').keyVaultCertificateUser)]",
      "properties": {
        "roleDefinitionId": "[variables('roleDefinitions').keyVaultCertificateUser]",
        "principalId": "[parameters('keyVaultCertificateUsers')[copyIndex()]]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "keyVault"
      ]
    },
    "keyVaultDiagnostics": {
      "condition": "[and(parameters('enableDiagnostics'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
      "name": "[format('{0}-diagnostics', parameters('keyVaultName'))]",
      "properties": {
        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
        "logs": [
          {
            "categoryGroup": "allLogs",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ]
      },
      "dependsOn": [
        "keyVault"
      ]
    },
    "telemetryDeployment": {
      "condition": "[parameters('enableTelemetry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    }
  },
  "outputs": {
    "keyVaultId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the Key Vault"
      },
      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Key Vault"
      },
      "value": "[parameters('keyVaultName')]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "The URI of the Key Vault"
      },
      "value": "[reference('keyVault').vaultUri]"
    },
    "keyVaultConfig": {
      "type": "object",
      "metadata": {
        "description": "The Key Vault configuration"
      },
      "value": {
        "id": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
        "name": "[parameters('keyVaultName')]",
        "uri": "[reference('keyVault').vaultUri]",
        "sku": "[reference('keyVault').sku.name]",
        "enableSoftDelete": "[reference('keyVault').enableSoftDelete]",
        "softDeleteRetentionInDays": "[reference('keyVault').softDeleteRetentionInDays]",
        "enablePurgeProtection": "[reference('keyVault').enablePurgeProtection]",
        "enableRbacAuthorization": "[reference('keyVault').enableRbacAuthorization]",
        "networkAcls": "[reference('keyVault').networkAcls]",
        "publicNetworkAccess": "[reference('keyVault').publicNetworkAccess]"
      }
    },
    "roleAssignments": {
      "type": "object",
      "metadata": {
        "description": "Role assignment information"
      },
      "value": {
        "administratorsCount": "[length(parameters('keyVaultAdministrators'))]",
        "secretsUsersCount": "[length(parameters('keyVaultSecretsUsers'))]",
        "certificateUsersCount": "[length(parameters('keyVaultCertificateUsers'))]",
        "roleDefinitions": "[variables('roleDefinitions')]"
      }
    }
  }
}