{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "6924630922910097285"
    }
  },
  "definitions": {
    "TagConfiguration": {
      "type": "object",
      "properties": {
        "Environment": {
          "type": "string",
          "metadata": {
            "description": "Environment tag"
          }
        },
        "Workload": {
          "type": "string",
          "metadata": {
            "description": "Workload tag"
          }
        },
        "ManagedBy": {
          "type": "string",
          "metadata": {
            "description": "Managed by tag"
          }
        },
        "CostCenter": {
          "type": "string",
          "metadata": {
            "description": "Cost center tag"
          }
        },
        "Owner": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Owner tag"
          }
        },
        "Project": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Project tag"
          }
        },
        "DeploymentDate": {
          "type": "string",
          "nullable": true,
          "metadata": {
            "description": "Deployment date tag"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "../shared/parameter-schemas.bicep"
        }
      }
    }
  },
  "parameters": {
    "managedIdentityBaseName": {
      "type": "string",
      "metadata": {
        "description": "The base name for managed identities"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The Azure region for deployment"
      }
    },
    "tags": {
      "$ref": "#/definitions/TagConfiguration",
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "userAssignedIdentities": {
      "type": "array",
      "defaultValue": [
        {
          "name": "application-services",
          "description": "Managed identity for application services",
          "roleAssignments": []
        },
        {
          "name": "key-vault-access",
          "description": "Managed identity for Key Vault access",
          "roleAssignments": []
        },
        {
          "name": "storage-access",
          "description": "Managed identity for storage account access",
          "roleAssignments": []
        },
        {
          "name": "sql-access",
          "description": "Managed identity for SQL database access",
          "roleAssignments": []
        }
      ],
      "metadata": {
        "description": "List of user-assigned managed identities to create"
      }
    },
    "enableDiagnostics": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable diagnostic settings for managed identities"
      }
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Log Analytics workspace ID for diagnostic settings"
      }
    },
    "enableTelemetry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable telemetry for the module"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "identityNames",
        "count": "[length(parameters('userAssignedIdentities'))]",
        "input": "[format('{0}-{1}-mi', parameters('managedIdentityBaseName'), parameters('userAssignedIdentities')[copyIndex('identityNames')].name)]"
      }
    ],
    "commonRoleDefinitions": {
      "storageBlobDataContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
      "storageBlobDataReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
      "storageAccountContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
      "keyVaultSecretsUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4633458b-17de-408a-b874-0445c86b69e6')]",
      "keyVaultCertificateUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'db79e9a7-68ee-4b58-9aeb-b90e7c24fcba')]",
      "keyVaultCryptoUser": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '12338af0-0e69-4776-bea7-57ae8d297424')]",
      "sqlDbContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '9b7fa17d-e63e-47b0-bb0a-15c516ac86ec')]",
      "monitoringContributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '749f88d5-cbae-40b8-bcfc-e573ddc772fa')]",
      "monitoringReader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
      "contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
      "reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
    }
  },
  "resources": {
    "userAssignedManagedIdentities": {
      "copy": {
        "name": "userAssignedManagedIdentities",
        "count": "[length(parameters('userAssignedIdentities'))]"
      },
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('identityNames')[copyIndex()]]",
      "location": "[parameters('location')]",
      "tags": "[union(parameters('tags'), createObject('Purpose', parameters('userAssignedIdentities')[copyIndex()].description, 'IdentityType', 'UserAssigned'))]"
    },
    "managedIdentityRoleAssignments": {
      "copy": {
        "name": "managedIdentityRoleAssignments",
        "count": "[length(parameters('userAssignedIdentities'))]"
      },
      "condition": "[not(empty(parameters('userAssignedIdentities')[copyIndex()].roleAssignments))]",
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()]), parameters('userAssignedIdentities')[copyIndex()].name, 'role-assignment')]",
      "properties": {
        "roleDefinitionId": "[variables('commonRoleDefinitions')[parameters('userAssignedIdentities')[copyIndex()].roleAssignments[0].role]]",
        "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[format('userAssignedManagedIdentities[{0}]', copyIndex())]",
        "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
      ]
    },
    "managedIdentityDiagnostics": {
      "copy": {
        "name": "managedIdentityDiagnostics",
        "count": "[length(parameters('userAssignedIdentities'))]"
      },
      "condition": "[and(parameters('enableDiagnostics'), not(empty(parameters('logAnalyticsWorkspaceId'))))]",
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.ManagedIdentity/userAssignedIdentities/{0}', variables('identityNames')[copyIndex()])]",
      "name": "[format('{0}-diagnostics', variables('identityNames')[copyIndex()])]",
      "properties": {
        "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
        "logs": [
          {
            "categoryGroup": "audit",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ]
      },
      "dependsOn": [
        "[format('userAssignedManagedIdentities[{0}]', copyIndex())]"
      ]
    },
    "telemetryDeployment": {
      "condition": "[parameters('enableTelemetry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('pid-47ed15a6-730a-4827-bcb4-0fd963ffbd82-{0}', uniqueString(deployment().name, parameters('location')))]",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": []
        }
      }
    }
  },
  "outputs": {
    "managedIdentityIds": {
      "type": "array",
      "metadata": {
        "description": "Array of user-assigned managed identity resource IDs"
      },
      "copy": {
        "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
        "input": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]])]"
      }
    },
    "managedIdentityNames": {
      "type": "array",
      "metadata": {
        "description": "Array of user-assigned managed identity names"
      },
      "copy": {
        "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
        "input": "[variables('identityNames')[range(0, length(parameters('userAssignedIdentities')))[copyIndex()]]]"
      }
    },
    "managedIdentityPrincipalIds": {
      "type": "array",
      "metadata": {
        "description": "Array of user-assigned managed identity principal IDs"
      },
      "copy": {
        "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
        "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).principalId]"
      }
    },
    "managedIdentityClientIds": {
      "type": "array",
      "metadata": {
        "description": "Array of user-assigned managed identity client IDs"
      },
      "copy": {
        "count": "[length(range(0, length(parameters('userAssignedIdentities'))))]",
        "input": "[reference(format('userAssignedManagedIdentities[{0}]', range(0, length(parameters('userAssignedIdentities')))[copyIndex()])).clientId]"
      }
    },
    "managedIdentityConfigs": {
      "type": "array",
      "metadata": {
        "description": "Managed identity configuration details"
      },
      "copy": {
        "count": "[length(parameters('userAssignedIdentities'))]",
        "input": {
          "name": "[variables('identityNames')[copyIndex()]]",
          "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[copyIndex()])]",
          "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).principalId]",
          "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', copyIndex())).clientId]",
          "purpose": "[parameters('userAssignedIdentities')[copyIndex()].description]",
          "type": "UserAssigned"
        }
      }
    },
    "managedIdentityLookup": {
      "type": "object",
      "metadata": {
        "description": "Managed identity lookup object for easy reference"
      },
      "value": {
        "applicationServices": {
          "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[0])]",
          "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).principalId]",
          "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 0)).clientId]"
        },
        "keyVaultAccess": {
          "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[1])]",
          "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).principalId]",
          "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 1)).clientId]"
        },
        "storageAccess": {
          "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[2])]",
          "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).principalId]",
          "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 2)).clientId]"
        },
        "sqlAccess": {
          "id": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityNames')[3])]",
          "principalId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).principalId]",
          "clientId": "[reference(format('userAssignedManagedIdentities[{0}]', 3)).clientId]"
        }
      }
    },
    "roleDefinitions": {
      "type": "object",
      "metadata": {
        "description": "Common role definitions for reference"
      },
      "value": "[variables('commonRoleDefinitions')]"
    }
  }
}